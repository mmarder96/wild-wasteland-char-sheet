<!--

$$\   $$\ $$$$$$\ $$$$$$$\  $$$$$$$\  $$$$$$$$\ $$\   $$\       $$$$$$$$\ $$\        $$$$$$\   $$$$$$\   $$$$$$\
$$ |  $$ |\_$$  _|$$  __$$\ $$  __$$\ $$  _____|$$$\  $$ |      $$  _____|$$ |      $$  __$$\ $$  __$$\ $$  __$$\
$$ |  $$ |  $$ |  $$ |  $$ |$$ |  $$ |$$ |      $$$$\ $$ |      $$ |      $$ |      $$ /  $$ |$$ /  \__|$$ /  \__|
$$$$$$$$ |  $$ |  $$ |  $$ |$$ |  $$ |$$$$$\    $$ $$\$$ |      $$$$$\    $$ |      $$$$$$$$ |$$ |$$$$\ \$$$$$$\
$$  __$$ |  $$ |  $$ |  $$ |$$ |  $$ |$$  __|   $$ \$$$$ |      $$  __|   $$ |      $$  __$$ |$$ |\_$$ | \____$$\
$$ |  $$ |  $$ |  $$ |  $$ |$$ |  $$ |$$ |      $$ |\$$$ |      $$ |      $$ |      $$ |  $$ |$$ |  $$ |$$\   $$ |
$$ |  $$ |$$$$$$\ $$$$$$$  |$$$$$$$  |$$$$$$$$\ $$ | \$$ |      $$ |      $$$$$$$$\ $$ |  $$ |\$$$$$$  |\$$$$$$  |
\__|  \__|\______|\_______/ \_______/ \________|\__|  \__|      \__|      \________|\__|  \__| \______/  \______/

-->

<input type="hidden" class="monster_confirm_flag" name="attr_monster_confirm_flag">
<input type="hidden" class="mancer_confirm_flag" name="attr_mancer_confirm_flag">

<div class="licensecontainer compendium-drop-target monsters"> <!-- licensecontainer div open -->

  <input type="hidden" class="npc_toggle" name="attr_npc" value="0">
  <input type="hidden" class="npcspellcastingflag" name="attr_npcspellcastingflag">
  <input type="hidden" class="toggleflag" name="attr_rtype" value ="@advantagetoggle">
  <div class="advantagetoggle">
    <input type="radio" class="toggle-left" name="attr_advantagetoggle" value="{{query=1}} {{advantage=1}} {{r2=[[@{d20}"><span data-i18n="adv-u">ADVANTAGE</span>
    <input type="radio" class="toggle-center" name="attr_advantagetoggle" value="{{query=1}} {{normal=1}} {{r2=[[0d20" checked="checked"><span data-i18n="norm-u">NORMAL</span>
    <input type="radio" class="toggle-right" name="attr_advantagetoggle" value="{{query=1}} {{disadvantage=1}} {{r2=[[@{d20}"><span data-i18n="disadv-u">DISADVANTAGE</span>
  </div>
  <input type="hidden" class="toggleflag" name="attr_wtype" value="@whispertoggle">
  <div class="advantagetoggle whispertoggle">
    <input type="radio" class="toggle-left" name="attr_whispertoggle" value="" checked="checked"><span data-i18n="public:-u">PUBLIC</span>
    <input type="radio" class="toggle-right" name="attr_whispertoggle" value="/w gm "><span data-i18n="to-gm:-u">TO <span class="togm">GM</span></span>
  </div>

  <!--

  $$\   $$\ $$$$$$$\   $$$$$$\         $$$$$$\   $$$$$$\  $$\   $$\ $$$$$$$$\  $$$$$$\  $$$$$$\ $$\   $$\ $$$$$$$$\ $$$$$$$\
  $$$\  $$ |$$  __$$\ $$  __$$\       $$  __$$\ $$  __$$\ $$$\  $$ |\__$$  __|$$  __$$\ \_$$  _|$$$\  $$ |$$  _____|$$  __$$\
  $$$$\ $$ |$$ |  $$ |$$ /  \__|      $$ /  \__|$$ /  $$ |$$$$\ $$ |   $$ |   $$ /  $$ |  $$ |  $$$$\ $$ |$$ |      $$ |  $$ |
  $$ $$\$$ |$$$$$$$  |$$ |            $$ |      $$ |  $$ |$$ $$\$$ |   $$ |   $$$$$$$$ |  $$ |  $$ $$\$$ |$$$$$\    $$$$$$$  |
  $$ \$$$$ |$$  ____/ $$ |            $$ |      $$ |  $$ |$$ \$$$$ |   $$ |   $$  __$$ |  $$ |  $$ \$$$$ |$$  __|   $$  __$$<
  $$ |\$$$ |$$ |      $$ |  $$\       $$ |  $$\ $$ |  $$ |$$ |\$$$ |   $$ |   $$ |  $$ |  $$ |  $$ |\$$$ |$$ |      $$ |  $$ |
  $$ | \$$ |$$ |      \$$$$$$  |      \$$$$$$  | $$$$$$  |$$ | \$$ |   $$ |   $$ |  $$ |$$$$$$\ $$ | \$$ |$$$$$$$$\ $$ |  $$ |
  \__|  \__|\__|       \______/        \______/  \______/ \__|  \__|   \__|   \__|  \__|\______|\__|  \__|\________|\__|  \__|

  -->

  <div class="container npc">
    <input class="npc_options-flag" type="checkbox" name="attr_npc_options-flag" checked="checked"><span>y</span>
    <div class="npc_options">
      <div class="row title">
        <span data-i18n="npc-options-u">NPC OPTIONS</span>
      </div>
      <div class="row">
          <span data-i18n="name-u">NAME</span>
          <input type="text" name="attr_npc_name">
      </div>
      <div class="row">
          <span data-i18n="npc-type-u">NPC TYPE</span>
          <input type="text" name="attr_npc_type" placeholder="Medium fiend, any evil alignment" data-i18n-placeholder="npc-type-place">
      </div>
      <div class="row">
          <span data-i18n="hit-points-u">HIT POINTS</span>
          <input class="num" type="text" name="attr_hp_max" placeholder="82">
      </div>
      <div class="row">
          <span data-i18n="damage-threshold-u">DAMAGE THRESHOLD</span>
          <input class="num" type="text" name="attr_npc_ac" placeholder="10">
          <span data-i18n="type-u">TYPE</span>
          <input type="text" name="attr_npc_actype" placeholder="light armor" data-i18n-placeholder="npc-armor-place" value="">
      </div>
      <div class="row">
          <span data-i18n="defense-u">DEFENSE</span>
          <input type="text" name="attr_npc_defense" placeholder="10" data-i18n-placeholder="npc-defense-place">
      </div>
      <div class="row">
          <span data-i18n="speed-u">SPEED</span>
          <input type="text" name="attr_npc_speed" placeholder="30 ft., fly 60ft." data-i18n-placeholder="npc-speed-place">
      </div>
      <div class="spacer"></div>
      <div class="row">
          <span data-i18n="attributes-u">ATTRIBUTES</span>
      </div>
      <div class="row">
        <span data-i18n="str-u">STR</span>
        <input class="num" type="text" name="attr_strength_base" value="10">
        <span data-i18n="per-u">PER</span>
        <input class="num" type="text" name="attr_perception_base" value="10">
        <span data-i18n="end-u">END</span>
        <input class="num" type="text" name="attr_endurance_base" value="10">
        <span data-i18n="cha-u">CHA</span>
        <input class="num" type="text" name="attr_charisma_base" value="10">
        <span data-i18n="int-u">INT</span>
        <input class="num" type="text" name="attr_intelligence_base" value="10">
        <span data-i18n="agl-u">AGL</span>
        <input class="num" type="text" name="attr_agility_base" value="10">
        <span data-i18n="luk-u">LUK</span>
        <input class="num" type="text" name="attr_luck_base" value="10">
      </div>
      <div class="spacer"></div>
      <div class="row">
          <span data-i18n="saves-u">SAVES</span>
      </div>
      <div class="row">
        <span data-i18n="str-u">STR</span>
        <input class="num" type="text" name="attr_npc_str_save_base" placeholder="0">
        <span data-i18n="per-u">PER</span>
        <input class="num" type="text" name="attr_npc_per_save_base" placeholder="0">
        <span data-i18n="end-u">END</span>
        <input class="num" type="text" name="attr_npc_end_save_base" placeholder="0">
        <span data-i18n="cha-u">CHA</span>
        <input class="num" type="text" name="attr_npc_cha_save_base" placeholder="0">
        <span data-i18n="int-u">INT</span>
        <input class="num" type="text" name="attr_npc_int_save_base" placeholder="0">
        <span data-i18n="agl-u">AGL</span>
        <input class="num" type="text" name="attr_npc_agl_save_base" placeholder="0">
        <span data-i18n="luk-u">LUK</span>
        <input class="num" type="text" name="attr_npc_luk_save_base" placeholder="0">
        <input type="hidden" name="attr_npc_str_save" value="@{strength_mod}">
        <input type="hidden" name="attr_npc_per_save" value="@{perception_mod}">
        <input type="hidden" name="attr_npc_end_save" value="@{endurance_mod}">
        <input type="hidden" name="attr_npc_cha_save" value="@{charisma_mod}">
        <input type="hidden" name="attr_npc_int_save" value="@{intelligence_mod}">
        <input type="hidden" name="attr_npc_agl_save" value="@{agility_mod}">
        <input type="hidden" name="attr_npc_luk_save" value="@{luck_mod}">
      </div>
      <div class="spacer"></div>
      <div class="row">
          <span data-i18n="skills-u">SKILLS</span>
      </div>
      <div class="row skills-list" data-i18n-list="skills-list">
        <div class="col">
          <div class="row" data-i18n-list-item="barter">
              <span data-i18n="barter-u">BARTER</span>
              <input class="num" type="text" name="attr_npc_barter_base" placeholder="0">
          </div>
          <div class="row" data-i18n-list-item="energy_weapons">
              <span data-i18n="energy_weapons-u">ENERGY WEAPONS</span>
              <input class="num" type="text" name="attr_npc_energy_weapons_base" placeholder="0">
          </div>
          <div class="row" data-i18n-list-item="explosives">
              <span data-i18n="explosives-u">EXPLOSIVES</span>
              <input class="num" type="text" name="attr_npc_explosives_base" placeholder="0">
          </div>
          <div class="row" data-i18n-list-item="guns">
              <span data-i18n="explosives-u">GUNS</span>
              <input class="num" type="text" name="attr_npc_explosives_base" placeholder="0">
          </div>
          <div class="row" data-i18n-list-item="lockpick">
              <span data-i18n="lockpick-u">LOCKPICK</span>
              <input class="num" type="text" name="attr_npc_lockpick_base" placeholder="0">
          </div>
          <div class="row" data-i18n-list-item="medicine">
              <span data-i18n="medicine-u">MEDICINE</span>
              <input class="num" type="text" name="attr_npc_medicine_base" placeholder="0">
          </div>
          <div class="row" data-i18n-list-item="melee_weapons">
              <span data-i18n="melee_weapons-u">MELEE WEAPONS</span>
              <input class="num" type="text" name="attr_npc_melee_weapons_base" placeholder="0">
          </div>
          <div class="row" data-i18n-list-item="repair">
              <span data-i18n="repair-u">REPAIR</span>
              <input class="num" type="text" name="attr_npc_repair_base" placeholder="0">
          </div>
          <div class="row" data-i18n-list-item="science">
              <span data-i18n="science-u">SCIENCE</span>
              <input class="num" type="text" name="attr_npc_science_base" placeholder="0">
          </div>
          <div class="row" data-i18n-list-item="sneak">
              <span data-i18n="sneak-u">SNEAK</span>
              <input class="num" type="text" name="attr_npc_sneak_base" placeholder="0">
          </div>
          <div class="row" data-i18n-list-item="speech">
              <span data-i18n="speech-u">SPEECH</span>
              <input class="num" type="text" name="attr_npc_speech_base" placeholder="0">
          </div>
          <div class="row" data-i18n-list-item="survival">
              <span data-i18n="survival-u">SURVIVAL</span>
              <input class="num" type="text" name="attr_npc_survival_base" placeholder="0">
          </div>
          <div class="row" data-i18n-list-item="unarmed">
              <span data-i18n="unarmed-u">UNARMED</span>
              <input class="num" type="text" name="attr_npc_unarmed_base" placeholder="0">
          </div>

        </div>
        <input type="hidden" name="attr_npc_barter" value="@{charisma_mod}">
        <input type="hidden" name="attr_npc_energy_weapons" value="@{perception_mod}">
        <input type="hidden" name="attr_npc_explosives" value="@{intelligence_mod}">
        <input type="hidden" name="attr_npc_guns" value="@{perception_mod}">
        <input type="hidden" name="attr_npc_lockpick" value="@{agility_mod}">
        <input type="hidden" name="attr_npc_medicine" value="@{intelligence_mod}">
        <input type="hidden" name="attr_npc_melee_weapons" value="@{strength_mod}">
        <input type="hidden" name="attr_npc_repair" value="@{intelligence_mod}">
        <input type="hidden" name="attr_npc_science" value="@{intelligence_mod}">
        <input type="hidden" name="attr_npc_sneak" value="@{agility_mod}">
        <input type="hidden" name="attr_npc_speech" value="@{charisma_mod}">
        <input type="hidden" name="attr_npc_survival" value="@{intelligence_mod}">
        <input type="hidden" name="attr_npc_unarmed" value="@{strength_mod}">
      </div>
      <div class="row">
        <span data-i18n="damage-vuln-u">DAMAGE VULNERABILITIES</span>
        <input type="text" name="attr_npc_vulnerabilities" placeholder="fire" data-i18n-placeholder="npc-dmg-vuln-place">
      </div>
      <div class="row">
        <span data-i18n="damage-res-u">DAMAGE RESISTANCES</span>
        <input type="text" name="attr_npc_resistances" placeholder="cold" data-i18n-placeholder="npc-dmg-res-place">
      </div>
      <div class="row">
        <span data-i18n="damage-imm-u">DAMAGE IMMUNITIES</span>
        <input type="text" name="attr_npc_immunities" placeholder="lighting, thunder" data-i18n-placeholder="npc-dmg-imm-place">
      </div>
      <div class="row">
        <span data-i18n="cond-imm-u">CONDITION IMMUNITIES</span>
        <input type="text" name="attr_npc_condition_immunities" placeholder="charmed" data-i18n-placeholder="npc-cond-imm-place">
      </div>
      <div class="row">
        <span data-i18n="senses-u">SENSES</span>
        <input type="text" name="attr_npc_senses" placeholder="darkvision 120ft., passive Perception 16" data-i18n-placeholder="npc-senses-place">
      </div>
      <div class="row">
        <span data-i18n="langs-u">LANGUAGES</span>
        <input type="text" name="attr_npc_languages" placeholder="Abyssal, Common, Infernal" value="—" data-i18n-placeholder="npc-langs-place">
      </div>
      <div class="row">
        <span data-i18n="challenge-u">CHALLENGE</span>
        <input class="num" type="text" name="attr_npc_challenge" placeholder="1">
        <span data-i18n="xp-u">XP</span>
        <input type="text" name="attr_npc_xp" placeholder="250">
      </div>
      <div class="row">
        <span data-i18n="token_size-u">TOKEN SIZE</span>
        <input class="text" name="attr_token_size" value="1" placeholder="1">
      </div>
      <div class="row">
        <input type="checkbox" name="attr_npcreactionsflag" value="1">
        <span data-i18n="has-reaction-u">HAS REACTIONS</span>
      </div>
      <div class="row">
        <span data-i18n="leg-actions:-u">LEGENDARY ACTIONS:</span>
        <input class="num" type="text" name="attr_npc_legendary_actions" value="0" placeholder="0">
      </div>
      <div class="row title">
        <span data-i18n="gen-opts-u">GENERAL OPTIONS</span>
      </div>
      <div class="row">
        <input type="checkbox" name="attr_npc" value="1">
        <span data-i18n="npc-u">NPC</span>
      </div>
      <div class="row">
        <input type="checkbox" name="attr_dtype" value="1">
        <span data-i18n="auto-dmg-roll-u">AUTO DAMAGE ROLL</span>
        <!-- <select class="dtype" name="attr_dtype">
          <option value="pick" data-i18n="never-dmg">Don't Auto Roll Damage</option>
          <option value="full" data-i18n="always-dmg">Auto Roll Damage & Crit</option>
        </select> -->
      </div>
      <div class="row">
        <span data-i18n="npc-name-in-rolls:-u">NPC NAME IN ROLLS:</span>
        <select name="attr_npc_name_flag">
          <option value="{{name=@{npc_name}}}" data-i18n="show">Show</option>
          <option value="0" data-i18n="hide">Hide</option>
        </select>
      </div>
      <div class="row">
        <input type="checkbox" name="attr_init_tiebreaker" value="@{agility}/100">
        <span data-i18n="add-agl-tiebreaker-u">ADD AGL TIEBREAKER TO INITIATIVE</span>
      </div>
    </div>
    <div class="display stat-block">
      <div class="row title red">
        <button type="roll" name="roll_npc_init" style="width: 100%;" value="@{wtype}&{template:simple} @{npc_name_flag} {{rname=^{init}}} {{mod=[[[[@{initiative_bonus}]][AGL]]]}} {{r1=[[@{d20}+[[@{initiative_bonus}]][AGL] &{tracker}]]}} {{normal=1}} {{type=Initiative}}">
          <span name="attr_npc_name"></span>
        </button>
      </div>
      <div class="row subtitle" style="margin-top: -5px;">
        <span class="italics" name="attr_npc_type"></span>
      </div>
      <div class="triangle"></div>
      <div class="row red" style="position:relative;">
        <span data-i18n="hp" class="bold">Hit Points</span>
        <span class="num3" name="attr_hp_max"></span>
        <button type="roll" name="roll_npc_init" style="position: absolute; right: 5px; height: 30px; width: 20px;"
          value="@{wtype}&{template:simple} @{npc_name_flag} {{rname=^{init}}} {{mod=[[[[@{initiative_bonus}]][AGL]]]}} {{r1=[[@{d20}+[[@{initiative_bonus}]][AGL] &{tracker}]]}} {{normal=1}} {{type=Initiative}}">
          <span class="npc-init-die">t</span>
          <span style="display: block;">INIT</span>
        </button>
      </div>
      <div class="row red">
        <span data-i18n="dt" class="bold">Damage Threshold</span>
        <span class="num" name="attr_npc_ac"></span>
        <input class="actype" type="hidden" name="attr_npc_actype" value="">
        <span class="parens" name="attr_npc_actype"></span>
      </div>
      <div class="row red">
        <span data-i18n="defense" class="bold">Defense</span>
        <span name="attr_npc_defense"></span>
      </div>
      <div class="row red">
        <span data-i18n="speed" class="bold">Speed</span>
        <span name="attr_npc_speed"></span>
      </div>
      <div class="triangle"></div>
      <div class="row red">
        <div class="attr-container">
          <button type="roll" name="roll_npc_str"
            value="@{wtype}&{template:simple} @{npc_name_flag} {{rname=^{strength}}} {{mod=[[[[@{strength_mod}]][STR]]]}} {{r1=[[@{d20}+[[@{strength_mod}]][STR]]]}} @{rtype}+[[@{strength_mod}]][STR]]]}} {{type=Ability}}">
            <span class="bold" data-i18n="str-u">STR</span>
            <span name="attr_strength"></span>
            <input class="negativeflag" type="hidden" name="attr_npc_str_negative" value="0">
            <span class="npcattr" name="attr_strength_mod"></span>
          </button>
        </div>
        <div class="attr-container">
          <button type="roll" name="roll_npc_per"
            value="@{wtype}&{template:simple} @{npc_name_flag} {{rname=^{perception}}} {{mod=[[[[@{perception_mod}]][STR]]]}} {{r1=[[@{d20}+[[@{perception_mod}]][STR]]]}} @{rtype}+[[@{perception_mod}]][STR]]]}} {{type=Ability}}">
            <span class="bold" data-i18n="per-u">PER</span>
            <span name="attr_perception"></span>
            <input class="negativeflag" type="hidden" name="attr_npc_per_negative" value="0">
            <span class="npcattr" name="attr_perception_mod"></span>
          </button>
        </div>
        <div class="attr-container">
          <button type="roll" name="roll_npc_end"
            value="@{wtype}&{template:simple} @{npc_name_flag} {{rname=^{endurance}}} {{mod=[[[[@{endurance_mod}]][END]]]}} {{r1=[[@{d20}+[[@{endurance_mod}]][END]]]}} @{rtype}+[[@{endurance_mod}]][END]]]}} {{type=Ability}}">
            <span class="bold" data-i18n="end-u">END</span>
            <span name="attr_endurance"></span>
            <input class="negativeflag" type="hidden" name="attr_npc_end_negative" value="0">
            <span class="npcattr" name="attr_endurance_mod"></span>
          </button>
        </div>
        <div class="attr-container">
          <button type="roll" name="roll_npc_cha"
            value="@{wtype}&{template:simple} @{npc_name_flag} {{rname=^{charisma}}} {{mod=[[[[@{charisma_mod}]][CHA]]]}} {{r1=[[@{d20}+[[@{charisma_mod}]][CHA]]]}} @{rtype}+[[@{charisma_mod}]][CHA]]]}} {{type=Ability}}">
            <span class="bold" data-i18n="cha-u">CHA</span>
            <span name="attr_charisma"></span>
            <input class="negativeflag" type="hidden" name="attr_npc_cha_negative" value="0">
            <span class="npcattr" name="attr_charisma_mod"></span>
          </button>
        </div>
        <div class="attr-container">
          <button type="roll" name="roll_npc_int"
            value="@{wtype}&{template:simple} @{npc_name_flag} {{rname=^{intelligence}}} {{mod=[[[[@{intelligence_mod}]][INT]]]}} {{r1=[[@{d20}+[[@{intelligence_mod}]][INT]]]}} @{rtype}+[[@{intelligence_mod}]][INT]]]}} {{type=Ability}}">
            <span class="bold" data-i18n="int-u">INT</span>
            <span name="attr_intelligence"></span>
            <input class="negativeflag" type="hidden" name="attr_npc_int_negative" value="0">
            <span class="npcattr" name="attr_intelligence_mod"></span>
          </button>
        </div>
        <div class="attr-container">
          <button type="roll" name="roll_npc_agl"
            value="@{wtype}&{template:simple} @{npc_name_flag} {{rname=^{agility}}} {{mod=[[[[@{agility_mod}]][AGL]]]}} {{r1=[[@{d20}+[[@{agility_mod}]][AGL]]]}} @{rtype}+[[@{agility_mod}]][AGL]]]}} {{type=Ability}}">
            <span class="bold" data-i18n="agl-u">AGL</span>
            <span name="attr_agility"></span>
            <input class="negativeflag" type="hidden" name="attr_npc_agl_negative" value="0">
            <span class="npcattr" name="attr_agility_mod"></span>
          </button>
        </div>
        <div class="attr-container">
          <button type="roll" name="roll_npc_luk"
            value="@{wtype}&{template:simple} @{npc_name_flag} {{rname=^{luck}}} {{mod=[[[[@{luck_mod}]][LUK]]]}} {{r1=[[@{d20}+[[@{luck_mod}]][LUK]]]}} @{rtype}+[[@{luck_mod}]][LUK]]]}} {{type=Ability}}">
            <span class="bold" data-i18n="luk-u">LUK</span>
            <span name="attr_luck"></span>
            <input class="negativeflag" type="hidden" name="attr_npc_luk_negative" value="0">
            <span class="npcattr" name="attr_luck_mod"></span>
          </button>
        </div>
      </div>
      <div class="triangle"></div>
      <input class="flag" type="hidden" name="attr_npc_saving_flag" value="">
      <div class="row saving red">
        <span class="bold" data-i18n="saving-throw">Saving Throws</span>
        <input class="flag" type="hidden" name="attr_npc_str_save_flag" value="0">
        <button type="roll" name="roll_npc_str_save" value="@{wtype}&{template:simple} @{npc_name_flag} {{rname=^{strength-save}}} {{mod=[[[[@{npc_str_save}]][STR SAVE]]]}} {{r1=[[@{d20}+[[@{npc_str_save}]][STR SAVE]]]}} @{rtype}+[[@{npc_str_save}]][STR SAVE]]]}} {{type=Save}}">
          <span data-i18n="str">Str</span>
          <span class="stat" name="attr_npc_str_save"></span>
        </button>
        <input class="flag" type="hidden" name="attr_npc_per_save_flag" value="0">
        <button type="roll" name="roll_npc_per_save" value="@{wtype}&{template:simple} @{npc_name_flag} {{rname=^{perception-save}}} {{mod=[[[[@{npc_per_save}]][PER SAVE]]]}} {{r1=[[@{d20}+[[@{npc_per_save}]][PER SAVE]]]}} @{rtype}+[[@{npc_per_save}]][PER SAVE]]]}} {{type=Save}}">
          <span data-i18n="per">Per</span>
          <span class="stat" name="attr_npc_per_save"></span>
        </button>
        <input class="flag" type="hidden" name="attr_npc_end_save_flag" value="0">
        <button type="roll" name="roll_npc_end_save" value="@{wtype}&{template:simple} @{npc_name_flag} {{rname=^{endurance-save}}} {{mod=[[[[@{npc_end_save}]][END SAVE]]]}} {{r1=[[@{d20}+[[@{npc_end_save}]][END SAVE]]]}} @{rtype}+[[@{npc_end_save}]][END SAVE]]]}} {{type=Save}}">
          <span data-i18n="end">End</span>
          <span class="stat" name="attr_npc_end_save"></span>
        </button>
        <input class="flag" type="hidden" name="attr_npc_cha_save_flag" value="0">
        <button type="roll" name="roll_npc_cha_save" value="@{wtype}&{template:simple} @{npc_name_flag} {{rname=^{charisma-save}}} {{mod=[[[[@{npc_cha_save}]][CHA SAVE]]]}} {{r1=[[@{d20}+[[@{npc_cha_save}]][CHA SAVE]]]}} @{rtype}+[[@{npc_cha_save}]][CHA SAVE]]]}} {{type=Save}}">
          <span data-i18n="cha">Cha</span>
          <span class="stat" name="attr_npc_cha_save"></span>
        </button>
        <input class="flag" type="hidden" name="attr_npc_int_save_flag" value="0">
        <button type="roll" name="roll_npc_int_save" value="@{wtype}&{template:simple} @{npc_name_flag} {{rname=^{intelligence-save}}} {{mod=[[[[@{npc_int_save}]][INT SAVE]]]}} {{r1=[[@{d20}+[[@{npc_int_save}]][INT SAVE]]]}} @{rtype}+[[@{npc_int_save}]][INT SAVE]]]}} {{type=Save}}">
          <span data-i18n="int">Int</span>
          <span class="stat" name="attr_npc_int_save"></span>
        </button>
        <input class="flag" type="hidden" name="attr_npc_agl_save_flag" value="0">
        <button type="roll" name="roll_npc_agl_save" value="@{wtype}&{template:simple} @{npc_name_flag} {{rname=^{agility-save}}} {{mod=[[[[@{npc_agl_save}]][AGL SAVE]]]}} {{r1=[[@{d20}+[[@{npc_agl_save}]][AGL SAVE]]]}} @{rtype}+[[@{npc_agl_save}]][AGL SAVE]]]}} {{type=Save}}">
          <span data-i18n="agl">Agl</span>
          <span class="stat" name="attr_npc_agl_save"></span>
        </button>
        <input class="flag" type="hidden" name="attr_npc_luk_save_flag" value="0">
        <button type="roll" name="roll_npc_luk_save" value="@{wtype}&{template:simple} @{npc_name_flag} {{rname=^{luck-save}}} {{mod=[[[[@{npc_luk_save}]][LUK SAVE]]]}} {{r1=[[@{d20}+[[@{npc_luk_save}]][LUK SAVE]]]}} @{rtype}+[[@{npc_luk_save}]][LUK SAVE]]]}} {{type=Save}}">
          <span data-i18n="luk">Luk</span>
          <span class="stat" name="attr_npc_luk_save"></span>
        </button>
      </div>
      <input class="flag" type="hidden" name="attr_npc_skills_flag" value="">
      <div class="row skills skills-list red" data-i18n-list="skills-list">
        <span class="bold" data-i18n="skills">Skills</span>
        <span data-i18n-list-item="barter">
          <input class="flag" type="hidden" name="attr_npc_barter_flag" value="0">
          <button type="roll" name="roll_npc_barter" value="@{wtype}&{template:simple} @{npc_name_flag} {{rname=^{barter}}} {{mod=@{npc_barter}}} {{r1=[[@{d20}+@{npc_barter}]]}} @{rtype}+@{npc_barter}]]}} {{type=Skill}}">
            <span data-i18n="barter">Barter</span>
            <span class="stat" name="attr_npc_barter"></span>
          </button>
        </span>
        <span data-i18n-list-item="energy_weapons">
          <input class="flag" type="hidden" name="attr_npc_energy_weapons_flag" value="0">
          <button type="roll" name="roll_npc_energy_weapons" value="@{wtype}&{template:simple} @{npc_name_flag} {{rname=^{energy_weapons}}} {{mod=@{npc_energy_weapons}}} {{r1=[[@{d20}+@{npc_energy_weapons}]]}} @{rtype}+@{npc_energy_weapons}]]}} {{type=Skill}}">
            <span data-i18n="energy_weapons">Energy Weapons</span>
            <span class="stat" name="attr_npc_energy_weapons"></span>
          </button>
        </span>
        <span data-i18n-list-item="explosives">
          <input class="flag" type="hidden" name="attr_npc_explosives_flag" value="0">
          <button type="roll" name="roll_npc_explosives" value="@{wtype}&{template:simple} @{npc_name_flag} {{rname=^{explosives}}} {{mod=@{npc_explosives}}} {{r1=[[@{d20}+@{npc_explosives}]]}} @{rtype}+@{npc_explosives}]]}} {{type=Skill}}">
            <span data-i18n="explosives">Explosives</span>
            <span class="stat" name="attr_npc_explosives"></span>
          </button>
        </span>
        <span data-i18n-list-item="guns">
          <input class="flag" type="hidden" name="attr_npc_guns_flag" value="0">
          <button type="roll" name="roll_npc_guns" value="@{wtype}&{template:simple} @{npc_name_flag} {{rname=^{guns}}} {{mod=@{npc_guns}}} {{r1=[[@{d20}+@{npc_guns}]]}} @{rtype}+@{npc_guns}]]}} {{type=Skill}}">
            <span data-i18n="guns">Guns</span>
            <span class="stat" name="attr_npc_guns"></span>
          </button>
        </span>
        <span data-i18n-list-item="lockpick">
          <input class="flag" type="hidden" name="attr_npc_lockpick_flag" value="0">
          <button type="roll" name="roll_npc_lockpick" value="@{wtype}&{template:simple} @{npc_name_flag} {{rname=^{lockpick}}} {{mod=@{npc_lockpick}}} {{r1=[[@{d20}+@{npc_lockpick}]]}} @{rtype}+@{npc_lockpick}]]}} {{type=Skill}}">
            <span data-i18n="lockpick">Lockpick</span>
            <span class="stat" name="attr_npc_lockpick"></span>
          </button>
        </span>
        <span data-i18n-list-item="medicine">
          <input class="flag" type="hidden" name="attr_npc_medicine_flag" value="0">
          <button type="roll" name="roll_npc_medicine" value="@{wtype}&{template:simple} @{npc_name_flag} {{rname=^{medicine}}} {{mod=@{npc_medicine}}} {{r1=[[@{d20}+@{npc_medicine}]]}} @{rtype}+@{npc_medicine}]]}} {{type=Skill}}">
            <span data-i18n="medicine">Medicine</span>
            <span class="stat" name="attr_npc_medicine"></span>
          </button>
        </span>
        <span data-i18n-list-item="melee_weapons">
          <input class="flag" type="hidden" name="attr_npc_melee_weapons_flag" value="0">
          <button type="roll" name="roll_npc_melee_weapons" value="@{wtype}&{template:simple} @{npc_name_flag} {{rname=^{melee_weapons}}} {{mod=@{npc_melee_weapons}}} {{r1=[[@{d20}+@{npc_melee_weapons}]]}} @{rtype}+@{npc_melee_weapons}]]}} {{type=Skill}}">
            <span data-i18n="melee_weapons">Melee Weapons</span>
            <span class="stat" name="attr_npc_melee_weapons"></span>
          </button>
        </span>
        <span data-i18n-list-item="repair">
          <input class="flag" type="hidden" name="attr_npc_repair_flag" value="0">
          <button type="roll" name="roll_npc_repair" value="@{wtype}&{template:simple} @{npc_name_flag} {{rname=^{repair}}} {{mod=@{npc_repair}}} {{r1=[[@{d20}+@{npc_repair}]]}} @{rtype}+@{npc_repair}]]}} {{type=Skill}}">
            <span data-i18n="repair">Repair</span>
            <span class="stat" name="attr_npc_repair"></span>
          </button>
        </span>
        <span data-i18n-list-item="science">
          <input class="flag" type="hidden" name="attr_npc_science_flag" value="0">
          <button type="roll" name="roll_npc_science" value="@{wtype}&{template:simple} @{npc_name_flag} {{rname=^{science}}} {{mod=@{npc_science}}} {{r1=[[@{d20}+@{npc_science}]]}} @{rtype}+@{npc_science}]]}} {{type=Skill}}">
            <span data-i18n="science">Science</span>
            <span class="stat" name="attr_npc_science"></span>
          </button>
        </span>
        <span data-i18n-list-item="sneak">
          <input class="flag" type="hidden" name="attr_npc_sneak_flag" value="0">
          <button type="roll" name="roll_npc_sneak" value="@{wtype}&{template:simple} @{npc_name_flag} {{rname=^{sneak}}} {{mod=@{npc_sneak}}} {{r1=[[@{d20}+@{npc_sneak}]]}} @{rtype}+@{npc_sneak}]]}} {{type=Skill}}">
            <span data-i18n="sneak">Sneak</span>
            <span class="stat" name="attr_npc_sneak"></span>
          </button>
        </span>
        <span data-i18n-list-item="speech">
          <input class="flag" type="hidden" name="attr_npc_speech_flag" value="0">
          <button type="roll" name="roll_npc_speech" value="@{wtype}&{template:simple} @{npc_name_flag} {{rname=^{speech}}} {{mod=@{npc_speech}}} {{r1=[[@{d20}+@{npc_speech}]]}} @{rtype}+@{npc_speech}]]}} {{type=Skill}}">
            <span data-i18n="speech">Speech</span>
            <span class="stat" name="attr_npc_speech"></span>
          </button>
        </span>
        <span data-i18n-list-item="survival">
          <input class="flag" type="hidden" name="attr_npc_survival_flag" value="0">
          <button type="roll" name="roll_npc_survival" value="@{wtype}&{template:simple} @{npc_name_flag} {{rname=^{survival}}} {{mod=@{npc_survival}}} {{r1=[[@{d20}+@{npc_survival}]]}} @{rtype}+@{npc_survival}]]}} {{type=Skill}}">
            <span data-i18n="survival">Survival</span>
            <span class="stat" name="attr_npc_survival"></span>
          </button>
        </span>
        <span data-i18n-list-item="unarmed">
          <input class="flag" type="hidden" name="attr_npc_unarmed_flag" value="0">
          <button type="roll" name="roll_npc_unarmed" value="@{wtype}&{template:simple} @{npc_name_flag} {{rname=^{unarmed}}} {{mod=@{npc_unarmed}}} {{r1=[[@{d20}+@{npc_unarmed}]]}} @{rtype}+@{npc_unarmed}]]}} {{type=Skill}}">
            <span data-i18n="unarmed">Unarmed</span>
            <span class="stat" name="attr_npc_unarmed"></span>
          </button>
        </span>
      </div>
      <input class="flag" type="hidden" name="attr_npc_vulnerabilities">
      <div class="row status vulnerabilities red">
        <span class="bold" data-i18n="dmg-vuln">Damage Vulnerabilities</span>
        <span class="info" name="attr_npc_vulnerabilities"></span>
      </div>
      <input class="flag" type="hidden" name="attr_npc_resistances">
      <div class="row status resistances red">
        <span class="bold" data-i18n="dmg-res">Damage Resistances</span>
        <span class="info" name="attr_npc_resistances"></span>
      </div>
      <input class="flag" type="hidden" name="attr_npc_immunities">
      <div class="row status immunities red">
        <span class="bold" data-i18n="dmg-imm">Damage Immunities</span>
        <span class="info" name="attr_npc_immunities"></span>
      </div>
      <input class="flag" type="hidden" name="attr_npc_condition_immunities">
      <div class="row status condition_immunities red">
        <span class="bold" data-i18n="cond-imm">Condition Immunities</span>
        <span class="info" name="attr_npc_condition_immunities"></span>
      </div>
      <div class="row senses red">
        <span class="bold" data-i18n="senses">Senses</span>
        <span class="info" name="attr_npc_senses"></span>
      </div>
      <div class="row languages red">
        <span class="bold" data-i18n="langs">Languages</span>
        <span class="info languages" name="attr_npc_languages" value="—"></span>
      </div>
      <div class="row red">
        <span class="bold" data-i18n="challenge">Challenge</span>
        <span class="num" name="attr_npc_challenge"></span>
        <span class="parens xp" name="attr_npc_xp"></span>
      </div>
      <div class="triangle"></div>
      <div class="row traits">
        <fieldset class="repeating_npctrait">
          <div class="trait">
            <input type="text" name="attr_name" placeholder="False Appearance." data-i18n-placeholder="npc-trait-name-place">
            <textarea name="attr_desc" placeholder="If the dragon fails..." data-i18n-placeholder="npc-trait-desc-place"></textarea>
          </div>
        </fieldset>
      </div>
    </div>
    <div class="actions_container"></div>
    <input class="dflag" type="hidden" name="attr_dflag" value="pick">
    <div class="row actions">
      <div class="row actiontitle" style="position: relative;">
        <span class="title red" data-i18n="actions">Actions</span>
      </div>
      <fieldset class="repeating_npcaction">
        <div class="action">
          <input class="npc_options-flag" type="checkbox" name="attr_npc_options-flag" checked="checked"><span>y</span>
          <div class="npc_options">
            <div class="row">
              <span data-i18n="name:-u">NAME:</span>
              <input type="text" name="attr_name">
            </div>
            <div class="row">
              <input type="checkbox" name="attr_attack_flag" value="on">
              <span data-i18n="attack-u">ATTACK</span>
            </div>
            <input type="hidden" class="attack_options" name="attr_attack_flag" value="0">
            <div class="row attack_option">
              <span data-i18n="type:-u">TYPE:</span>
              <select name="attr_attack_type">
                <option value="Melee" data-i18n="melee">Melee</option>
                <option value="Ranged" data-i18n="ranged">Ranged</option>
              </select>
              <span style="margin-left: 15px;" data-i18n="range-reach:-u">RANGE/REACH:</span>
              <input type="text" name="attr_attack_range" placeholder="5 ft." style="width: 100px;" data-i18n-placeholder="range-reach-place">
            </div>
            <div class="row attack_option">
              <span data-i18n="to-hit:-u">TO HIT:</span>
              <input type="text" name="attr_attack_tohit" value="0" placeholder="5" style="width: 30px;">
              <span style="margin-left: 15px;" data-i18n="target:-u">TARGET:</span>
              <input type="text" name="attr_attack_target" placeholder="One target" style="width: 100px;" data-i18n-placeholder="to-hit-place">
            </div>
            <input type="hidden" name="attr_damage_flag">
            <div class="row attack_option">
              <span data-i18n="on-hit:-u">ON HIT:</span>
              <input type="text" name="attr_attack_damage" placeholder="1d10" style="width: 65px;">
              <input type="text" name="attr_attack_damagetype" placeholder="slashing" style="width: 100px;" data-i18n-placeholder="on-hit-place">
              <input type="hidden" name="attr_attack_crit">
            </div>
            <div class="row attack_option">
              <span data-i18n="on-hit2:-u">ON HIT 2:</span>
              <input type="text" name="attr_attack_damage2" placeholder="2d6+5" style="width: 65px;">
              <input type="text" name="attr_attack_damagetype2" placeholder="fire" style="width: 100px;" data-i18n-placeholder="on-hit-2-place">
              <input type="hidden" name="attr_attack_crit2">
            </div>
            <div class="row attack_option">
              <span style="width: 65px;" data-i18n="desc:-u">DESCRIPTION:</span>
              <select name="attr_show_desc">
                <option value="@{description}" data-i18n="show">Show</option>
                <option value=" " data-i18n="hide">Hide</option>
              </select>
            </div>
            <div class="row">
              <textarea name="attr_description"></textarea>
            </div>
          </div>
          <div class="display">
            <button class="pick" type="roll" name="roll_npc_action" value="@{rollbase}">
              <div class="row wide">
                <span class="bold wide" name="attr_name"></span>
              </div>
              <input class="attack_options" type="hidden" name="attr_attack_flag">
              <div class="row attack attack_option">
                <span class="italics" name="attr_attack_type"></span><span class="italics"> Weapon Attack: </span><span name="attr_attack_tohitrange"></span>
              </div>
              <div class="row attack attack_option">
                <span class="italics" style="font-size: 13px; font-weight: normal; vertical-align: middle;" data-i18n="hit:">Hit: </span><span name="attr_attack_onhit" style="vertical-align: middle;"></span>
              </div>
              <span class="description" name="attr_description"></span>
            </button>
          </div>
          <input type="hidden" name="attr_rollbase">
          <button type="roll" style="display: none;" name="roll_npc_dmg"
            value="@{wtype}&{template:npcdmg} @{damage_flag} {{dmg1=[[@{attack_damage}+0]]}} {{dmg1type=@{attack_damagetype}}} {{dmg2=[[@{attack_damage2}+0]]}} {{dmg2type=@{attack_damagetype2}}}"></button>
          <button type="roll" style="display: none;" name="roll_npc_crit"
            value="@{wtype}&{template:npcdmg} @{damage_flag} {{crit=1}} {{dmg1=[[@{attack_damage}+0]]}} {{dmg1type=@{attack_damagetype}}} {{dmg2=[[@{attack_damage2}+0]]}} {{dmg2type=@{attack_damagetype2}}} {{crit1=[[@{attack_crit}+0]]}} {{crit2=[[@{attack_crit2}+0]]}}"></button>
        </div>
      </fieldset>
    </div>
    <input class="reaction_flag" type="hidden" name="attr_npcreactionsflag">
    <div class="row actions reaction">
      <div class="row actiontitle">
        <span class="title red" data-i18n="reactions">Reactions</span>
      </div>
      <fieldset class="repeating_npcreaction">
        <div class="trait">
          <input type="text" name="attr_name" placeholder="—">
          <textarea name="attr_desc" placeholder="—"></textarea>
        </div>
      </fieldset>
    </div>
    <input class="legendary_flag" type="hidden" name="attr_npc_legendary_actions" value="0">
    <div class="row actions legendary">
      <div class="row actiontitle">
        <span class="title red" data-i18n="leg-actions">Legendary Actions</span>
      </div>
      <div class="row">
        <div class="legendaryactions" data-i18n="leg-actions-desc"><span name="attr_npc_legendary_actions_desc"></span></div>
      </div>
      <fieldset class="repeating_npcaction-l">
        <div class="action">
          <input class="npc_options-flag" type="checkbox" name="attr_npc_options-flag" checked="checked"><span>y</span>
          <div class="npc_options">
            <div class="row">
              <span data-i18n="name:-u">NAME:</span>
              <input type="text" name="attr_name">
            </div>
            <div class="row">
              <input type="checkbox" name="attr_attack_flag" value="on">
              <span data-i18n="attack-u">ATTACK</span>
            </div>
            <input type="hidden" class="attack_options" name="attr_attack_flag" value="0">
            <div class="row attack_option">
              <span data-i18n="type:-u">TYPE:</span>
              <select name="attr_attack_type">
                <option value="Melee" data-i18n="melee">Melee</option>
                <option value="Ranged" data-i18n="ranged">Ranged</option>
              </select>
              <span style="margin-left: 15px;" data-i18n="range-reach:-u">RANGE/REACH:</span>
              <input type="text" name="attr_attack_range" placeholder="—" style="width: 100px;">
            </div>
            <div class="row attack_option">
              <span data-i18n="to-hit:-u">TO HIT:</span>
              <input type="text" name="attr_attack_tohit" value="0" placeholder="0" style="width: 30px;">
              <span style="margin-left: 15px;" data-i18n="target:-u">TARGET:</span>
              <input type="text" name="attr_attack_target" placeholder="One target" style="width: 100px;" data-i18n-placeholder="to-hit-place">
            </div>
            <input type="hidden" name="attr_damage_flag">
            <div class="row attack_option">
              <span data-i18n="on-hit:-u">ON HIT:</span>
              <input type="text" name="attr_attack_damage" placeholder="0" style="width: 65px;">
              <input type="text" name="attr_attack_damagetype" placeholder="—" style="width: 100px;">
              <input type="hidden" name="attr_attack_crit">
            </div>
            <div class="row attack_option">
              <span data-i18n="on-hit2:-u">ON HIT 2:</span>
              <input type="text" name="attr_attack_damage2" placeholder="0" style="width: 65px;">
              <input type="text" name="attr_attack_damagetype2" placeholder="—" style="width: 100px;">
              <input type="hidden" name="attr_attack_crit2">
            </div>
            <div class="row attack_option">
              <span data-i18n="desc:-u">DESCRIPTION:</span>
              <select name="attr_show_desc">
                <option value="@{description}" data-i18n="show">Show</option>
                <option value=" " data-i18n="hide">Hide</option>
              </select>
            </div>
            <div class="row">
              <textarea name="attr_description"></textarea>
            </div>
          </div>
          <div class="display">
            <button class="pick" type="roll" name="roll_npc_action" value="@{rollbase}">
              <div class="row wide">
                <span class="bold wide" name="attr_name"></span>
              </div>
              <input class="attack_options" type="hidden" name="attr_attack_flag">
              <div class="row attack attack_option">
                <span class="italics" name="attr_attack_type"></span><span class="italics"> Weapon Attack: </span><span name="attr_attack_tohitrange"></span>
              </div>
              <div class="row attack attack_option">
                <span class="italics" style="font-size: 13px; font-weight: normal; vertical-align: middle;" data-i18n="hit:">Hit: </span><span name="attr_attack_onhit" style="vertical-align: middle;"></span>
              </div>
              <span class="description" name="attr_description"></span>
            </button>
          </div>
          <input type="hidden" name="attr_rollbase">
          <button type="roll" style="display: none;" name="roll_npc_dmg"
            value="@{wtype}&{template:npcdmg} @{damage_flag} {{dmg1=[[@{attack_damage}+0]]}} {{dmg1type=@{attack_damagetype}}} {{dmg2=[[@{attack_damage2}+0]]}} {{dmg2type=@{attack_damagetype2}}}"></button>
          <button type="roll" style="display: none;" name="roll_npc_crit"
            value="@{wtype}&{template:npcdmg} @{damage_flag} {{crit=1}} {{dmg1=[[@{attack_damage}+0]]}} {{dmg1type=@{attack_damagetype}}} {{dmg2=[[@{attack_damage2}+0]]}} {{dmg2type=@{attack_damagetype2}}} {{crit1=[[@{attack_crit}+0]]}} {{crit2=[[@{attack_crit2}+0]]}}"></button>
        </div>
      </fieldset>
    </div>
  </div>

  <!--

  $$$$$$$\   $$$$$$\         $$$$$$\   $$$$$$\  $$\   $$\ $$$$$$$$\  $$$$$$\  $$$$$$\ $$\   $$\ $$$$$$$$\ $$$$$$$\
  $$  __$$\ $$  __$$\       $$  __$$\ $$  __$$\ $$$\  $$ |\__$$  __|$$  __$$\ \_$$  _|$$$\  $$ |$$  _____|$$  __$$\
  $$ |  $$ |$$ /  \__|      $$ /  \__|$$ /  $$ |$$$$\ $$ |   $$ |   $$ /  $$ |  $$ |  $$$$\ $$ |$$ |      $$ |  $$ |
  $$$$$$$  |$$ |            $$ |      $$ |  $$ |$$ $$\$$ |   $$ |   $$$$$$$$ |  $$ |  $$ $$\$$ |$$$$$\    $$$$$$$  |
  $$  ____/ $$ |            $$ |      $$ |  $$ |$$ \$$$$ |   $$ |   $$  __$$ |  $$ |  $$ \$$$$ |$$  __|   $$  __$$<
  $$ |      $$ |  $$\       $$ |  $$\ $$ |  $$ |$$ |\$$$ |   $$ |   $$ |  $$ |  $$ |  $$ |\$$$ |$$ |      $$ |  $$ |
  $$ |      \$$$$$$  |      \$$$$$$  | $$$$$$  |$$ | \$$ |   $$ |   $$ |  $$ |$$$$$$\ $$ | \$$ |$$$$$$$$\ $$ |  $$ |
  \__|       \______/        \______/  \______/ \__|  \__|   \__|   \__|  \__|\______|\__|  \__|\________|\__|  \__|

  -->

  <div class="container pc">

    <!--
     _____          _____  ______    _______         ____    _____
    |  __ \  /\    / ____||  ____|  |__   __| /\    |  _ \  / ____|
    | |__) |/  \  | |  __ | |__        | |   /  \   | |_) || (___
    |  ___// /\ \ | | |_ ||  __|       | |  / /\ \  |  _ <  \___ \
    | |   / ____ \| |__| || |____      | | / ____ \ | |_) | ____) |
    |_|  /_/    \_\\_____||______|     |_|/_/    \_\|____/ |_____/
    -->

    <input class="tab-button core" type="radio" name="attr_tab" value="core" checked="checked"><span data-i18n="core-u">CORE</span>
    <input class="tab-button bio" type="radio" name="attr_tab" value="bio"><span data-i18n="bio-u">BIO</span>
    <input class="tab-button options" type="radio" name="attr_tab" value="options"><span style="font-family: pictos">y</span>

    <!--
      _____    ____    _____    ______
     / ____|  / __ \  |  __ \  |  ____|
    | |      | |  | | | |__) | | |__
    | |      | |  | | |  _  /  |  __|
    | |____  | |__| | | | \ \  | |____
     \_____|  \____/  |_|  \_\ |______|
    -->

    <div class="page core">
      <div class="header">
        <div class="name-container">
          <img src="https://raw.githubusercontent.com/mmarder96/wild-wasteland-char-sheet/dev/images/wild_wasteland_logo.png" style="padding-bottom: 5px; width: 250px" alt="Wild Wasteland Logo">
          <input type="text" name="attr_character_name" style="width: 100%;">
          <span class="label" data-i18n="char-name-u">CHARACTER NAME</span>
        </div>
        <div class="header-info sheet-display">
          <div class="top">
            <div class="hlabel-container">
              <input type="number" name="attr_base_level" class="sheet-no_events">
              <span class="label" data-i18n="lvl-u">LEVEL</span>
            </div>
            <div class="hlabel-container" style="position: relative;">
              <input type="number" name="attr_experience" step="1" min="0">
              <span class="label" data-i18n="exp-pts-u">EXPERIENCE POINTS</span>
            </div>
          </div>
          <div class="bottom">
            <div class="hlabel-container">
              <input type="text" name="attr_race">
              <span class="label" data-i18n="race-u">RACE</span>
            </div>
            <div class="hlabel-container">
              <input type="text" name="attr_alignment">
              <span class="label" data-i18n="alignment-u">ALIGNMENT</span>
            </div>
          </div>
        </div>
      </div>
      <div class="body">
        <div class="col col1">
          <div class="attributes-container">
            <div id="str-container" class="attr-container">
              <button type="roll" name="roll_strength"
                value="@{wtype}&{template:simple} {{rname=^{strength-u}}} {{mod=@{strength_mod}@{jack_bonus}}} {{r1=[[@{d20}+@{strength_mod}@{jack_attr}[STR]]]}} @{rtype}+@{strength_mod}@{jack_attr}[STR]]]}} @{charname_output}"
                data-i18n="strength-u">STRENGTH</button>
              <span class="attr" name="attr_strength_mod" title="@{strength_mod}">0</span>
              <div class="attr-mod">
                <input class="baseattr" type="text" name="attr_strength_base" title="@{strength}" value="10">
                <input type="hidden" name="attr_strength" value="10">
                <input class="attr-flag" type="hidden" name="attr_strength_flag" value="0">
                <span class="finalattr" name="attr_strength"></span>
              </div>
            </div>
            <div id="per-container" class="attr-container">
              <button type="roll" name="roll_perception"
                value="@{wtype}&{template:simple} {{rname=^{perception-u}}} {{mod=@{perception_mod}@{jack_bonus}}} {{r1=[[@{d20}+@{perception_mod}@{jack_attr}[PER]]]}} @{rtype}+@{perception_mod}@{jack_attr}[PER]]]}} @{charname_output}"
                data-i18n="perception-u">PERCEPTION</button>
              <span class="attr" name="attr_perception_mod" title="@{perception_mod}">0</span>
              <div class="attr-mod">
                <input class="baseattr" type="text" name="attr_perception_base" title="@{perception}" value="10">
                <input type="hidden" name="attr_perception" value="10">
                <input class="attr-flag" type="hidden" name="attr_perception_flag" value="0">
                <span class="finalattr" name="attr_perception"></span>
              </div>
            </div>
            <div id="end-container" class="attr-container">
              <button type="roll" name="roll_endurance"
                value="@{wtype}&{template:simple} {{rname=^{endurance-u}}} {{mod=@{endurance_mod}@{jack_bonus}}} {{r1=[[@{d20}+@{endurance_mod}@{jack_attr}[END]]]}} @{rtype}+@{endurance_mod}@{jack_attr}[END]]]}} @{charname_output}"
                data-i18n="endurance-u">ENDURANCE</button>
              <span class="attr" name="attr_endurance_mod" title="@{endurance_mod}">0</span>
              <div class="attr-mod">
                <input class="baseattr" type="text" name="attr_endurance_base" title="@{endurance}" value="10">
                <input type="hidden" name="attr_endurance" value="10">
                <input class="attr-flag" type="hidden" name="attr_endurance_flag" value="0">
                <span class="finalattr" name="attr_endurance"></span>
              </div>
            </div>
            <div id="cha-container" class="attr-container">
              <button type="roll" name="roll_charisma"
                value="@{wtype}&{template:simple} {{rname=^{charisma-u}}} {{mod=@{charisma_mod}@{jack_bonus}}} {{r1=[[@{d20}+@{charisma_mod}@{jack_attr}[CHA]]]}} @{rtype}+@{charisma_mod}@{jack_attr}[CHA]]]}} @{charname_output}"
                data-i18n="charisma-u">CHARISMA</button>
              <span class="attr" name="attr_charisma_mod" title="@{charisma_mod}">0</span>
              <div class="attr-mod">
                <input class="baseattr" type="text" name="attr_charisma_base" title="@{charisma}" value="10">
                <input type="hidden" name="attr_charisma" value="10">
                <input class="attr-flag" type="hidden" name="attr_charisma_flag" value="0">
                <span class="finalattr" name="attr_charisma"></span>
              </div>
            </div>
            <div id="int-container" class="attr-container">
              <button type="roll" name="roll_intelligence"
                value="@{wtype}&{template:simple} {{rname=^{intelligence-u}}} {{mod=@{intelligence_mod}@{jack_bonus}}} {{r1=[[@{d20}+@{intelligence_mod}@{jack_attr}[INT]]]}} @{rtype}+@{intelligence_mod}@{jack_attr}[INT]]]}} @{charname_output}"
                data-i18n="intelligence-u">INTELLIGENCE</button>
              <span class="attr" name="attr_intelligence_mod" title="@{intelligence_mod}">0</span>
              <div class="attr-mod">
                <input class="baseattr" type="text" name="attr_intelligence_base" title="@{intelligence}" value="10">
                <input type="hidden" name="attr_intelligence" value="10">
                <input class="attr-flag" type="hidden" name="attr_intelligence_flag" value="0">
                <span class="finalattr" name="attr_intelligence"></span>
              </div>
            </div>
            <div id="agl-container" class="attr-container">
              <button type="roll" name="roll_agility"
                value="@{wtype}&{template:simple} {{rname=^{agility-u}}} {{mod=@{agility_mod}@{jack_bonus}}} {{r1=[[@{d20}+@{agility_mod}@{jack_attr}[AGL]]]}} @{rtype}+@{agility_mod}@{jack_attr}[AGL]]]}} @{charname_output}"
                data-i18n="agility-u">AGILITY</button>
              <span class="attr" name="attr_agility_mod" title="@{agility_mod}">0</span>
              <div class="attr-mod">
                <input class="baseattr" type="text" name="attr_agility_base" title="@{agility}" value="10">
                <input type="hidden" name="attr_agility" value="10">
                <input class="attr-flag" type="hidden" name="attr_agility_flag" value="0">
                <span class="finalattr" name="attr_agility"></span>
              </div>
            </div>
            <div id="luk-container" class="attr-container">
              <button type="roll" name="roll_luck" value="@{wtype}&{template:simple} {{rname=^{luck-u}}} {{mod=@{luck_mod}@{jack_bonus}}} {{r1=[[@{d20}+@{luck_mod}@{jack_attr}[LUK]]]}} @{rtype}+@{luck_mod}@{jack_attr}[LUK]]]}} @{charname_output}"
                data-i18n="luck-u">LUCK</button>
              <span class="attr" name="attr_luck_mod" title="@{luck_mod}">0</span>
              <div class="attr-mod">
                <input class="baseattr" type="text" name="attr_luck_base" title="@{luck}" value="10">
                <input type="hidden" name="attr_luck" value="10">
                <input class="attr-flag" type="hidden" name="attr_luck_flag" value="0">
                <span class="finalattr" name="attr_luck"></span>
              </div>
            </div>
          </div>
          <div class="skills-saves-container">
            <div class="insp-prof-container">
              <div class="value">
                <input type="checkbox" name="attr_inspiration"><span></span>
              </div>
              <div class="label">
                <span data-i18n="inspiration-u">INSPIRATION</span>
              </div>
            </div>
            <div class="insp-prof-container">
              <div class="value">
                <span name="attr_passive_perception"></span>
              </div>
              <div class="label">
                <span data-i18n="pass-per-u">PASSIVE PERCEPTION</span>
              </div>
            </div>
            <div class="insp-prof-container">
              <div class="value">
                <span name="attr_critical_strike"></span>
              </div>
              <div class="label">
                <span data-i18n="crit-strike-u">CRITICAL STRIKE</span>
              </div>
            </div>
            <div class="insp-prof-container">
              <div class="value">
                <span name="attr_pb" title="@{pb}"></span>
              </div>
              <div class="label">
                <span data-i18n="tag-bonus-u">TAG SKILL BONUS</span>
              </div>
            </div>
            <div class="skills-container skills-list">
              <div data-i18n-list="skills-list">
                <div class="skill" data-i18n-list-item="barter">
                  <input type="checkbox" name="attr_barter_prof" title="@{barter_prof}" value="(@{pb})">
                  <span name="attr_barter_bonus" title="@{barter_bonus}">0</span>
                  <button type="roll" name="roll_barter"
                    value="@{wtype}&{template:simple} {{rname=^{barter-u}}} {{mod=@{barter_check_bonus}}} {{r1=[[@{d20}+@{barter_check_bonus}]]}} @{rtype}+@{barter_check_bonus}}]]}} {{global=@{global_skill_mod}}} @{charname_output}"
                    data-i18n="barter-core">Barter <span>[CHA]</span></button>
                </div>
                <div class="skill" data-i18n-list-item="energy_weapons">
                  <input type="checkbox" name="attr_energy_weapons_prof" title="@{energy_weapons_prof}" value="(@{pb})">
                  <span name='attr_energy_weapons_bonus' title='@{energy_weapons_bonus}'>0</span>
                  <button type='roll' name='roll_energy_weapons'
                    value='@{wtype}&{template:simple} {{rname=^{energy_weapons-u}}} {{mod=@{energy_weapons_check_bonus}}} {{r1=[[@{d20}+@{energy_weapons_check_bonus}]]}} @{rtype}+@{energy_weapons_check_bonus}]]}} {{global=@{global_skill_mod}}} @{charname_output}'
                    data-i18n='energy_weapons-core'>Energy Weapons <span>[PER]</span></button>
                </div>
                <div class="skill" data-i18n-list-item="explosives">
                  <input type="checkbox" name="attr_explosives_prof" title="@{explosives_prof}" value="(@{pb})">
                  <span name='attr_explosives_bonus' title='@{explosives_bonus}'>0</span>
                  <button type='roll' name='roll_explosives'
                    value='@{wtype}&{template:simple} {{rname=^{explosives-u}}} {{mod=@{explosives_check_bonus}}} {{r1=[[@{d20}+@{explosives_check_bonus}]]}} @{rtype}+@{explosives_check_bonus}]]}} {{global=@{global_skill_mod}}} @{charname_output}'
                    data-i18n='explosives-core'>Explosives <span>[INT]</span></button>
                </div>
                <div class="skill" data-i18n-list-item="guns">
                  <input type="checkbox" name="attr_guns_prof" title="@{guns_prof}" value="(@{pb})">
                  <span name='attr_guns_bonus' title='@{guns_bonus}'>0</span>
                  <button type='roll' name='roll_guns'
                    value='@{wtype}&{template:simple} {{rname=^{guns-u}}} {{mod=@{guns_check_bonus}}} {{r1=[[@{d20}+@{guns_check_bonus}]]}} @{rtype}+@{guns_check_bonus}]]}} {{global=@{global_skill_mod}}} @{charname_output}'
                    data-i18n='guns-core'>Guns <span>[PER]</span></button>
                </div>
                <div class="skill" data-i18n-list-item="lockpick">
                  <input type="checkbox" name="attr_lockpick_prof" title="@{lockpick_prof}" value="(@{pb})">
                  <span name='attr_lockpick_bonus' title='@{lockpick_bonus}'>0</span>
                  <button type='roll' name='roll_lockpick'
                    value='@{wtype}&{template:simple} {{rname=^{lockpick-u}}} {{mod=@{lockpick_check_bonus}}} {{r1=[[@{d20}+@{lockpick_check_bonus}]]}} @{rtype}+@{lockpick_check_bonus}]]}} {{global=@{global_skill_mod}}} @{charname_output}'
                    data-i18n='lockpick-core'>Lockpick <span>[AGL]</span></button>
                </div>
                <div class="skill" data-i18n-list-item="medicine">
                  <input type="checkbox" name="attr_medicine_prof" title="@{medicine_prof}" value="(@{pb})">
                  <span name='attr_medicine_bonus' title='@{medicine_bonus}'>0</span>
                  <button type='roll' name='roll_medicine'
                    value='@{wtype}&{template:simple} {{rname=^{medicine-u}}} {{mod=@{medicine_check_bonus}}} {{r1=[[@{d20}+@{medicine_check_bonus}]]}} @{rtype}+@{medicine_check_bonus}]]}} {{global=@{global_skill_mod}}} @{charname_output}'
                    data-i18n='medicine-core'>Medicine <span>[INT]</span></button>
                </div>
                <div class="skill" data-i18n-list-item="melee_weapons">
                  <input type="checkbox" name="attr_melee_weapons_prof" title="@{melee_weapons_prof}" value="(@{pb})">
                  <span name='attr_melee_weapons_bonus' title='@{melee_weapons_bonus}'>0</span>
                  <button type='roll' name='roll_melee_weapons'
                    value='@{wtype}&{template:simple} {{rname=^{melee_weapons-u}}} {{mod=@{melee_weapons_check_bonus}}} {{r1=[[@{d20}+@{melee_weapons_check_bonus}]]}} @{rtype}+@{melee_weapons_check_bonus}]]}} {{global=@{global_skill_mod}}} @{charname_output}'
                    data-i18n='melee_weapons-core'>Melee Weapons <span>[STR]</span></button>
                </div>
                <div class="skill" data-i18n-list-item="repair">
                  <input type="checkbox" name="attr_repair_prof" title="@{repair_prof}" value="(@{pb})">
                  <span name='attr_repair_bonus' title='@{repair_bonus}'>0</span>
                  <button type='roll' name='roll_repair'
                    value='@{wtype}&{template:simple} {{rname=^{repair-u}}} {{mod=@{repair_check_bonus}}} {{r1=[[@{d20}+@{repair_check_bonus}]]}} @{rtype}+@{repair_check_bonus}]]}} {{global=@{global_skill_mod}}} @{charname_output}'
                    data-i18n='repair-core'>Repair <span>[INT]</span></button>
                </div>
                <div class="skill" data-i18n-list-item="science">
                  <input type="checkbox" name="attr_science_prof" title="@{science_prof}" value="(@{pb})">
                  <span name='attr_science_bonus' title='@{science_bonus}'>0</span>
                  <button type='roll' name='roll_science'
                    value='@{wtype}&{template:simple} {{rname=^{science-u}}} {{mod=@{science_check_bonus}}} {{r1=[[@{d20}+@{science_check_bonus}]]}} @{rtype}+@{science_check_bonus}]]}} {{global=@{global_skill_mod}}} @{charname_output}'
                    data-i18n='science-core'>Science <span>[INT]</span></button>
                </div>
                <div class="skill" data-i18n-list-item="sneak">
                  <input type="checkbox" name="attr_sneak_prof" title="@{sneak_prof}" value="(@{pb})">
                  <span name='attr_sneak_bonus' title='@{sneak_bonus}'>0</span>
                  <button type='roll' name='roll_sneak'
                    value='@{wtype}&{template:simple} {{rname=^{sneak-u}}} {{mod=@{sneak_check_bonus}}} {{r1=[[@{d20}+@{sneak_check_bonus}]]}} @{rtype}+@{sneak_check_bonus}]]}} {{global=@{global_skill_mod}}} @{charname_output}'
                    data-i18n='sneak-core'>Sneak <span>[AGL]</span></button>
                </div>
                <div class="skill" data-i18n-list-item="speech">
                  <input type="checkbox" name="attr_speech_prof" title="@{speech_prof}" value="(@{pb})">
                  <span name='attr_speech_bonus' title='@{speech_bonus}'>0</span>
                  <button type='roll' name='roll_speech'
                    value='@{wtype}&{template:simple} {{rname=^{speech-u}}} {{mod=@{speech_check_bonus}}} {{r1=[[@{d20}+@{speech_check_bonus}]]}} @{rtype}+@{speech_check_bonus}]]}} {{global=@{global_skill_mod}}} @{charname_output}'
                    data-i18n='speech-core'>Speech <span>[CHA]</span></button>
                </div>
                <div class="skill" data-i18n-list-item="survival">
                  <input type="checkbox" name="attr_survival_prof" title="@{survival_prof}" value="(@{pb})">
                  <span name='attr_survival_bonus' title='@{survival_bonus}'>0</span>
                  <button type='roll' name='roll_survival'
                    value='@{wtype}&{template:simple} {{rname=^{survival-u}}} {{mod=@{survival_check_bonus}}} {{r1=[[@{d20}+@{survival_check_bonus}]]}} @{rtype}+@{survival_check_bonus}]]}} {{global=@{global_skill_mod}}} @{charname_output}'
                    data-i18n='survival-core'>Survival <span>[INT]</span></button>
                </div>
                <div class="skill" data-i18n-list-item="unarmed">
                  <input type="checkbox" name="attr_unarmed_prof" title="@{unarmed_prof}" value="(@{pb})">
                  <span name='attr_unarmed_bonus' title='@{unarmed_bonus}'>0</span>
                  <button type='roll' name='roll_unarmed'
                    value='@{wtype}&{template:simple} {{rname=^{unarmed-u}}} {{mod=@{unarmed_check_bonus}}} {{r1=[[@{d20}+@{unarmed_check_bonus}]]}} @{rtype}+@{unarmed_check_bonus}]]}} {{global=@{global_skill_mod}}} @{charname_output}'
                    data-i18n='unarmed-core'>Unarmed <span>[STR]</span></button>
                </div>
              </div>
              <!--<input type="hidden" class="toggleflag" name="attr_global_skill_mod_flag">
               <div class="hidden textarea globalattack">
                <span class="label" data-i18n="global-skill-u">GLOBAL SKILL MODIFIER</span>
                <fieldset class="repeating_skillmod">
                  <div class="global-mod">
                    <input type="checkbox" name="attr_options-flag" class="options-flag" checked="checked" style="top: -15px;"><span>y</span>
                    <input type="checkbox" name="attr_global_skill_active_flag" value="1" class="active-flag">
                    <div class="options">
                      <div class="row">
                        <span data-i18n="name:-u">NAME:</span>
                        <input type="text" name="attr_global_skill_name" value="" placeholder="—">
                      </div>
                      <div class="row">
                        <span data-i18n="roll:-u">ROLL:</span>
                        <input type="text" name="attr_global_skill_roll" value="" placeholder="—">
                      </div>
                    </div>
                    <div class="globaldisplay">
                      <span name="attr_global_skill_roll"></span>
                      [<span name="attr_global_skill_name"></span>]
                    </div>
                  </div>
                </fieldset>
              </div> -->
              <div class="label">
                <span data-i18n="skills-u">SKILLS</span>
              </div>
            </div>
            <div class="saving-throw-container">
              <div class="saving-throw">
                <input type="checkbox" name="attr_strength_save_prof" title="@{strength_save_prof}" value="(@{pb})">
                <span name="attr_strength_save_bonus" title="@{strength_save_bonus}">0</span>
                <button type="roll" name="roll_strength_save"
                  value="@{wtype}&{template:simple} {{rname=^{strength-save-u}}} {{mod=@{strength_save_bonus}}} {{r1=[[@{d20}+@{strength_save_bonus}]]}} @{rtype}+@{strength_save_bonus}]]}} {{global=@{global_save_mod}}} @{charname_output}"
                  data-i18n="strength">Strength</button>
              </div>
              <div class="saving-throw">
                <input type="checkbox" name="attr_perception_save_prof" title="@{perception_save_prof}" value="(@{pb})">
                <span name="attr_perception_save_bonus" title="@{perception_save_bonus}">0</span>
                <button type="roll" name="roll_perception_save"
                  value="@{wtype}&{template:simple} {{rname=^{perception-save-u}}} {{mod=@{perception_save_bonus}}} {{r1=[[@{d20}+@{perception_save_bonus}]]}} @{rtype}+@{perception_save_bonus}]]}} {{global=@{global_save_mod}}} @{charname_output}"
                  data-i18n="perception">Perception</button>
              </div>
              <div class="saving-throw">
                <input type="checkbox" name="attr_endurance_save_prof" title="@{endurance_save_prof}" value="(@{pb})">
                <span name="attr_endurance_save_bonus" title="@{endurance_save_bonus}">0</span>
                <button type="roll" name="roll_endurance_save"
                  value="@{wtype}&{template:simple} {{rname=^{endurance-save-u}}} {{mod=@{endurance_save_bonus}}} {{r1=[[@{d20}+@{endurance_save_bonus}]]}} @{rtype}+@{endurance_save_bonus}]]}} {{global=@{global_save_mod}}} @{charname_output}"
                  data-i18n="endurance">Endurance</button>
              </div>
              <div class="saving-throw">
                <input type="checkbox" name="attr_charisma_save_prof" title="@{charisma_save_prof}" value="(@{pb})">
                <span name="attr_charisma_save_bonus" title="@{charisma_save_bonus}">0</span>
                <button type="roll" name="roll_charisma_save"
                  value="@{wtype}&{template:simple} {{rname=^{charisma-save-u}}} {{mod=@{charisma_save_bonus}}} {{r1=[[@{d20}+@{charisma_save_bonus}]]}} @{rtype}+@{charisma_save_bonus}]]}} {{global=@{global_save_mod}}} @{charname_output}"
                  data-i18n="charisma">Charisma</button>
              </div>
              <div class="saving-throw">
                <input type="checkbox" name="attr_intelligence_save_prof" title="@{intelligence_save_prof}" value="(@{pb})">
                <span name="attr_intelligence_save_bonus" title="@{intelligence_save_bonus}">0</span>
                <button type="roll" name="roll_intelligence_save"
                  value="@{wtype}&{template:simple} {{rname=^{intelligence-save-u}}} {{mod=@{intelligence_save_bonus}}} {{r1=[[@{d20}+@{intelligence_save_bonus}]]}} @{rtype}+@{intelligence_save_bonus}]]}} {{global=@{global_save_mod}}} @{charname_output}"
                  data-i18n="intelligence">Intelligence</button>
              </div>
              <div class="saving-throw">
                <input type="checkbox" name="attr_agility_save_prof" title="@{agility_save_prof}" value="(@{pb})">
                <span name="attr_agility_save_bonus" title="@{agility_save_bonus}">0</span>
                <button type="roll" name="roll_agility_save"
                  value="@{wtype}&{template:simple} {{rname=^{agility-save-u}}} {{mod=@{agility_save_bonus}}} {{r1=[[@{d20}+@{agility_save_bonus}]]}} @{rtype}+@{agility_save_bonus}]]}} {{global=@{global_save_mod}}} @{charname_output}"
                  data-i18n="agility">Agility</button>
              </div>
              <div class="saving-throw">
                <input type="checkbox" name="attr_luck_save_prof" title="@{luck_save_prof}" value="(@{pb})">
                <span name="attr_luck_save_bonus" title="@{luck_save_bonus}">0</span>
                <button type="roll" name="roll_luck_save"
                  value="@{wtype}&{template:simple} {{rname=^{luck-save-u}}} {{mod=@{luck_save_bonus}}} {{r1=[[@{d20}+@{luck_save_bonus}]]}} @{rtype}+@{luck_save_bonus}]]}} {{global=@{global_save_mod}}} @{charname_output}"
                  data-i18n="luck">Luck</button>
              </div>
              <!-- <input type="hidden" class="toggleflag" name="attr_global_save_mod_flag">
              <div class="hidden textarea globalattack">
                <span class="label" data-i18n="global-save-u" style="position: relative; padding-bottom: 5px;">GLOBAL SAVE MODIFIER</span>
                <fieldset class="repeating_savemod">
                  <div class="global-mod">
                    <input type="checkbox" name="attr_options-flag" class="options-flag" checked="checked" style="top: -15px;"><span>y</span>
                    <input type="checkbox" name="attr_global_save_active_flag" value="1" class="active-flag">
                    <div class="options">
                      <div class="row">
                        <span data-i18n="name:-u">NAME:</span>
                        <input type="text" name="attr_global_save_name" value="" placeholder="—" style="width:75px">
                      </div>
                      <div class="row">
                        <span data-i18n="roll:-u">ROLL:</span>
                        <input type="text" name="attr_global_save_roll" value="" placeholder="—" style="width:75px">
                      </div>
                    </div>
                    <div class="globaldisplay" style="width: 75%">
                      <span name="attr_global_save_roll"></span>
                      [<span name="attr_global_save_name"></span>]
                    </div>
                  </div>
                </fieldset>
              </div> -->
              <div class="label">
                <span data-i18n="saving-throws-u">SAVING THROWS</span>
              </div>
            </div>
          </div>
          <div class="textbox pibf" style="width: 95%;">
              <input class="options-flag" type="checkbox" name="attr_options-flag-personality" checked="checked" style="top: 0px;"><span style="top: 0px;">y</span>
              <div class="options">
                  <textarea name="attr_personality_traits" style="min-height: 50px; height: 50px;"></textarea>
              </div>
              <div class="display">
                  <span name="attr_personality_traits"></span>
              </div>
              <span class="label" data-i18n="personality-traits-u">PERSONALITY TRAITS</span>
          </div>
          <div class="textbox pibf" style="width: 95%;">
              <input class="options-flag" type="checkbox" name="attr_options-flag-ideals" checked="checked" style="top: 0px;"><span style="top: 0px;">y</span>
              <div class="options">
                  <textarea name="attr_ideals"></textarea>
              </div>
              <div class="display">
                  <span name="attr_ideals"></span>
              </div>
              <span class="label" data-i18n="ideals-u">IDEALS</span>
          </div>
          <div class="textbox pibf" style="width: 95%;">
              <input class="options-flag" type="checkbox" name="attr_options-flag-bonds" checked="checked" style="top: 0px;"><span style="top: 0px;">y</span>
              <div class="options">
                  <textarea name="attr_bonds"></textarea>
              </div>
              <div class="display">
                  <span name="attr_bonds"></span>
              </div>
              <span class="label" data-i18n="bonds-u">BONDS</span>
          </div>
          <div class="textbox pibf" style="width: 95%;">
              <input class="options-flag" type="checkbox" name="attr_options-flag-flaws" checked="checked" style="top: 0px;"><span style="top: 0px;">y</span>
              <div class="options">
                  <textarea name="attr_flaws" style="min-height: 46px; height: 46px;"></textarea>
              </div>
              <div class="display">
                  <span name="attr_flaws"></span>
              </div>
              <span class="label" data-i18n="flaws-u">FLAWS</span>
          </div>
        </div>
        <div class="col col2">
          <div class="hdice-dsaves-container" style="width: 242px;">
            <div class="subcontainer">
              <div class="init">
                <span name="attr_initiative_bonus" title="@{initiative_bonus}"></span>
                <button type="roll" name="roll_initiative"
                  value="@{wtype}&{template:simple} {{rname=^{init-u}}} {{mod=@{initiative_bonus}}} {{r1=[[@{initiative_style}+@{initiative_bonus}[INIT] &{tracker}]]}} {{normal=1}} @{charname_output}"
                  data-i18n="init-u">INITIATIVE</button>
              </div>
            </div>
            <div class="subcontainer" style="float: right;">
              <div class="row-container">
                <span class="label" data-i18n="successes-u">SUCCESSES</span>
                <input type="checkbox" name="attr_deathsave_succ1">
                <input type="checkbox" name="attr_deathsave_succ2">
                <input type="checkbox" name="attr_deathsave_succ3">
              </div>
              <div class="row-container">
                <span class="label" data-i18n="failures-u">FAILURES</span>
                <input type="checkbox" name="attr_deathsave_fail1">
                <input type="checkbox" name="attr_deathsave_fail2">
                <input type="checkbox" name="attr_deathsave_fail3">
              </div>
              <button type="roll" name="roll_death_save" style="margin-top: 6px;"
                value="@{wtype}&{template:simple} {{rname=^{death-save-u}}} {{mod=@{death_save_bonus}}} {{r1=[[@{d20}+@{death_save_bonus}[MOD]@{globalsavingthrowbonus}]]}} {{normal=1}} {{global=@{global_save_mod}}} @{charname_output}"
                data-i18n="death-saves-u">DEATH SAVES</button>
            </div>
          </div>
          <div class="hp">
            <div class="top">
              <span data-i18n="hp-max-u">Hit Point Maximum</span>
              <input class="sheet-no_events" type="text" name="attr_hp_max" title="@{hp_max}">
            </div>
            <input type="number" name="attr_hp" title="@{hp}" step="1" min="0">
            <span class="label" data-i18n="hp-current-u">CURRENT HIT POINTS</span>
          </div>
          <div class="def-dt-speed-container">
            <div class="def">
              <input class="sheet-no_events" type="text" name="attr_def" title="@{def}">
              <span class="label pc-def" data-i18n="defense-u">DEFENSE</span>
            </div>
            <div class="dt">
              <input class="sheet-no_events" type="text" name="attr_dt" title="@{dt}">
              <span class="label pc-dt" data-i18n="dt-u">DT</span>
            </div>
            <div class="speed">
              <input class="sheet-no_events" type="text" name="attr_speed" title="@{speed}">
              <span class="label" data-i18n="speed-u">SPEED</span>
            </div>
          </div>
          <input type="hidden" class="exhaustion-toggle" name="attr_exhaustion_toggle" value="0">
          <div class="exhaustion" style="position: relative;">
            <input type="number" name="attr_exhaustion_level" step="1" min="0" max="6">
            <div class="ex-descriptions">
              <span class="ex-description" name="attr_exhaustion_1"></span>
              <span class="ex-description" name="attr_exhaustion_2"></span>
              <span class="ex-description" name="attr_exhaustion_3"></span>
              <span class="ex-description" name="attr_exhaustion_4"></span>
              <span class="ex-description" name="attr_exhaustion_5"></span>
              <span class="ex-description" name="attr_exhaustion_6"></span>
            </div>
            <span class="label" data-i18n="exhaustion-u">EXHAUSTION LEVEL</span>
          </div>
          <input type="hidden" class="radiation-toggle" name="attr_radiation_toggle" value="0">
          <div class="radiation" style="position: relative;">
            <input type="number" name="attr_radiation_level" step="1" min="0" max="10">
            <div class="ex-descriptions">
              <span class="ex-description" name="attr_radiation_1" style="font-weight: bold;"></span>
              <span class="ex-description" name="attr_radiation_2"></span>
              <span class="ex-description" name="attr_radiation_3"></span>
              <span class="ex-description" name="attr_radiation_4"></span>
              <span class="ex-description" name="attr_radiation_5"></span>
              <span class="ex-description" name="attr_radiation_6"></span>
            </div>
            <span class="label" data-i18n="radiation-u">RADIATION LEVEL</span>
          </div>
          <div class="custom_mods">
            <input type="hidden" class="modsflag" name="attr_simplemods" value="0">
            <textarea class="simple" name="attr_global_mods"></textarea>
            <div class="complex">
              <div class="top">
                <span style="width: 20px; padding-left: 5px"><img src="https://raw.githubusercontent.com/mmarder96/wild-wasteland-char-sheet/dev/images/equipped.png" style="width: 15px; margin-bottom: -3px; vertical-align: inherit;"
                    alt="active symbol"></span>
                <span style="width: 85px;" data-i18n="name-u">NAME</span>
                <span style="width: 110px;" data-i18n="mods-u">MODS</span>
              </div>
              <fieldset class="repeating_modifiers">
                <input type="hidden" class="activeflag" name="attr_active">
                <div class="mod" style="margin-bottom: 5px;">
                  <input class="options-flag" type="checkbox" name="attr_options-flag" checked="checked"><span>y</span>
                  <div class="display">
                    <input class="equipped" type="checkbox" name="attr_active" value="1">
                    <input class="name" type="text" name="attr_modname" style="width: 85px;">
                    <input type="hidden" name="attr_modifiers">
                    <span name="attr_modifiers" style="width: 110px;"></span>
                  </div>
                  <div class="options">
                    <div class="row">
                      <span class="label" data-i18n="mods:-u">MODS:</span>
                      <textarea class="subtextarea" name="attr_modifiers"></textarea>
                    </div>
                  </div>
                </div>
              </fieldset>
            </div>
            <div class="label" style="position: absolute; bottom: 0px; width: 100%; text-align: center;">
              <span data-i18n="custom-mods-u" style="display: inline;">CUSTOM MODIFIERS</span>
            </div>
          </div>
          <input type="hidden" class="ammoflag" name="attr_ammotracking" value="0">
          <div class="attacks">
            <input type="hidden" class="attacksflag" name="attr_simpleattacks" value="0">
            <textarea class="simple" name="attr_attacks"></textarea>
            <div class="complex">
              <input type="hidden" class="warningflag" name="attr_attackswarningflag">
              <div class="header" style="height: auto;">
                <button type="action" name="act_increment_cooldowns" style="background: transparent; border: none; margin-bottom: -3px;">
                  <img src="https://raw.githubusercontent.com/mmarder96/wild-wasteland-char-sheet/dev/images/cooldown.png" style="width: 15px;" alt="cooldown symbol"/>
                </button>
                <span class="label" style="width: 95px; text-align: left;" data-i18n="attack-name-u">ATTACK NAME</span>
                <span class="label" style="width: 30px; text-align: left;" data-i18n="atk-u">ATK</span>
                <span class="label" style="width: 70px; text-align: left;" data-i18n="dmg-type-u">DMG/TYPE</span>
              </div>
              <fieldset class="repeating_attack">
                <input type="hidden" class="activeflag" name="attr_activeflag" value="0">
                <div class="item">
                  <input type="text" class="cooldowncur" name="attr_cooldowncur" style="margin-left: 3px;">
                  <input class="name" type="text" name="attr_atkname" style="width: 90px;">
                  <button class="atkroll" type="roll" name="roll_attack" value="@{rollbase}" onclick="increment_cooldowns()">
                    <input type="text" name="attr_atkbonus" style="width: 30px; text-align: center; margin-left: -3px" value="">
                    <input type="text" name="attr_atkdmgtype" style="width: 75px;" value="">
                  </button>
                  <button class= "atkroll_disabled" type="roll" name="roll_attack_disabled" value="" disabled>
                    <input type="text" name="attr_atkbonus" style="width: 30px; text-align: center; margin-left: -3px" value="">
                    <input type="text" name="attr_atkdmgtype" style="width: 75px;" value="">
                  </button>

                  <input type="hidden" name="attr_rollbase">
                  <input type="hidden" name="attr_rollbase_dmg">
                  <input type="hidden" name="attr_rollbase_crit">
                  <input type="hidden" name="attr_hldmg">
                  <input type="hidden" name="attr_spelllevel">
                  <input type="hidden" name="attr_itemid">
                  <input type="hidden" name="attr_spellid">
                  <input type="hidden" name="attr_spell_innate">
                  <input type="hidden" name="attr_versatile_alt">
                  <button type="roll" name="roll_attack_dmg" style="display: none;" value="@{rollbase_dmg}"></button>
                  <button type="roll" name="roll_attack_crit" style="display: none;" value="@{rollbase_crit}"></button>

                  <input class="inventorysubflag" type="checkbox" name="attr_inventorysubflag"><span>y</span>
                  <div class="subitem">
                    <input class="typeflag" type="hidden" name="attr_typeflag" value="none">
                    <span class="label" data-i18n="type:-u">TYPE:</span>
                    <select name="attr_type" style="width: 55px;">
                      <option value="melee" data-i18n="melee">Melee</option>
                      <option value="ranged" data-i18n="ranged">Ranged</option>
                      <option value="none" selected="selected">—</option>
                    </select>
                    <span class="label" data-i18n="class:-u">CLASS:</span>
                    <select class="melee" name="attr_class" style="width: 90px;">
                      <option value="unarmed" data-i18n="unarmed">Unarmed</option>
                      <option value="slash" data-i18n="slash">Slash</option>
                      <option value="blunt" data-i18n="blunt">Blunt</option>
                      <option value="pierce" data-i18n="pierce">Pierce</option>
                      <option value="none" selected="selected">—</option>
                    </select>
                    <select class="ranged" name="attr_class" style="width: 90px;">
                      <option value="pistol" data-i18n="pistol">Pistol</option>
                      <option value="smg" data-i18n="smg">SMG</option>
                      <option value="shotgun" data-i18n="shotgun">Shotgun</option>
                      <option value="ar" data-i18n="ar">Assault rifle</option>
                      <option value="br" data-i18n="br">Battle rifle</option>
                      <option value="sniper" data-i18n="sniper">Sniper rifle</option>
                      <option value="lmg" data-i18n="lmg">LMG</option>
                      <option value="heavy" data-i18n="heavy">Heavy weapon</option>
                      <option value="none" selected="selected">—</option>
                    </select>
                    <select class="none" name="attr_class" style="width: 90px;">
                      <option value="none" selected="selected">—</option>
                    </select>

                    <span class="label" style="width: 45px" data-i18n="action:-u">ACTION:</span>
                    <select name="attr_actioncost" style="width: 60px;">
                      <option value="major" data-i18n="major" selected="selected">Major action</option>
                      <option value="minor" data-i18n="minor">Minor action</option>
                      <option value="bonus" data-i18n="bonus">Bonus action</option>
                      <option value="reaction" data-i18n="reaction">Reaction</option>
                      <option value="free" data-i18n="free">Free action</option>
                    </select>
                    <span class="label" style="width: 65px;" data-i18n="cooldown:-u">COOLDOWN:</span>
                    <input class="subfield" type="text" name="attr_cooldown" placeholder="0" value="0" style="width: 45px;">

                    <input type="checkbox" name="attr_atkflag" value="{{attack=1}}" checked="checked">
                    <span style="width: 30px;" data-i18n="atk:-u">ATK:</span>
                    <input class="subfield" type="text" name="attr_atkbase" placeholder="0" style="width: 20px; font-size: 11px">
                    <span style="width: 5px">+</span>
                    <select name="attr_atkattr" style="width: 25px">
                      <option value="@{strength_mod}" selected="selected" data-i18n="str-u">STR</option>
                      <option value="@{perception_mod}" data-i18n="per-u">PER</option>
                      <option value="@{endurance_mod}" data-i18n="end-u">END</option>
                      <option value="@{charisma_mod}" data-i18n="cha-u">CHA</option>
                      <option value="@{intelligence_mod}" data-i18n="int-u">INT</option>
                      <option value="@{agility_mod}" data-i18n="agl-u">AGL</option>
                      <option value="@{luck_mod}" data-i18n="luk-u">LUK</option>
                      <option value="0" selected="selected">—</option>
                    </select>
                    <span style="width: 5px">+</span>
                    <select name="attr_atkskill" style="width: 70px">
                      <option value="@{barter_bonus}" data-i18n="barter">Barter</option>
                      <option value="@{energy_weapons_bonus}" data-i18n="energy_weapons">Energy Weapons</option>
                      <option value="@{explosives_bonus}" data-i18n="explosives">Explosives</option>
                      <option value="@{guns_bonus}" data-i18n="guns">Guns</option>
                      <option value="@{medicine_bonus}" data-i18n="medicine">Lockpick</option>
                      <option value="@{melee_weapons_bonus}" data-i18n="melee_weapons">Melee Weapons</option>
                      <option value="@{repair_bonus}" data-i18n="repair">Repair</option>
                      <option value="@{science_bonus}" data-i18n="science">Science</option>
                      <option value="@{sneak_bonus}" data-i18n="sneak">Sneak</option>
                      <option value="@{speech_bonus}" data-i18n="speech">Speech</option>
                      <option value="@{survival_bonus}" data-i18n="survival">Survival</option>
                      <option value="@{unarmed_bonus}" data-i18n="unarmed">Unarmed</option>
                      <option value="@{pb}" data-i18n="tag-bonus">Tag Skill Bonus</option>
                      <option value="0" selected="selected">—</option>
                    </select>

                    <span style="margin-left: 20px;" data-i18n="range:-u">RANGE:</span>
                    <input class="subfield" type="text" name="attr_atkrange" placeholder="—" style="width: 50px;">
                    <span style="width: 70px" data-i18n="crit-range-u">CRIT RANGE:</span>
                    <input class="subfield" type="text" name="attr_atkcritrange" value="" placeholder="20" style="width: 40px; font-size: 11px;">

                    <input type="checkbox" name="attr_dmgflag" value="{{damage=1}} {{dmg1flag=1}}" checked="checked">
                    <input type="hidden" name="attr_dmg2flag" value="">
                    <span style="width: 30px;" data-i18n="dmg:-u">DMG:</span>
                    <input class="subfield" type="text" name="attr_dmgbase" placeholder="0" style="width: 20px; font-size: 11px">
                    <span style="width: 5px">+</span>
                    <select name="attr_dmgattr" style="width: 25px">
                      <option value="@{strength_mod}" data-i18n="str-u">STR</option>
                      <option value="@{perception_mod}" data-i18n="per-u">PER</option>
                      <option value="@{endurance_mod}" data-i18n="end-u">END</option>
                      <option value="@{charisma_mod}" data-i18n="cha-u">CHA</option>
                      <option value="@{intelligence_mod}" data-i18n="int-u">INT</option>
                      <option value="@{agility_mod}" data-i18n="agl-u">AGL</option>
                      <option value="@{luck_mod}" data-i18n="luk-u">LUK</option>
                      <option value="0" selected="selected">—</option>
                    </select>
                    <span style="width: 5px">+</span>
                    <select name="attr_dmgskill" style="width: 70px">
                      <option value="@{barter_bonus}" data-i18n="barter">Barter</option>
                      <option value="@{energy_weapons_bonus}" data-i18n="energy_weapons">Energy Weapons</option>
                      <option value="@{explosives_bonus}" data-i18n="explosives">Explosives</option>
                      <option value="@{guns_bonus}" data-i18n="guns">Guns</option>
                      <option value="@{medicine_bonus}" data-i18n="medicine">Lockpick</option>
                      <option value="@{melee_weapons_bonus}" data-i18n="melee_weapons">Melee Weapons</option>
                      <option value="@{repair_bonus}" data-i18n="repair">Repair</option>
                      <option value="@{science_bonus}" data-i18n="science">Science</option>
                      <option value="@{sneak_bonus}" data-i18n="sneak">Sneak</option>
                      <option value="@{speech_bonus}" data-i18n="speech">Speech</option>
                      <option value="@{survival_bonus}" data-i18n="survival">Survival</option>
                      <option value="@{unarmed_bonus}" data-i18n="unarmed">Unarmed</option>
                      <option value="@{pb}" data-i18n="tag-bonus">Tag Skill Bonus</option>
                      <option value="0" selected="selected">—</option>
                    </select>
                    <span style="width: 5px">+</span>
                    <input class="subfield" type="text" name="attr_dmgroll" placeholder="1d6" style="width: 25px; font-size: 10px;">

                    <span style="margin-left: 17px;" data-i18n="type:-u">TYPE:</span>
                    <input class ="subfield" type="text" name="attr_dmgtype" placeholder="—" style="width: 50px;">
                    <span style="width: 70px;" data-i18n="crit-bonus:-u">CRIT BONUS:</span>
                    <input class="subfield" type="text" name="attr_dmgcustcrit" placeholder="—" style="width: 40px; font-size: 11px;">

                    <input type="checkbox" name="attr_saveflag" value="{{save=1}} {{saveattr=@{saveattr}}} {{savedesc=@{saveeffect}}} {{savedc=[[[[@{savedc}]][SAVE]]]}}">
                    <span style="width: 75px;" data-i18n="saving-throw:-u">SAVING THROW:</span>
                    <select style="width: 30px;" name="attr_saveattr">
                      <option value="Strength" selected="selected" data-i18n="str-u">STR</option>
                      <option value="Perception" data-i18n="per-u">PER</option>
                      <option value="Endurance" data-i18n="end-u">END</option>
                      <option value="Charisma" data-i18n="cha-u">CHA</option>
                      <option value="Intelligence" data-i18n="int-u">INT</option>
                      <option value="Agility" data-i18n="agl-u">AGL</option>
                      <option value="Luck" data-i18n="luk-u">LUK</option>
                    </select>
                    <span style="width: 35px;" data-i18n="vs-dc:-u">VS DC:</span>
                    <select style="width: 30px;" name="attr_savedc">
                      <option value="(@{strength_mod}+8+@{pb})" data-i18n="str-u">STR</option>
                      <option value="(@{perception_mod}+8+@{pb})" data-i18n="per-u">PER</option>
                      <option value="(@{endurance_mod}+8+@{pb})" data-i18n="end-u">END</option>
                      <option value="(@{charisma_mod}+8+@{pb})" data-i18n="cha-u">CHA</option>
                      <option value="(@{intelligence_mod}+8+@{pb})" data-i18n="int-u">INT</option>
                      <option value="(@{agility_mod}+8+@{pb})" data-i18n="agl-u">AGL</option>
                      <option value="(@{luck_mod}+8+@{pb})" data-i18n="agl-u">LUK</option>
                      <option value="(@{saveflat})" data-i18n="flat-u">FLAT</option>
                    </select>
                    <input class="flatflag" type="hidden" name="attr_savedc">
                    <input class="flat" type="num" name="attr_saveflat" placeholder="10" value="10">

                    <span style="width: 65px;" data-i18n="save-effect:-u">SAVE EFFECT:</span>
                    <input class="subfield" type="text" name="attr_saveeffect" placeholder="—" style="width: 160px;">

                    <span data-i18n="description:-u">DESCRIPTION:</span>
                    <textarea class="subtextarea" name="attr_atk_desc"></textarea>
                  </div>
                  <input type="hidden" name="attr_itemattackid">
                  <input type="hidden" name="attr_itemresourceid">
                </div>
              </fieldset>
              <input type="hidden" class="toggleflag" name="attr_global_attack_mod_flag">
              <div class="hidden textarea globalattack">
                <span class="label" data-i18n="global-attack-u">GLOBAL ATTACK MODIFIERS</span>
                <fieldset class="repeating_tohitmod">
                  <div class="item">
                    <input type="checkbox" name="attr_global_attack_active_flag" value="1" class="equipped">
                    <input class="name" type="text" name="attr_global_atkname" style="margin-left: 5px; width: 90px;">
                    <input type="text" name="attr_global_atkbonus_display" readonly="readonly" style="width: 30px; text-align: center; margin-left: 1px; padding: 4px 0px 4px 0px;">
                    <input type="text" name="attr_global_atkdmgtype" readonly="readonly" style="width: 75px;">
                    <input class="inventorysubflag" type="checkbox" name="attr_options-flag"><span>y</span>
                    <div class="subitem">
                      <span data-i18n="atk:-u">ATK:</span>
                      <input class="subfield" type="text" name="attr_global_atkbonus" value="" placeholder="0" style="width: 25px;">
                      <span data-i18n="dmg:-u">DMG:</span>
                      <input class="subfield" type="text" name="attr_global_dmgbonus" value="" placeholder="0" style="width: 25px;">
                      <span data-i18n="type:-u">TYPE:</span>
                      <input class="subfield" type="text" name="attr_global_dmgtype" placeholder="—" style="width: 50px;">
                    </div>
                  </div>
                </fieldset>
              </div>
            </div>
            <span class="label" style="margin-top: 0px; position: absolute; bottom: 0px;" data-i18n="atk-abilities-u">ATTACKS & ABILITIES</span>
          </div>
          <div class="weapons">
            <input type="hidden" class="weaponsflag" name="attr_simpleweapons" value="0">
            <textarea class="simple" name="attr_weapons"></textarea>
            <div class="complex">
              <input type="hidden" class="warningflag" name="attr_weaponswarningflag">
              <input type="hidden" class="warningflag" name="attr_weaponswarningflag">
              <div class="header" style="height: auto;">
                <span style="width: 25px;"><img src="https://raw.githubusercontent.com/mmarder96/wild-wasteland-char-sheet/dev/images/equipped.png" style="width: 15px; margin-bottom: -3px; vertical-align: inherit;"
                    alt="equipped symbol"></span>
                <span style="width: 175px; text-align: left;" data-i18n="weapon-name-u">WEAPON NAME</span>
                <button type="action" name="act_reload" style="background: transparent; border: none;">
                  <img src="https://raw.githubusercontent.com/mmarder96/wild-wasteland-char-sheet/dev/images/ammo.png" style="width: 15px;" alt="ammo"/>
                </button>
              </div>
              <input type="hidden" name="attr_equippedweaponid">
              <fieldset class="repeating_weapons">
                <input type="hidden" class="equippedflag" name="attr_equipped" value="0">
                <div class="item">
                  <input class="equipped" type="checkbox" name="attr_equipped" value="1">
                  <input class="name" type="text" name="attr_wpnname">
                  <input class="weight" type="text" name="attr_shots" placeholder="—">
                  <input class="inventorysubflag" type="checkbox" name="attr_inventorysubflag"><span>y</span>
                  <div class="subitem">
                    <input class="typeflag" type="hidden" name="attr_typeflag" value="none">
                    <span class="label" data-i18n="type:-u">TYPE:</span>
                    <select name="attr_type" style="width: 55px;">
                      <option value="melee" data-i18n="melee">Melee</option>
                      <option value="ranged" data-i18n="ranged">Ranged</option>
                      <option value="none" selected="selected">—</option>
                    </select>
                    <span class="label" data-i18n="class:-u">CLASS:</span>
                    <select class="melee" name="attr_class" style="width: 63px;">
                      <option value="unarmed" data-i18n="unarmed">Unarmed</option>
                      <option value="slash" data-i18n="slash">Slash</option>
                      <option value="blunt" data-i18n="blunt">Blunt</option>
                      <option value="pierce" data-i18n="pierce">Pierce</option>
                      <option value="none" selected="selected">—</option>
                    </select>
                    <select class="ranged" name="attr_class" style="width: 63px;">
                      <option value="pistol" data-i18n="pistol">Pistol</option>
                      <option value="smg" data-i18n="smg">SMG</option>
                      <option value="shotgun" data-i18n="shotgun">Shotgun</option>
                      <option value="ar" data-i18n="ar">Assault rifle</option>
                      <option value="br" data-i18n="br">Battle rifle</option>
                      <option value="sniper" data-i18n="sniper">Sniper rifle</option>
                      <option value="lmg" data-i18n="lmg">LMG</option>
                      <option value="heavy" data-i18n="heavy">Heavy weapon</option>
                      <option value="none" selected="selected">—</option>
                    </select>
                    <select class="none" name="attr_class" style="width: 63px;">
                      <option value="none" selected="selected">—</option>
                    </select>
                    <input type="checkbox" name="attr_magflag" value="1">

                    <input class="magflag" type="hidden" name="attr_magflag">
                    <div class="ammobox">
                      <span class="label" data-i18n="mag:-u">MAG:</span>
                      <input class="subfield ranged" type="text" name="attr_mag" placeholder="0" style="width: 55px; font-size: 11px;">
                      <span class="label" data-i18n="ammo:-u">AMMO:</span>
                      <input class="subfield" type="text" name="attr_ammo" placeholder="—" style="width: 90px;">
                    </div>

                    <input type="checkbox" name="attr_atkflag" value="{{attack=1}}" checked="checked">
                    <span style="width: 30px;" data-i18n="atk:-u">ATK:</span>
                    <input class="subfield" type="text" name="attr_atkbase" placeholder="0" style="width: 20px; font-size: 11px">
                    <span style="width: 5px">+</span>
                    <select name="attr_atkattr" style="width: 25px">
                      <option value="@{strength_mod}" selected="selected" data-i18n="str-u">STR</option>
                      <option value="@{perception_mod}" data-i18n="per-u">PER</option>
                      <option value="@{endurance_mod}" data-i18n="end-u">END</option>
                      <option value="@{charisma_mod}" data-i18n="cha-u">CHA</option>
                      <option value="@{intelligence_mod}" data-i18n="int-u">INT</option>
                      <option value="@{agility_mod}" data-i18n="agl-u">AGL</option>
                      <option value="@{luck_mod}" data-i18n="luk-u">LUK</option>
                      <option value="0" selected="selected">—</option>
                    </select>
                    <span style="width: 5px">+</span>
                    <select name="attr_atkskill" style="width: 70px">
                      <option value="@{barter_bonus}" data-i18n="barter">Barter</option>
                      <option value="@{energy_weapons_bonus}" data-i18n="energy_weapons">Energy Weapons</option>
                      <option value="@{explosives_bonus}" data-i18n="explosives">Explosives</option>
                      <option value="@{guns_bonus}" data-i18n="guns">Guns</option>
                      <option value="@{medicine_bonus}" data-i18n="medicine">Lockpick</option>
                      <option value="@{melee_weapons_bonus}" data-i18n="melee_weapons">Melee Weapons</option>
                      <option value="@{repair_bonus}" data-i18n="repair">Repair</option>
                      <option value="@{science_bonus}" data-i18n="science">Science</option>
                      <option value="@{sneak_bonus}" data-i18n="sneak">Sneak</option>
                      <option value="@{speech_bonus}" data-i18n="speech">Speech</option>
                      <option value="@{survival_bonus}" data-i18n="survival">Survival</option>
                      <option value="@{unarmed_bonus}" data-i18n="unarmed">Unarmed</option>
                      <option value="@{pb}" data-i18n="tag-bonus">Tag Skill Bonus</option>
                      <option value="0" selected="selected">—</option>
                    </select>

                    <span style="margin-left: 20px;" data-i18n="range:-u">RANGE:</span>
                    <input class="subfield" type="text" name="attr_atkrange" placeholder="—" style="width: 50px;">
                    <span style="width: 70px" data-i18n="crit-range-u">CRIT RANGE:</span>
                    <input class="subfield" type="text" name="attr_atkcritrange" value="" placeholder="20" style="width: 40px; font-size: 11px;">

                    <input type="checkbox" name="attr_dmgflag" value="{{damage=1}} {{dmg1flag=1}}" checked="checked">
                    <span style="width: 30px;" data-i18n="dmg:-u">DMG:</span>
                    <input class="subfield" type="text" name="attr_dmgbase" placeholder="0" style="width: 20px; font-size: 11px">
                    <span style="width: 5px">+</span>
                    <select name="attr_dmgattr" style="width: 25px">
                      <option value="@{strength_mod}" data-i18n="str-u">STR</option>
                      <option value="@{perception_mod}" data-i18n="per-u">PER</option>
                      <option value="@{endurance_mod}" data-i18n="end-u">END</option>
                      <option value="@{charisma_mod}" data-i18n="cha-u">CHA</option>
                      <option value="@{intelligence_mod}" data-i18n="int-u">INT</option>
                      <option value="@{agility_mod}" data-i18n="agl-u">AGL</option>
                      <option value="@{luck_mod}" data-i18n="luk-u">LUK</option>
                      <option value="0" selected="selected">—</option>
                    </select>
                    <span style="width: 5px">+</span>
                    <select name="attr_dmgskill" style="width: 70px">
                      <option value="@{barter_bonus}" data-i18n="barter">Barter</option>
                      <option value="@{energy_weapons_bonus}" data-i18n="energy_weapons">Energy Weapons</option>
                      <option value="@{explosives_bonus}" data-i18n="explosives">Explosives</option>
                      <option value="@{guns_bonus}" data-i18n="guns">Guns</option>
                      <option value="@{medicine_bonus}" data-i18n="medicine">Lockpick</option>
                      <option value="@{melee_weapons_bonus}" data-i18n="melee_weapons">Melee Weapons</option>
                      <option value="@{repair_bonus}" data-i18n="repair">Repair</option>
                      <option value="@{science_bonus}" data-i18n="science">Science</option>
                      <option value="@{sneak_bonus}" data-i18n="sneak">Sneak</option>
                      <option value="@{speech_bonus}" data-i18n="speech">Speech</option>
                      <option value="@{survival_bonus}" data-i18n="survival">Survival</option>
                      <option value="@{unarmed_bonus}" data-i18n="unarmed">Unarmed</option>
                      <option value="@{pb}" data-i18n="tag-bonus">Tag Skill Bonus</option>
                      <option value="0" selected="selected">—</option>
                    </select>
                    <span style="width: 5px">+</span>
                    <input class="subfield" type="text" name="attr_dmgroll" placeholder="1d6" style="width: 25px; font-size: 10px;">

                    <span style="margin-left: 17px;" data-i18n="type:-u">TYPE:</span>
                    <input class ="subfield" type="text" name="attr_dmgtype" placeholder="—" style="width: 50px;">
                    <span style="width: 70px;" data-i18n="crit-bonus:-u">CRIT BONUS:</span>
                    <input class="subfield" type="text" name="attr_dmgcustcrit" placeholder="—" style="width: 40px; font-size: 11px;">

                    <span class="label" data-i18n="prop:-u">PROP:</span>
                    <input class="subfield" type="text" name="attr_properties">
                    <textarea class="subtextarea" name="attr_description"></textarea>
                  </div>
                  <input type="hidden" name="attr_itemid">
                  <input type="hidden" name="attr_itemattackid">
                  <input type="hidden" name="attr_itemresourceid">
                </div>
              </fieldset>
            </div>
            <span class="label" style="margin-top: 0px; position: absolute; bottom: 0px;" data-i18n="weapons-u">WEAPONS</span>
          </div>
          <div class="armor">
            <input type="hidden" class="armorflag" name="attr_simplearmor" value="0">
            <textarea class="simple" name="attr_armor"></textarea>
            <div class="complex">
              <input type="hidden" class="warningflag" name="attr_armorwarningflag">
              <div class="warning">
                <span>
                  <label><input type="checkbox" name="attr_armorwarningflag" value="hide">*</label>
                  <span data-i18n="warning-armor-sets-u">
                    WARNING - MULTIPLE SETS OF ARMOR OR SHIELDS HAVE BEEN ADDED AND AC IS NOT CORRECTLY CALCULATED. UNEQUIP THE ARMOR PIECE FROM THE ITEM DETAILS.
                  </span>
                </span>
              </div>
              <input type="hidden" class="warningflag" name="attr_customacwarningflag">
              <div class="warning">
                <span>
                  <label><input type="checkbox" name="attr_customacwarningflag" value="hide">*</label>
                  <span data-i18n="warning-customac-u">
                    ATTENTION - YOUR CUSTOM AC CALCULATION IS NOT BEING USED AS YOU HAVE ARMOR EQUIPPED. IF YOU WANT TO USE YOUR CUSTOM AC, UNEQUIP THE ARMOR PIECE FROM THE ITEM DETAILS.
                  </span>
                </span>
              </div>
              <div class="header" style="height: auto;">
                <span style="width: 25px;"><img src="https://raw.githubusercontent.com/mmarder96/wild-wasteland-char-sheet/dev/images/equipped.png" style="width: 15px; margin-bottom: -3px; vertical-align: inherit;"
                    alt="equipped symbol"></span>
                <span style="width: 175px; text-align: left;" data-i18n="armor-name-u">ARMOR NAME</SPAN>
                <span style="width: 25px;"><img src="https://raw.githubusercontent.com/mmarder96/wild-wasteland-char-sheet/beta/images/dt.png" style="width: 15px; margin-bottom: -3px;  vertical-align: inherit;"
                    alt="DT symbol"></span>
              </div>
              <input type="hidden" name="attr_equippedclothingid">
              <input type="hidden" name="attr_equippedarmorid">
              <fieldset class="repeating_armor">
                <input type="hidden" class="equippedflag" name="attr_equipped" value="0">
                <div class="item">
                  <input class="equipped" type="checkbox" name="attr_equipped" value="1">
                  <input class="name" type="text" name="attr_armorname">
                  <input class="weight" type="text" name="attr_armordt" placeholder="0">
                  <input class="inventorysubflag" type="checkbox" name="attr_inventorysubflag"><span>y</span>
                  <div class="subitem">
                    <span class="label" data-i18n="type:-u">TYPE:</span>
                    <select name="attr_type">
                      <option value="clothing" data-i18n="clothing">Clothing</option>
                      <option value="light" data-i18n="light-armor">Light armor</option>
                      <option value="medium" data-i18n="medium-armor">Medium armor</option>
                      <option value="heavy" data-i18n="heavy-armor">Heavy armor</option>
                      <option value="power" data-i18n="power-armor">Power armor</option>
                      <option value="accessory" data-i18n="accessory">Accessory</option>
                      <option value="none" selected="selected">—</option>
                    </select>
                    <span class="label" data-i18n="prop:-u">PROP:</span>
                    <input class="subfield" type="text" name="attr_armorproperties">
                    <span class="label" data-i18n="mods:-u">MODS:</span>
                    <input class="subfield" type="text" name="attr_itemmodifiers">
                    <textarea class="subtextarea" name="attr_armorcontent"></textarea>
                  </div>
                  <input type="hidden" name="attr_itemid">
                  <input type="hidden" name="attr_itemattackid">
                  <input type="hidden" name="attr_itemresourceid">
                </div>
              </fieldset>
            </div>
            <span class="label" style="margin-top: 0px; bottom: 0px;" data-i18n="armor-u">ARMOR</span>
          </div>
        </div>
        <div class="col col3">
          <div class="resources">
            <div class="hdice-dsaves-container" style="width: 246px;">
              <div class="subcontainer" style="height: 64px; width: 119px;">
                <div class="top">
                  <span style="margin-left: 5px;" data-i18n="total">Total</span>
                  <input type="text" name="attr_class_resource_max" title="@{class_resource_max}">
                </div>
                <input type="number" name="attr_main_resource" title="@{main_resource}" style="margin-bottom: -6px;">
                <input type="text" class="label" name="attr_main_resource_name" title="@{mainresource_name}" placeholder="MAIN RESOURCE" data-i18n-placeholder="main-resource-u">
              </div>
              <div class="subcontainer" style="height: 64px; width: 119px; float: right;">
                <div class="top">
                  <span style="margin-left: 5px;" data-i18n="total">Total</span>
                  <input type="text" name="attr_other_resource_max" title="@{other_resource_max}">
                </div>
                <input type="number" name="attr_other_resource" title="@{other_resource}" style="margin-bottom: -6px;">
                <input type="text" class="label" name="attr_other_resource_name" title="@{other_resource_name}" placeholder="OTHER RESOURCE" data-i18n-placeholder="other-resource-u">
                <input type="hidden" name="attr_other_resource_itemid">
              </div>
            </div>
            <fieldset class="repeating_resource">
              <div class="hdice-dsaves-container" style="width: 246px;">
                <div class="subcontainer" style="height: 64px; width: 119px;">
                  <div class="top">
                    <span data-i18n="total">Total</span>
                    <input type="text" name="attr_resource_left_max" title="@{repeating_resource_left_max}">
                  </div>
                  <input type="number" name="attr_resource_left" title="@{repeating_resource_left}" style="margin-bottom: -6px;">
                  <input type="text" class="label" name="attr_resource_left_name" title="@{repeating_resource_left_name}" placeholder="OTHER RESOURCE" data-i18n-placeholder="other-resource-u">
                  <input type="hidden" name="attr_resource_left_itemid">
                </div>
                <div class="subcontainer" style="height: 64px; width: 119px;">
                  <div class="top">
                    <span data-i18n="total">Total</span>
                    <input type="text" name="attr_resource_right_max" title="@{repeating_resource_right_max}">
                  </div>
                  <input type="number" name="attr_resource_right" title="@{repeating_resource_right}" style="margin-bottom: -6px;">
                  <input type="text" class="label" name="attr_resource_right_name" title="@{repeating_resource_right_name}" placeholder="OTHER RESOURCE" data-i18n-placeholder="other-resource-u">
                  <input type="hidden" name="attr_resource_right_itemid">
                </div>
              </div>
            </fieldset>
          </div>
          <input type="hidden" class="pageflag" name="attr_currpage" value="0">
          <div class="equipment" style="min-height: 541px; width: 95%; padding-left: 5px;">
            <button type="action" name="act_switch_page" class="sheet-nextpage" style="background: transparent; border: none; margin-bottom: -3px;">
              <img src="https://raw.githubusercontent.com/mmarder96/wild-wasteland-char-sheet/dev/images/next-page.png" style="width: 20px;" alt="next page"/>
            </button>
            <div class="money">
              <div class="coin">
                <span class="label" style="width: 15px;"><img src="https://raw.githubusercontent.com/mmarder96/wild-wasteland-char-sheet/dev/images/money.png" style="width: 15px; margin-bottom: -4px; vertical-align: inherit;"
                    alt="money symbol"></span>
                <input type="text" name="attr_cp" title="@{cp}">
              </div>
            </div>
            <input type="hidden" class="inventoryflag" name="attr_simpleinventory" value="0">
            <textarea class="simple" name="attr_equipment" style="min-height: 500px;"></textarea>
            <div class="complex">
              <input type="hidden" class="warningflag" name="attr_armorwarningflag">
              <div class="warning">
                <span>
                  <label><input type="checkbox" name="attr_armorwarningflag" value="hide">*</label>
                  <span data-i18n="warning-armor-sets-u">
                    WARNING - MULTIPLE SETS OF ARMOR OR SHIELDS HAVE BEEN ADDED AND AC IS NOT CORRECTLY CALCULATED. UNEQUIP THE ARMOR PIECE FROM THE ITEM DETAILS.
                  </span>
                </span>
              </div>
              <input type="hidden" class="warningflag" name="attr_customacwarningflag">
              <div class="warning">
                <span>
                  <label><input type="checkbox" name="attr_customacwarningflag" value="hide">*</label>
                  <span data-i18n="warning-customac-u">
                    ATTENTION - YOUR CUSTOM AC CALCULATION IS NOT BEING USED AS YOU HAVE ARMOR EQUIPPED. IF YOU WANT TO USE YOUR CUSTOM AC, UNEQUIP THE ARMOR PIECE FROM THE ITEM DETAILS.
                  </span>
                </span>
              </div>
              <div class="header" style="height: auto;">
                <span class="pictos" style="width: 25px; font-size: 15px;">*</span>
                <span style="width: 175px; text-align: left;" data-i18n="item-name-u">ITEM NAME</SPAN>
                <span style="width: 25px;"><img src="https://raw.githubusercontent.com/mmarder96/wild-wasteland-char-sheet/dev/images/weight.png" style="width: 15px; margin-bottom: -3px; vertical-align: inherit;"
                    alt="Weight symbol"></span>
              </div>
              <fieldset class="repeating_inventory">
                <input type="hidden" class="equippedflag" name="attr_equipped" value="0">
                <div class="item">
                  <input class="weight" type="text" name="attr_itemcount" value="1">
                  <input class="name" type="text" name="attr_itemname">
                  <input class="weight" type="text" name="attr_itemweight" placeholder="0">
                  <input class="inventorysubflag" type="checkbox" name="attr_inventorysubflag"><span>y</span>
                  <div class="subitem">
                    <input class="equipped" type="checkbox" name="attr_equipped" value="1" checked="checked">
                    <span class="equippedlabel" data-i18n="equipped-u">EQUIPPED</span>
                    <input class="equipped" type="checkbox" name="attr_hasattack" value="1">
                    <span class="equippedlabel" data-i18n="has-attack-u">HAS AN ATTACK</span>
                    <input class="equipped" type="checkbox" name="attr_isweapon" value="1">
                    <span class="equippedlabel" data-i18n="weapon-u">WEAPON</span>
                    <input class="equipped" type="checkbox" name="attr_isarmor" value="1">
                    <span class="equippedlabel" data-i18n="armor-u">ARMOR</span>
                    <input class="equipped" type="checkbox" name="attr_useasresource" value="1">
                    <span class="equippedlabel" data-i18n="use-as-resource-u">USE AS A RESOURCE</span>
                    <span class="label" data-i18n="prop:-u">PROP:</span>
                    <input class="subfield" type="text" name="attr_itemproperties">
                    <span class="label" data-i18n="mods:-u">MODS:</span>
                    <input class="subfield" type="text" name="attr_itemmodifiers">
                    <textarea class="subtextarea" name="attr_itemcontent"></textarea>
                  </div>
                  <!--ATTACK ATTRIBUTES-->
                  <input type="hidden" name="attr_itemattackid">
                  <input type="hidden" name="attr_atk_actioncost">
                  <input type="hidden" name="attr_atk_cooldown">
                  <input type="hidden" name="attr_atk_atkname">
                  <input type="hidden" name="attr_atk_class">
                  <input type="hidden" name="attr_atk_type">
                  <input type="hidden" name="attr_atk_typeflag">
                  <input type="hidden" name="attr_atk_atkflag">
                  <input type="hidden" name="attr_atk_atkbase">
                  <input type="hidden" name="attr_atk_atkattr">
                  <input type="hidden" name="attr_atk_atkskill">
                  <input type="hidden" name="attr_atk_atkrange">
                  <input type="hidden" name="attr_atk_atkcritrange">
                  <input type="hidden" name="attr_atk_dmgflag">
                  <input type="hidden" name="attr_atk_dmgbase">
                  <input type="hidden" name="attr_atk_dmgattr">
                  <input type="hidden" name="attr_atk_dmgskill">
                  <input type="hidden" name="attr_atk_dmgroll">
                  <input type="hidden" name="attr_atk_dmgtype">
                  <input type="hidden" name="attr_atk_dmgcustcrit">
                  <input type="hidden" name="attr_atk_saveflag">
                  <input type="hidden" name="attr_atk_saveattr">
                  <input type="hidden" name="attr_atk_saveattr">
                  <input type="hidden" name="attr_atk_savedc">
                  <input type="hidden" name="attr_atk_saveeffect">
                  <input type="hidden" name="attr_atk_atk_desc">
                  <!--WEAPON ATTRIBUTES-->
                  <input type="hidden" name="attr_itemweaponid">
                  <input type="hidden" name="attr_wpn_wpnname">
                  <input type="hidden" name="attr_wpn_shots">
                  <input type="hidden" name="attr_wpn_type">
                  <input type="hidden" name="attr_wpn_typeflag">
                  <input type="hidden" name="attr_wpn_class">
                  <input type="hidden" name="attr_wpn_magflag">
                  <input type="hidden" name="attr_wpn_mag">
                  <input type="hidden" name="attr_wpn_ammo">
                  <input type="hidden" name="attr_wpn_atkflag">
                  <input type="hidden" name="attr_wpn_atkbase">
                  <input type="hidden" name="attr_wpn_atkattr">
                  <input type="hidden" name="attr_wpn_atkskill">
                  <input type="hidden" name="attr_wpn_atkrange">
                  <input type="hidden" name="attr_wpn_atkcritrange">
                  <input type="hidden" name="attr_wpn_dmgflag">
                  <input type="hidden" name="attr_wpn_dmgbase">
                  <input type="hidden" name="attr_wpn_dmgattr">
                  <input type="hidden" name="attr_wpn_dmgskill">
                  <input type="hidden" name="attr_wpn_dmgroll">
                  <input type="hidden" name="attr_wpn_dmgtype">
                  <input type="hidden" name="attr_wpn_dmgcustcrit">
                  <input type="hidden" name="attr_wpn_properties">
                  <input type="hidden" name="attr_wpn_description">
                  <!--ARMOR ATTRIBUTES-->
                  <input type="hidden" name="attr_itemarmorid">
                  <input type="hidden" name="attr_arm_armorname">
                  <input type="hidden" name="attr_arm_armordt">
                  <input type="hidden" name="attr_arm_type">
                  <input type="hidden" name="attr_arm_armorproperties">
                  <input type="hidden" name="attr_arm_itemmodifiers">
                  <input type="hidden" name="attr_arm_armorcontent">
                  <!--RESOURCE ATTRIBUTES-->
                  <input type="hidden" name="attr_itemresourceid">
                </div>
              </fieldset>
              <div class="weighttotal">
                <span class="label" data-i18n="total-weight-u">TOTAL WEIGHT</span>
                <input type="text" name="attr_weighttotal" value="0" style="width: 45px; float: left;">
                <input type="text" value="/" style="width: 15px; float: left;">
                <input type="text" name="attr_carrying_capacity" value="0" style="width: 45px; float: left;">
                <input type="hidden" name="attr_encumberance_setting" value="0">
                <input type="hidden" class="encumberance" name="attr_encumberance">
                <span class="encumb immobile" data-i18n="immobile-u">IMMOBILE</span>
                <span class="encumb heavily" data-i18n="heavily-encumbered-u">HEAVILY ENCUMBERED</span>
                <span class="encumb encumbered" data-i18n="encumbered-u">ENCUMBERED</span>
                <span class="encumb over" data-i18n="over-encumbered-u">OVER ENCUMBERED</span>
              </div>
            </div>
            <span class="label" style="margin-top: 0px; position:absolute; bottom: 0px;" data-i18n="equipment-u">EQUIPMENT</span>
          </div>
          <div class="textbox traits" style="min-height: 541px; width: 95%;">
            <input type="hidden" class="traitsflag" name="attr_simpletraits" value="0">
            <textarea class="sheet-simple" name="attr_features_and_traits"></textarea>
            <div class="complex">
              <div class="money">
                <div class="coin">
                  <span class="label" style="width: 15px;"><img src="https://raw.githubusercontent.com/mmarder96/wild-wasteland-char-sheet/dev/images/money.png" style="width: 15px; margin-bottom: -4px; vertical-align: inherit;"
                      alt="money symbol"></span>
                  <input type="text" name="attr_cp" title="@{cp}">
                </div>
              </div>
              <button type="action" name="act_switch_page" class="sheet-nextpage" style="background: transparent; border: none; margin-bottom: -3px;">
                <img src="https://raw.githubusercontent.com/mmarder96/wild-wasteland-char-sheet/dev/images/next-page.png" style="width: 20px;" alt="next page"/>
              </button>
              <fieldset class="repeating_traits">
                <div class="trait">
                  <button type="roll" name="roll_output" class="output" value="@{wtype}&{template:traits} @{charname_output} {{name=@{name}}} {{source=@{source}: @{source_type}}} {{description=@{description}}}">w</button>
                  <input class="options-flag" type="checkbox" name="attr_options-flag" checked="checked"><span>y</span>
                  <input class="display-flag" type="checkbox" name="attr_display_flag">
                  <div class="options">
                    <div class="row">
                      <span style="padding-left: 5px;" data-i18n="name:-u">NAME:</span>
                      <input type="text" name="attr_name" style="width: 120px;">
                    </div>
                    <div class="row">
                      <span style="padding-left: 5px;" data-i18n="source:-u">SOURCE:</span>
                      <select name="attr_source">
                        <option selected="selected" data-i18n="racial">Racial</option>
                        <option data-i18n="trait">Trait</option>
                        <option data-i18n="perk" selected="selected">Perk</option>
                        <option data-i18n="background">Background</option>
                        <option data-i18n="other">Other</option>
                      </select>
                    </div>
                    <div class="row">
                      <span style="padding-left: 5px;" data-i18n="source-type:-u">SOURCE TYPE:</span>
                      <input type="text" name="attr_source_type" style="width: 150px;" placeholder="—">
                    </div>
                    <div class="row">
                      <textarea name="attr_description" style="min-height: 200px; height: 200px;"></textarea>
                    </div>
                  </div>
                  <div class="display" style="margin-bottom: 2px;">
                    <span class="title" name="attr_name"></span>
                    <span class="subheader">
                      <span name="attr_source"></span><span>: </span><span name="attr_source_type"></span>
                    </span>
                    <span class="desc" name="attr_description"></span>
                  </div>
                </div>
              </fieldset>
            </div>
            <span class="label" data-i18n="perks-traits-u" style="margin-top: 0px; position: absolute; bottom: 0px;">PERKS & TRAITS</span>
          </div>
          <input type="hidden" class="missing-info-flag" name="attr_missing_info">
          <div class="missing-info">
            <span><span class="info-popup pictos">i</span> Looking for missing data?</span>
            <span class="missing-info-desc">Your data is in the simple version that can be re-enabled from the Settings(gear) tab of the character sheet. Under GENERAL OPTIONS and then FEATS & TRAITS. Set the section to be 'Simple'.</span>
          </div>
        </div>
      </div>
    </div>

    <!--
     ____    _____    ____
    |  _ \  |_   _|  / __ \
    | |_) |   | |   | |  | |
    |  _ <    | |   | |  | |
    | |_) |  _| |_  | |__| |
    |____/  |_____|  \____/
    -->

    <div class="page bio">
      <div class="header">
        <div class="name-container">
          <img src="https://raw.githubusercontent.com/mmarder96/wild-wasteland-char-sheet/dev/images/wild_wasteland_logo.png" style="padding-bottom: 5px; width: 250px" alt="Wild Wasteland Logo">
          <input type="text" name="attr_character_name" style="width: 100%;">
          <span class="label" data-i18n="char-name-u">CHARACTER NAME</span>
        </div>
        <div class="header-info">
          <div class="top" style="position: relative; top: 10px;">
            <div class="hlabel-container">
              <input type="text" name="attr_age" style="width: 120px;">
              <span class="label" data-i18n="age-u">AGE</span>
            </div>
            <div class="hlabel-container">
              <input type="text" name="attr_size" style="width: 120px;">
              <span class="label" data-i18n="size-u">SIZE</span>
            </div>
            <div class="hlabel-container">
              <input type="text" name="attr_height" style="width: 120px;">
              <span class="label" data-i18n="height-u">HEIGHT</span>
            </div>
            <div class="hlabel-container">
              <input type="text" name="attr_weight" style="width: 120px;">
              <span class="label" data-i18n="weight-u">WEIGHT</span>
            </div>
          </div>
          <div class="bottom">
            <div class="hlabel-container">
              <input type="text" name="attr_eyes" style="width: 160px;">
              <span class="label" data-i18n="eye-u">EYES</span>
            </div>
            <div class="hlabel-container">
              <input type="text" name="attr_skin" style="width: 160px;">
              <span class="label" data-i18n="skin-u">SKIN</span>
            </div>
            <div class="hlabel-container">
              <input type="text" name="attr_hair" style="width: 160px;">
              <span class="label" data-i18n="hair-u">HAIR</span>
            </div>
          </div>
        </div>
      </div>
      <div class="body">
        <div class="col col1">
          <div class="textbox">
            <textarea name="attr_character_appearance" style="min-height: 300px; height: 300px;"></textarea>
            <span class="label" data-i18n="char-appearance-u">CHARACTER APPEARANCE</span>
          </div>
          <div class="textbox">
            <textarea name="attr_character_backstory" style="min-height: 623px; height: 623px;"></textarea>
            <span class="label" data-i18n="char-backstory-u">CHARACTER BACKSTORY</span>
          </div>
        </div>
        <div class="col2-3">
          <div class="textbox">
            <textarea name="attr_allies_and_organizations" style="min-height: 288px; height: 300px;"></textarea>
            <span class="label" data-i18n="allies-orgs-u">ALLIES & ORGANIZATIONS</span>
          </div>
          <div class="textbox">
            <textarea name="attr_additional_feature_and_traits" style="min-height: 289px; height: 300px;"></textarea>
            <span class="label" data-i18n="add-perks-traits-u">ADDITIONAL PERKS & TRAITS</span>
          </div>
          <div class="textbox">
            <textarea name="attr_treasure" style="min-height: 300px; height: 300px;"></textarea>
            <span class="label" data-i18n="treasure-u">TREASURE</span>
          </div>
        </div>
      </div>
    </div>

    <!--
      ____    _____    _______   _____    ____    _   _    _____
     / __ \  |  __ \  |__   __| |_   _|  / __ \  | \ | |  / ____|
    | |  | | | |__) |    | |      | |   | |  | | |  \| | | (___
    | |  | | |  ___/     | |      | |   | |  | | | . ` |  \___ \
    | |__| | | |         | |     _| |_  | |__| | | |\  |  ____) |
     \____/  |_|         |_|    |_____|  \____/  |_| \_| |_____/
    -->

    <div class="page options">
      <div class="header">
        <div class="name-container">
          <img src="https://raw.githubusercontent.com/mmarder96/wild-wasteland-char-sheet/dev/images/wild_wasteland_logo.png" style="padding-bottom: 5px; width: 250px" alt="Wild Wasteland Logo">
          <input type="text" name="attr_character_name" style="width: 100%;">
          <span class="label" data-i18n="char-name-u">CHARACTER NAME</span>
        </div>
        <div class="header-info sheet-display">
          <div class="top">
            <div class="hlabel-container">
              <input type="number" name="attr_base_level" class="sheet-no_events">
              <span class="label" data-i18n="lvl-u">LEVEL</span>
            </div>
            <div class="hlabel-container" style="position: relative;">
              <input type="number" name="attr_experience" step="1" min="0">
              <span class="label" data-i18n="exp-pts-u">EXPERIENCE POINTS</span>
            </div>
          </div>
          <div class="bottom">
            <div class="hlabel-container">
              <input type="text" name="attr_race" class="sheet-no_events">
              <span class="label" data-i18n="race-u">RACE</span>
            </div>
            <div class="hlabel-container">
              <input type="text" name="attr_alignment">
              <span class="label" data-i18n="alignment-u">ALIGNMENT</span>
            </div>
          </div>
        </div>
        </div>
      <div class="body">
        <div class="col col1">
          <div class="general_options">
            <div class="version">
              <span data-i18n="version">v</span>
              <input type="text" name="attr_version">
            </div>
            <div class="row">
              <input type="checkbox" name="attr_npc" value="1">
              <span data-i18n="npc-u">NPC</span>
            </div>
            <div class="row">
              <input type="checkbox" name="attr_charname_output" value="{{charname=@{character_name}}}" checked>
              <span data-i18n="add-char-to-templates-u">ADD CHARACTER NAME TO TEMPLATES</span>
              <!-- <select class="dtype" name="attr_charname_output">
                <option value="{{charname=@{character_name}}}" selected="selected" data-i18n="on">On</option>
                <option value="charname=@{character_name}" data-i18n="off">Off</option>
              </select> -->
            </div>
            <div class="row">
              <input type="checkbox" name="attr_ammotracking" value="1">
              <span data-i18n="ammo-tracking-u">AMMO TRACKING</span>
              <!-- <select name="attr_ammotracking">
                <option value="on" data-i18n="on">On</option>
                <option value="off" selected="selected" data-i18n="off">Off</option>
              </select> -->
              <span data-i18n-title="api-required-title" data-i18n="api-required-u" title="Try it now with easy one click API installation available with your Pro subscription." style="color:#666; cursor:help;">(API REQUIRED)</span>
            </div>
            <div class="row">
              <input type="checkbox" name="attr_exhaustion_toggle" value="1" checked>
              <span data-i18n="exhaustion-setting-u">SHOW EXHAUSTION TRACKING</span>
            </div>
            <div class="row">
              <input type="checkbox" name="attr_radiation_toggle" value="1" checked>
              <span data-i18n="radiation-setting-u">SHOW RADIATION TRACKING</span>
            </div>
            <!-- <div class="row">
              <span data-i18n="core-die-roll:-u">CORE DIE ROLL:</span>
              <input type="text" name="attr_core_die" value="1d20" placeholder="1d20" title="@{core_die}">
            </div> -->
            <!-- <div class="row">
              <span data-i18n="tag-bonus:-u">TAG SKILL BONUS:</span>
              <select class="dtype" name="attr_pb_type">
                <option value="level" data-i18n="by-level">By Level (Default)</option>
                <option value="die" data-i18n="prof-die">Proficency Die (DMG)</option>
                <option value="custom" data-i18n="custom">Custom</option>
              </select>
              <input type="hidden" name="attr_pb_type">
              <input class="pb_custom" type="text" style="float:right;" name="attr_pb_custom" placeholder="2d10">
            </div> -->
            <div class="row">
              <input type="checkbox" name="attr_global_attack_mod_flag" value="1">
              <span data-i18n="show-global-attack-field-u">SHOW GLOBAL ATTACK MODIFIER FIELD</span>
            </div>
            <div class="row">
              <input type="checkbox" name="attr_dtype" value="1">
              <span data-i18n="auto-dmg-roll-u">AUTO DAMAGE ROLL</span>
              <!-- <select class="dtype" name="attr_dtype">
                <option value="pick" data-i18n="never-roll-dmg">Don't Auto Roll Damage</option>
                <option value="full" data-i18n="always-roll-dmg">Auto Roll Damage & Crit</option>
              </select> -->
            </div>
            <!-- <div class="row">
              <input type="checkbox" name="attr_level_calculations" value="1">
              <span data-i18n="level-calculations:-u">AUTO LEVEL CALCULATIONS</span>
              <select class="dtype" name="attr_level_calculations">
                <option value="on" selected="selected" data-i18n="on">On</option>
                <option value="off" data-i18n="off">Off</option>
              </select>
            </div> -->
            <div class="row">
              <input type="checkbox" name="attr_encumberance_setting" value="1">
              <span data-i18n="advanced-encumbrance-u">ADVANCED ENCUMBRANCE</span>
            </div>
            <div class="row">
              <input type="checkbox" name="attr_simpletraits" value="1">
              <span data-i18n="simple-perks-traits-u">SIMPLE PERKS & TRAITS</span>
            </div>
            <div class="row">
              <input type="checkbox" name="attr_simpleattacks" value="1">
              <span data-i18n="simple-attacks-u">SIMPLE ATTACKS</span>
            </div>
            <div class="row">
              <input type="checkbox" name="attr_simpleweapons" value="1">
              <span data-i18n="simple-weapons-u">SIMPLE WEAPONS</span>
            </div>
            <div class="row">
              <input type="checkbox" name="attr_simplearmor" value="1">
              <span data-i18n="simple-armor-u">SIMPLE ARMOR</span>
            </div>
            <div class="row">
              <input type="checkbox" name="attr_simpleinventory" value="1">
              <span data-i18n="simple-inventory-u">SIMPLE INVENTORY</span>
            </div>
            <div class="row">
              <input type="checkbox" name="attr_simplemods" value="1">
              <span data-i18n="simple-custom-mods-u">SIMPLE CUSTOM MODS</span>
            </div>
            <div class="row title">
              <span data-i18n="general-opts-u">GENERAL OPTIONS</span>
            </div>
          </div>
          <div class="attribute_options" style="width: 234px;">
            <div class="row skill">
              <span data-i18n="strength-u">STRENGTH</span>
              <span>+</span><input type="text" class="num" name="attr_strength_bonus" value="0" placeholder="0" title="@{strength_bonus}">
            </div>
            <div class="row skill">
              <span data-i18n="perception-u">PERCEPTION</span>
              <span>+</span><input type="text" class="num" name="attr_perception_bonus" value="0" placeholder="0" title="@{perception_bonus}">
            </div>
            <div class="row skill">
              <span data-i18n="endurance-u">ENDURANCE</span>
              <span>+</span><input type="text" class="num" name="attr_endurance_bonus" value="0" placeholder="0" title="@{endurance_bonus}">
            </div>
            <div class="row skill">
              <span data-i18n="charisma-u">CHARISMA</span>
              <span>+</span><input type="text" class="num" name="attr_charisma_bonus" value="0" placeholder="0" title="@{charisma_bonus}">
            </div>
            <div class="row skill">
              <span data-i18n="intelligence-u">INTELLIGENCE</span>
              <span>+</span><input type="text" class="num" name="attr_intelligence_bonus" value="0" placeholder="0" title="@{intelligence_bonus}">
            </div>
            <div class="row skill">
              <span data-i18n="agility-u">AGILITY</span>
              <span>+</span><input type="text" class="num" name="attr_agility_bonus" value="0" placeholder="0" title="@{agility_bonus}">
            </div>
            <div class="row skill">
              <span data-i18n="luck-u">LUCK</span>
              <span>+</span><input type="text" class="num" name="attr_luck_bonus" value="0" placeholder="0" title="@{luck_bonus}">
            </div>
            <div class="row">
              <input type="checkbox" name="attr_init_tiebreaker" value="@{agility}/100">
              <span data-i18n="add-agl-tiebreaker-u">ADD AGL TIEBREAKER TO INITIATIVE</span>
            </div>
            <div class="row">
              <span data-i18n="initiative-style:-u">INITIATIVE STYLE:</span>
              <select name="attr_initiative_style">
                <option value="@{d20}" selected="selected" data-i18n="norm">Normal</option>
                <option value="{@{d20},@{d20}}kh1" data-i18n="adv">Advantage</option>
                <option value="{@{d20},@{d20}}kl1" data-i18n="disadv">Disadvantage</option>
              </select>
            </div>
            <div class="row">
              <span data-i18n="initiative-mod:-u">INITIATIVE MODIFIER:</span>
              <input type="text" class="num" name="attr_initmod" placeholder="x2">
            </div>
            <div class="row">
              <span data-i18n="pass-perc-mod:-u">PASSIVE PERCEPTION MODIFIER:</span>
              <input type="text" class="num" name="attr_passive_perception_mod" placeholder="x2">
            </div>
            <div class="row">
              <span data-i18n="critical-strike-mod:-u">CRITICAL STRIKE MODIFIER:</span>
              <input type="text" class="num" name="attr_critical_strike_mod" placeholder="x2">
            </div>
            <div class="row">
              <span data-i18n="carrying-capacity-mod:-u">CARRYING CAPACITY MODIFIER:</span>
              <input type="text" class="num" name="attr_carrying_capacity_mod" placeholder="x2">
            </div>
            <div class="row title">
              <span data-i18n="attribute-opts-u">ATTRIBUTE OPTIONS</span>
            </div>
          </div>
        </div>
        <div class="col col2">
          <div class="skill_options" style="width: 234px;">
            <div data-i18n-list="skills-list">
              <div class="row skill" data-i18n-list-item="barter">
                <span data-i18n="barter-core">Barter <span>[CHA]</span></span>
                <span>+</span><input type="text" class="num" name="attr_barter_flat" value="0" placeholder="0" title="@{barter_flat}">
              </div>
              <div class="row skill" data-i18n-list-item="energy_weapons">
                <span data-i18n="energy_weapons-core">Energy Weapons <span>[PER]</span></span>
                <span>+</span><input type="text" class="num" name="attr_energy_weapons_flat" value="0" placeholder="0" title="@{energy_weapons_flat}">
              </div>
              <div class="row skill" data-i18n-list-item="explosives">
                <span data-i18n="explosives-core">Explosives</span>
                <span>+</span><input type="text" class="num" name="attr_explosives_flat" value="0" placeholder="0" title="@{explosives_flat}">
              </div>
              <div class="row skill" data-i18n-list-item="guns">
                <span data-i18n="guns-core">Guns</span>
                <span>+</span><input type="text" class="num" name="attr_guns_flat" value="0" placeholder="0" title="@{guns_flat}">
              </div>
              <div class="row skill" data-i18n-list-item="lockpick">
                <span data-i18n="lockpick-core">Lockpick</span>
                <span>+</span><input type="text" class="num" name="attr_lockpick_flat" value="0" placeholder="0" title="@{lockpick_flat}">
              </div>
              <div class="row skill" data-i18n-list-item="medicine">
                <span data-i18n="medicine-core">Medicine</span>
                <span>+</span><input type="text" class="num" name="attr_medicine_flat" value="0" placeholder="0" title="@{medicine_flat}">
              </div>
              <div class="row skill" data-i18n-list-item="melee_weapons">
                <span data-i18n="melee_weapons-core">Melee Weapons</span>
                <span>+</span><input type="text" class="num" name="attr_melee_weapons_flat" value="0" placeholder="0" title="@{melee_weapons_flat}">
              </div>
              <div class="row skill" data-i18n-list-item="repair">
                <span data-i18n="repair-core">Repair</span>
                <span>+</span><input type="text" class="num" name="attr_repair_flat" value="0" placeholder="0" title="@{repair_flat}">
              </div>
              <div class="row skill" data-i18n-list-item="science">
                <span data-i18n="science-core">Science</span>
                <span>+</span><input type="text" class="num" name="attr_science_flat" value="0" placeholder="0" title="@{science_flat}">
              </div>
              <div class="row skill" data-i18n-list-item="sneak">
                <span data-i18n="sneak-core">Sneak</span>
                <span>+</span><input type="text" class="num" name="attr_sneak_flat" value="0" placeholder="0" title="@{sneak_flat}">
              </div>
              <div class="row skill" data-i18n-list-item="speech">
                <span data-i18n="speech-core">Speech</span>
                <span>+</span><input type="text" class="num" name="attr_speech_flat" value="0" placeholder="0" title="@{speech_flat}">
              </div>
              <div class="row skill" data-i18n-list-item="survival">
                <span data-i18n="survival-core">Survival</span>
                <span>+</span><input type="text" class="num" name="attr_survival_flat" value="0" placeholder="0" title="@{survival_flat}">
              </div>
              <div class="row skill" data-i18n-list-item="unarmed">
                <span data-i18n="unarmed-core">Unarmed</span>
                <span>+</span><input type="text" class="num" name="attr_unarmed_flat" value="0" placeholder="0" title="@{unarmed_flat}">
              </div>
            </div>
            <div class="row" style="margin-top:10px;">
              <span data-i18n="tag-skill-mod:-u">TAG SKILL BONUS MODIFIER:</span>
              <input type="text" class="num" name="attr_tag_skill_mod" placeholder="0" value="0">
            </div>
            <!-- <div class="row" style="margin-top:10px;">
              <input type="checkbox" name="attr_jack_of_all_trades" value="@{jack}">
              <span data-i18n="jack-of-all-u">JACK OF ALL TRADES</span>
            </div> -->
            <div class="row title">
              <span data-i18n="skill-opts-u">SKILL OPTIONS</span>
            </div>
          </div>
          <div class="save_options" style="width: 234px;">
            <div class="row skill">
              <span data-i18n="strength-save-u">Strength Save</span>
              <span>+</span><input type="text" class="num" name="attr_strength_save_mod" value="0" placeholder="0" title="@{strength_save_mod}">
            </div>
            <div class="row skill">
              <span data-i18n="perception-save-u">Perception Save</span>
              <span>+</span><input type="text" class="num" name="attr_perception_save_mod" value="0" placeholder="0" title="@{perception_save_mod}">
            </div>
            <div class="row skill">
              <span data-i18n="endurance-save-u">Endurance Save</span>
              <span>+</span><input type="text" class="num" name="attr_endurance_save_mod" value="0" placeholder="0" title="@{endurance_save_mod}">
            </div>
            <div class="row skill">
              <span data-i18n="charisma-save-u">Charisma Save</span>
              <span>+</span><input type="text" class="num" name="attr_charisma_save_mod" value="0" placeholder="0" title="@{charisma_save_mod}">
            </div>
            <div class="row skill">
              <span data-i18n="intelligence-save-u">Intelligence Save</span>
              <span>+</span><input type="text" class="num" name="attr_intelligence_save_mod" value="0" placeholder="0" title="@{intelligence_save_mod}">
            </div>
            <div class="row skill">
              <span data-i18n="agility-save-u">Agility Save</span>
              <span>+</span><input type="text" class="num" name="attr_agility_save_mod" value="0" placeholder="0" title="@{agility_save_mod}">
            </div>
            <div class="row skill">
              <span data-i18n="luck-save-u">Luck Save</span>
              <span>+</span><input type="text" class="num" name="attr_luck_save_mod" value="0" placeholder="0" title="@{luck_save_mod}">
            </div>
            <div class="row">
              <span data-i18n="death-save-mod:-u">DEATH SAVE MODIFIER:</span>
              <input type="text" class="num" name="attr_death_save_mod" placeholder="@{luck_save_mod}" value="0">
            </div>
            <div class="row" style="padding-top: 7px;">
              <span data-i18n="glob-saving-mod:-u">GLOBAL SAVING THROW MODIFIER:</span>
              <input type="text" class="num" name="attr_global_save_mod" placeholder="0" value="0">
            </div>
            <div class="row title">
              <span data-i18n="save-opts-u">SAVE OPTIONS</span>
            </div>
          </div>
        </div>
        <div class="col col3">
          <div class="attribute_options" style="width: 234px; min-height: 523px">
            <div class="row">
              <span data-i18n="critrangemods:-u">CRIT RANGE MODIFIERS:</span>
            </div>
            <fieldset class="repeating_critrangemod">
              <div style="padding-left: 15px; padding-bottom: 5px;">
                <span data-i18n="source:-u">SOURCE:</span>
                <input type="text" name="attr_source" style="width: 100px;">
                <span data-i18n="mod:-u">MOD:</span>
                <input type="text" name="attr_mod" class="num">
              </div>
            </fieldset>
            <div class="row">
              <span data-i18n="critfailmods:-u">CRIT FAIL MODIFIERS:</span>
            </div>
            <fieldset class="repeating_critfailmod">
              <div style="padding-left: 15px; padding-bottom: 5px;">
                <span data-i18n="source:-u">SOURCE:</span>
                <input type="text" name="attr_source" style="width: 100px;">
                <span data-i18n="mod:-u">MOD:</span>
                <input type="text" name="attr_mod" class="num">
              </div>
            </fieldset>
            <div class="row">
              <span data-i18n="hpmods:-u">HP MODIFIERS:</span>
            </div>
            <fieldset class="repeating_hpmod">
              <div style="padding-left: 15px; padding-bottom: 5px;">
                <span data-i18n="source:-u">SOURCE:</span>
                <input type="text" name="attr_source" style="width: 100px;">
                <span data-i18n="mod:-u">MOD:</span>
                <input type="text" name="attr_mod" class="num">
              </div>
            </fieldset>
            <div class="row">
              <span data-i18n="defmods:-u">DEFENSE MODIFIERS:</span>
            </div>
            <fieldset class="repeating_defmod">
              <div style="padding-left: 15px; padding-bottom: 5px;">
                <span data-i18n="source:-u">SOURCE:</span>
                <input type="text" name="attr_source" style="width: 100px;">
                <span data-i18n="mod:-u">MOD:</span>
                <input type="text" name="attr_mod" class="num">
              </div>
            </fieldset>
            <div class="row">
              <span data-i18n="dtmods:-u">DT MODIFIERS:</span>
            </div>
            <fieldset class="repeating_dtmod">
              <div style="padding-left: 15px; padding-bottom: 5px;">
                <span data-i18n="source:-u">SOURCE:</span>
                <input type="text" name="attr_source" style="width: 100px;">
                <span data-i18n="mod:-u">MOD:</span>
                <input type="text" name="attr_mod" class="num">
              </div>
            </fieldset>
            <div class="row">
              <span data-i18n="spdmods:-u">SPEED MODIFIERS:</span>
            </div>
            <fieldset class="repeating_spdmod">
              <div style="padding-left: 15px; padding-bottom: 5px;">
                <span data-i18n="source:-u">SOURCE:</span>
                <input type="text" name="attr_source" style="width: 100px;">
                <span data-i18n="mod:-u">MOD:</span>
                <input type="text" name="attr_mod" class="num">
              </div>
            </fieldset>
            <div class="row title">
              <span data-i18n="secondary-attribute-opts-u">SECONDARY ATTRIBUTE OPTIONS</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!--
     ______    ____     ____    _______   ______   _____
    |  ____|  / __ \   / __ \  |__   __| |  ____| |  __ \
    | |__    | |  | | | |  | |    | |    | |__    | |__) |
    |  __|   | |  | | | |  | |    | |    |  __|   |  _  /
    | |      | |__| | | |__| |    | |    | |____  | | \ \
    |_|       \____/   \____/     |_|    |______| |_|  \_\
    -->

    <div class="footer">
      <div style="margin-right: 50px; margin-left: 10px;">
        <span data-i18n="portions-sheet-utilize">
          Portions of this sheet utilize content from the System Reference Document 5.0 under the OGL License. View OGL License and Copyright Notice. https://wiki.roll20.net/SRD_5.0_OGL_License
        </span>
      </div>
      <div>
        <span data-i18n="footer-wiki-link">
          For more information about this character sheet, its functionality, or uses, please check out the Roll20 Wiki for official documentation. https://wiki.roll20.net/5th_Edition_OGL_by_Roll20
        </span>
      </div>
    </div>

    <!--
     _____  _____   ____  _____     _____       _______ _____ _    _ ______ _____   _____
    |  __ \|  __ \ / __ \|  __ \   / ____|   /\|__   __/ ____| |  | |  ____|  __ \ / ____|
    | |  | | |__) | |  | | |__) | | |       /  \  | | | |    | |__| | |__  | |__) | (___
    | |  | |  _  /| |  | |  ___/  | |      / /\ \ | | | |    |  __  |  __| |  _  / \___ \
    | |__| | | \ \| |__| | |      | |____ / ____ \| | | |____| |  | | |____| | \ \ ____) |
    |_____/|_|  \_\\____/|_|       \_____/_/    \_\_|  \_____|_|  |_|______|_|  \_\_____/
    -->

    <input type="hidden" name="attr_drop_category" accept="Category">
    <input type="hidden" name="attr_drop_name" accept="Name">
    <input type="hidden" name="attr_drop_data" accept="data">
    <input type="hidden" name="attr_drop_content" accept="Content">

  </div>

</div> <!-- licensecontainer div close -->

<!--

$$\   $$\ $$$$$$\ $$$$$$$\  $$$$$$$\  $$$$$$$$\ $$\   $$\       $$$$$$$$\ $$$$$$\ $$$$$$$$\ $$\       $$$$$$$\   $$$$$$\
$$ |  $$ |\_$$  _|$$  __$$\ $$  __$$\ $$  _____|$$$\  $$ |      $$  _____|\_$$  _|$$  _____|$$ |      $$  __$$\ $$  __$$\
$$ |  $$ |  $$ |  $$ |  $$ |$$ |  $$ |$$ |      $$$$\ $$ |      $$ |        $$ |  $$ |      $$ |      $$ |  $$ |$$ /  \__|
$$$$$$$$ |  $$ |  $$ |  $$ |$$ |  $$ |$$$$$\    $$ $$\$$ |      $$$$$\      $$ |  $$$$$\    $$ |      $$ |  $$ |\$$$$$$\
$$  __$$ |  $$ |  $$ |  $$ |$$ |  $$ |$$  __|   $$ \$$$$ |      $$  __|     $$ |  $$  __|   $$ |      $$ |  $$ | \____$$\
$$ |  $$ |  $$ |  $$ |  $$ |$$ |  $$ |$$ |      $$ |\$$$ |      $$ |        $$ |  $$ |      $$ |      $$ |  $$ |$$\   $$ |
$$ |  $$ |$$$$$$\ $$$$$$$  |$$$$$$$  |$$$$$$$$\ $$ | \$$ |      $$ |      $$$$$$\ $$$$$$$$\ $$$$$$$$\ $$$$$$$  |\$$$$$$  |
\__|  \__|\______|\_______/ \_______/ \________|\__|  \__|      \__|      \______|\________|\________|\_______/  \______/

-->

<input type="hidden" name="attr_d20" value="1d20cs>20">
<input type="hidden" name="attr_critrange" value="20">
<input type="hidden" name="attr_critfail" value="1">
<input type="hidden" name="attr_rtype" value="@{advantagetoggle}">
<input type="hidden" name="attr_level" value="0">
<input type="hidden" name="attr_pb" value="1">
<input type="hidden" name="attr_pbd_safe" value="">
<input type="hidden" name="attr_jack" value="1">
<input type="hidden" name="attr_jack_attr" value="">
<input type="hidden" name="attr_jack_bonus" value="">
<input type="hidden" name="attr_passive_perception" value="10">
<input type="hidden" name="attr_critical_strike" value="10">
<input type="hidden" name="attr_defense" value="10">
<input type="hidden" name="attr_hitdie_final" value="">
<input type="hidden" name="attr_globalsavingthrowbonus" value="">
<input type="hidden" name="attr_death_save_bonus" value="0">
<input type="hidden" name="attr_initiative_bonus" value="0">
<input type="hidden" name="attr_spell_save_dc" value="0">
<input type="hidden" name="attr_spell_attack_bonus" value="0">
<input type="hidden" name="attr_spell_attack_mod" value="0">
<input type="hidden" name="attr_npc_legendary_actions_desc" value="">
<input type="hidden" name="attr_global_damage_mod_crit" value="0">
<input type="hidden" name="attr_global_damage_mod_roll" value="0">
<input type="hidden" name="attr_global_damage_mod_type" value="">
<input type="hidden" name="attr_global_mods" value="">
<input type="hidden" name="attr_global_attack_mod" value="">
<input type="hidden" name="attr_global_save_mod" value="">
<input type="hidden" name="attr_global_skill_mod" value="">

<input type="hidden" name="attr_exhaustion_1" value="">
<input type="hidden" name="attr_exhaustion_2" value="">
<input type="hidden" name="attr_exhaustion_3" value="">
<input type="hidden" name="attr_exhaustion_4" value="">
<input type="hidden" name="attr_exhaustion_5" value="">
<input type="hidden" name="attr_exhaustion_6" value="">

<input type="hidden" name="attr_radiation_1" value="">
<input type="hidden" name="attr_radiation_2" value="">
<input type="hidden" name="attr_radiation_3" value="">
<input type="hidden" name="attr_radiation_4" value="">
<input type="hidden" name="attr_radiation_5" value="">
<input type="hidden" name="attr_radiation_6" value="">

<input type="hidden" name="attr_strength_mod" value="0">
<input type="hidden" name="attr_perception_mod" value="0">
<input type="hidden" name="attr_endurance_mod" value="0">
<input type="hidden" name="attr_charisma_mod" value="0">
<input type="hidden" name="attr_intelligence_mod" value="0">
<input type="hidden" name="attr_agility_mod" value="0">
<input type="hidden" name="attr_luck_mod" value="0">

<input type="hidden" name="attr_strength_save_bonus" value="0">
<input type="hidden" name="attr_perception_save_bonus" value="0">
<input type="hidden" name="attr_endurance_save_bonus" value="0">
<input type="hidden" name="attr_charisma_save_bonus" value="0">
<input type="hidden" name="attr_intelligence_save_bonus" value="0">
<input type="hidden" name="attr_agility_save_bonus" value="0">
<input type="hidden" name="attr_luck_save_bonus" value="0">

<input type="hidden" name="attr_strength_maximum" value="30">
<input type="hidden" name="attr_perception_maximum" value="30">
<input type="hidden" name="attr_endurance_maximum" value="30">
<input type="hidden" name="attr_constitution_maximum" value="30">
<input type="hidden" name="attr_intelligence_maximum" value="30">
<input type="hidden" name="attr_agility_maximum" value="30">
<input type="hidden" name="attr_luck_maximum" value="30">

<input type='hidden' name='attr_barter_bonus' value='0'>
<input type='hidden' name='attr_energy_weapons_bonus' value='0'>
<input type='hidden' name='attr_explosives_bonus' value='0'>
<input type='hidden' name='attr_guns_bonus' value='0'>
<input type='hidden' name='attr_lockpick_bonus' value='0'>
<input type='hidden' name='attr_medicine_bonus' value='0'>
<input type='hidden' name='attr_melee_weapons_bonus' value='0'>
<input type='hidden' name='attr_repair_bonus' value='0'>
<input type='hidden' name='attr_science_bonus' value='0'>
<input type='hidden' name='attr_sneak_bonus' value='0'>
<input type='hidden' name='attr_speech_bonus' value='0'>
<input type='hidden' name='attr_survival_bonus' value='0'>
<input type='hidden' name='attr_unarmed_bonus' value='0'>

<input type='hidden' name='attr_barter_check_bonus' value='0'>
<input type='hidden' name='attr_energy_weapons_check_bonus' value='0'>
<input type='hidden' name='attr_explosives_check_bonus' value='0'>
<input type='hidden' name='attr_guns_check_bonus' value='0'>
<input type='hidden' name='attr_lockpick_check_bonus' value='0'>
<input type='hidden' name='attr_medicine_check_bonus' value='0'>
<input type='hidden' name='attr_melee_weapons_check_bonus' value='0'>
<input type='hidden' name='attr_repair_check_bonus' value='0'>
<input type='hidden' name='attr_science_check_bonus' value='0'>
<input type='hidden' name='attr_sneak_check_bonus' value='0'>
<input type='hidden' name='attr_speech_check_bonus' value='0'>
<input type='hidden' name='attr_survival_check_bonus' value='0'>
<input type='hidden' name='attr_unarmed_check_bonus' value='0'>

<input type='hidden' name='attr_l1mancer_status' value=''>
<input type='hidden' name='attr_lpmancer_status' value=''>

<div class="compendium_warning">
  <span data-i18n="accepting-drop-u">ACCEPTING DROP FROM COMPENDIUM</span>
</div>

<div class="monster_confirm">
  <span data-i18n="are_you_sure">Are you sure you want to turn this character into a </span><span name="attr_drop_name"></span><span>?</span>
  <div style="margin-top: 20px;">
    <div style="position: relative; display: inline-block; margin-right: 25px;">
      <input class="yes" type="checkbox" name="attr_confirm"><span class="yes" data-i18n="yes">Yes</span>
    </div>
    <div style="position: relative; display: inline-block;">
      <input class="cancel" type="checkbox" name="attr_cancel"><span class="cancel" data-i18n="cancel">Cancel</span>
    </div>
  </div>
</div>

<div class="mancer_confirm">
  <span style="line-height: 25px" data-i18n="do_you_want_mancer">How do you want to create this character?</span>
  <div style="margin-top: 20px;">
    <div style="position: relative; display: inline-block; width:130px;">
      <input class="yes" type="checkbox" style="width:130px;" name="attr_mancer_confirm"><span class="yes" style="width:130px;" data-i18n="mancer-confirm-yes">Use the Charactermancer</span>
    </div>
    <div style="position: relative; display: inline-block; width:80px;">
      <input class="yes" style="width:80px;" type="checkbox" name="attr_mancer_npc"><span class="yes" style="width:80px;" data-i18n="npc-new">Create an NPC</span>
    </div>
    <div style="position: relative; display: inline-block; width:90px;">
      <input class="yes" type="checkbox" style="width:90px;" name="attr_mancer_cancel"><span class="yes" style="width:90px;" data-i18n="manual">Edit sheet direclty</span>
    </div>
  </div>
</div>

<!--

$$$$$$$\   $$$$$$\  $$\       $$\             $$$$$$$$\ $$$$$$$$\ $$\      $$\ $$$$$$$\  $$\        $$$$$$\ $$$$$$$$\ $$$$$$$$\  $$$$$$\
$$  __$$\ $$  __$$\ $$ |      $$ |            \__$$  __|$$  _____|$$$\    $$$ |$$  __$$\ $$ |      $$  __$$\\__$$  __|$$  _____|$$  __$$\
$$ |  $$ |$$ /  $$ |$$ |      $$ |               $$ |   $$ |      $$$$\  $$$$ |$$ |  $$ |$$ |      $$ /  $$ |  $$ |   $$ |      $$ /  \__|
$$$$$$$  |$$ |  $$ |$$ |      $$ |               $$ |   $$$$$\    $$\$$\$$ $$ |$$$$$$$  |$$ |      $$$$$$$$ |  $$ |   $$$$$\    \$$$$$$\
$$  __$$< $$ |  $$ |$$ |      $$ |               $$ |   $$  __|   $$ \$$$  $$ |$$  ____/ $$ |      $$  __$$ |  $$ |   $$  __|    \____$$\
$$ |  $$ |$$ |  $$ |$$ |      $$ |               $$ |   $$ |      $$ |\$  /$$ |$$ |      $$ |      $$ |  $$ |  $$ |   $$ |      $$\   $$ |
$$ |  $$ | $$$$$$  |$$$$$$$$\ $$$$$$$$\          $$ |   $$$$$$$$\ $$ | \_/ $$ |$$ |      $$$$$$$$\ $$ |  $$ |  $$ |   $$$$$$$$\ \$$$$$$  |
\__|  \__| \______/ \________|\________|         \__|   \________|\__|     \__|\__|      \________|\__|  \__|  \__|   \________| \______/

-->

<div class="rolltemplates">
    <rolltemplate class="sheet-rolltemplate-simple">
        <div class="container">
            <div class="result">
                {{#always}}
                    <div class="adv">
                        <span>{{r1}}{{#global}} + {{global}}{{/global}}</span>
                    </div>
                    <div class="advspacer"></div>
                    <div class="adv">
                        <span>{{r2}}{{#global}} + {{global}}{{/global}}</span>
                    </div>
                {{/always}}
                {{#normal}}
                    <div class="solo">
                        <span>{{r1}}{{#global}} + {{global}}{{/global}}</span>
                    </div>
                {{/normal}}
                {{#advantage}}
                    {{#rollLess() r1 r2}}
                        <div class="adv">
                            <span class="grey">{{r1}}{{#global}} + {{global}}{{/global}}</span>
                        </div>
                        <div class="advspacer"></div>
                        <div class="adv">
                            <span>{{r2}}{{#global}} + {{global}}{{/global}}</span>
                        </div>
                    {{/rollLess() r1 r2}}
                    {{#rollTotal() r1 r2}}
                        <div class="adv">
                            <span>{{r1}}{{#global}} + {{global}}{{/global}}</span>
                        </div>
                        <div class="advspacer"></div>
                        <div class="adv">
                            <span>{{r2}}{{#global}} + {{global}}{{/global}}</span>
                        </div>
                    {{/rollTotal() r1 r2}}
                    {{#rollGreater() r1 r2}}
                        <div class="adv">
                            <span>{{r1}}{{#global}} + {{global}}{{/global}}</span>
                        </div>
                        <div class="advspacer"></div>
                        <div class="adv">
                            <span class="grey">{{r2}}{{#global}} + {{global}}{{/global}}</span>
                        </div>
                    {{/rollGreater() r1 r2}}
                {{/advantage}}
                {{#disadvantage}}
                    {{#rollLess() r1 r2}}
                        <div class="adv">
                            <span>{{r1}}{{#global}} + {{global}}{{/global}}</span>
                        </div>
                        <div class="advspacer"></div>
                        <div class="adv">
                            <span class="grey">{{r2}}{{#global}} + {{global}}{{/global}}</span>
                        </div>
                    {{/rollLess() r1 r2}}
                    {{#rollTotal() r1 r2}}
                        <div class="adv">
                            <span>{{r1}}{{#global}} + {{global}}{{/global}}</span>
                        </div>
                        <div class="advspacer"></div>
                        <div class="adv">
                            <span>{{r2}}{{#global}} + {{global}}{{/global}}</span>
                        </div>
                    {{/rollTotal() r1 r2}}
                    {{#rollGreater() r1 r2}}
                        <div class="adv">
                            <span class="grey">{{r1}}{{#global}} + {{global}}{{/global}}</span>
                        </div>
                        <div class="advspacer"></div>
                        <div class="adv">
                            <span>{{r2}}{{#global}} + {{global}}{{/global}}</span>
                        </div>
                    {{/rollGreater() r1 r2}}
                {{/disadvantage}}
            </div>
            <div class="label">
                <span>{{rname}}{{#mod}} <span>({{mod}})</span>{{/mod}}</span>
            </div>
            {{#charname}}
                <div class="charname">
                    <span>{{charname}}</span>
                </div>
            {{/charname}}
        </div>
    </rolltemplate>

    <rolltemplate class="sheet-rolltemplate-atk">
        <div class="container">
            <div class="result">
                {{#always}}
                    <div class="adv">
                        <span>{{r1}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
                    </div>
                    <div class="advspacer"></div>
                    <div class="adv">
                        <span>{{r2}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
                    </div>
                {{/always}}
                {{#normal}}
                    <div class="solo">
                        <span>{{r1}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
                    </div>
                {{/normal}}
                {{#advantage}}
                    {{#rollLess() r1 r2}}
                        <div class="adv">
                            <span class="grey">{{r1}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
                        </div>
                        <div class="advspacer"></div>
                        <div class="adv">
                            <span>{{r2}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
                        </div>
                    {{/rollLess() r1 r2}}
                    {{#rollTotal() r1 r2}}
                        <div class="adv">
                            <span>{{r1}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
                        </div>
                        <div class="advspacer"></div>
                        <div class="adv">
                            <span>{{r2}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
                        </div>
                    {{/rollTotal() r1 r2}}
                    {{#rollGreater() r1 r2}}
                        <div class="adv">
                            <span>{{r1}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
                        </div>
                        <div class="advspacer"></div>
                        <div class="adv">
                            <span class="grey">{{r2}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
                        </div>
                    {{/rollGreater() r1 r2}}
                {{/advantage}}
                {{#disadvantage}}
                    {{#rollLess() r1 r2}}
                        <div class="adv">
                            <span>{{r1}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
                        </div>
                        <div class="advspacer"></div>
                        <div class="adv">
                            <span class="grey">{{r2}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
                        </div>
                    {{/rollLess() r1 r2}}
                    {{#rollTotal() r1 r2}}
                        <div class="adv">
                            <span>{{r1}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
                        </div>
                        <div class="advspacer"></div>
                        <div class="adv">
                            <span>{{r2}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
                        </div>
                    {{/rollTotal() r1 r2}}
                    {{#rollGreater() r1 r2}}
                        <div class="adv">
                            <span class="grey">{{r1}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
                        </div>
                        <div class="advspacer"></div>
                        <div class="adv">
                            <span>{{r2}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
                        </div>
                    {{/rollGreater() r1 r2}}
                {{/disadvantage}}
            </div>
            {{#range}}
                <div class="sublabel">
                    <span>{{range}}</span>
                </div>
            {{/range}}
            <div class="label">
                {{#normal}}
                    {{#rollWasCrit() r1}}<span>{{rnamec}}{{#innate}}<span class="grey">, {{innate}}</span>{{/innate}} <span>({{mod}})</span></span>{{/rollWasCrit() r1}}
                    {{#^rollWasCrit() r1}}<span>{{rname}}{{#innate}}<span class="grey">, {{innate}}</span>{{/innate}} <span>({{mod}})</span></span>{{/^rollWasCrit() r1}}
                {{/normal}}
                {{#always}}
                    {{#rollLess() r1 r2}}{{#rollWasCrit() r2}}<span>{{rnamec}}{{#innate}}<span class="grey">, {{innate}}</span>{{/innate}} <span>({{mod}})</span></span>{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
                    {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}<span>{{rnamec}}{{#innate}}<span class="grey">, {{innate}}</span>{{/innate}} <span>({{mod}})</span></span>{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                    {{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}<span>{{rnamec}}{{#innate}}<span class="grey">, {{innate}}</span>{{/innate}} <span>({{mod}})</span></span>{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
                    {{#^rollWasCrit() r1}}{{#^rollWasCrit() r2}}<span>{{rname}}{{#innate}}<span class="grey">, {{innate}}</span>{{/innate}} <span>({{mod}})</span></span>{{/^rollWasCrit() r2}}{{/^rollWasCrit() r1}}
                {{/always}}
                {{#advantage}}
                    {{#rollLess() r1 r2}}{{#rollWasCrit() r2}}<span>{{rnamec}}{{#innate}}<span class="grey">, {{innate}}</span>{{/innate}} <span>({{mod}})</span></span>{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
                    {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}<span>{{rnamec}}{{#innate}}<span class="grey">, {{innate}}</span>{{/innate}} <span>({{mod}})</span></span>{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                    {{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}<span>{{rnamec}}{{#innate}}<span class="grey">, {{innate}}</span>{{/innate}} <span>({{mod}})</span></span>{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
                    {{#^rollWasCrit() r1}}{{#^rollWasCrit() r2}}<span>{{rname}}{{#innate}}<span class="grey">, {{innate}}</span>{{/innate}} <span>({{mod}})</span></span>{{/^rollWasCrit() r2}}{{/^rollWasCrit() r1}}
                {{/advantage}}
                {{#disadvantage}}
                    {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}<span>{{rnamec}}{{#innate}}<span class="grey">, {{innate}}</span>{{/innate}} <span>({{mod}})</span></span>{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                    {{#rollTotal() r1 r2}}{{#^rollWasCrit() r1}}<span>{{rname}}{{#innate}}<span class="grey">, {{innate}}</span>{{/innate}} <span>({{mod}})</span></span>{{/^rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                    {{#rollLess() r1 r2}}<span>{{rname}}{{#innate}}<span class="grey">, {{innate}}</span>{{/innate}} <span>({{mod}})</span></span>{{/rollLess() r1 r2}}
                    {{#rollGreater() r1 r2}}<span>{{rname}}{{#innate}}<span class="grey">, {{innate}}</span>{{/innate}} <span>({{mod}})</span></span>{{/rollGreater() r1 r2}}
                {{/disadvantage}}
            </div>
            {{#charname}}
                <div class="charname">
                    <span>{{charname}}</span>
                </div>
            {{/charname}}
        </div>
        {{#desc}}
            <div class="desc info">
                <span>
                    <span class="top"></span><span class="middle">{{desc}}</span><span class="bottom"></span>
                </span>
            </div>
        {{/desc}}
    </rolltemplate>

    <rolltemplate class="sheet-rolltemplate-dmg">
        {{#save}}
            {{#attack}}
                <div class="desc save">
            {{/attack}}
            {{^attack}}
                <div class="atk save">
            {{/attack}}
                <div class="savedc">
                    <span class="rolltemplate-inline" data-i18n="difficulty-class-abv">DC</span><span class="rolltemplate-inline">{{savedc}}</span>
                </div>
                {{#savedesc}}
                    <div class="sublabel">
                        <span>{{savedesc}}</span>
                    </div>
                {{/savedesc}}
                <div class="label">
                    <span class="rolltemplate-inline">{{saveattr}}</span> <span class="rolltemplate-inline" data-i18n="save">Save</span>
                </div>
            </div>
        {{/save}}
        {{^attack}}
            {{#desc}}
                <div class="desc info">
                    <span>
                        <span class="top"></span><span class="middle">{{desc}}</span><span class="bottom"></span>
                    </span>
                </div>
            {{/desc}}
        {{/attack}}
        {{#globaldamage}}
            {{#^rollTotal() globaldamage 0}}
                <div class="desc">
                    <span>{{globaldamage}}{{#globaldamagecrit}}<span class="plus"> + </span>{{globaldamagecrit}}{{/globaldamagecrit}}</span>
                    <span class="sublabel">{{globaldamagetype}}</span>
                </div>
            {{/^rollTotal() globaldamage 0}}
        {{/globaldamage}}
        {{#hldmg}}
            {{#^rollTotal() hldmg 0}}
                <div class="desc">
                    <span>{{hldmg}}{{#hldmgcrit}}<span class="plus"> + </span>{{hldmgcrit}}{{/hldmgcrit}}</span>
                    <span class="sublabel">{{dmg1type}}</span>
                    <div class="label">
                        <span data-i18n="higher-lvl-cast">Higher Level Cast</span>
                    </div>
                </div>
            {{/^rollTotal() hldmg 0}}
        {{/hldmg}}
        <div class="container damagetemplate">
            <div class="result">
                {{#dmg1flag}}
                    {{^dmg2flag}}
                        <div class="solo">
                            <span class="damage">{{dmg1}}{{#crit}} + {{crit1}}{{/crit}}</span>
                            <span class="sublabel">{{dmg1type}}</span>
                        </div>
                    {{/dmg2flag}}
                {{/dmg1flag}}
                {{#dmg2flag}}
                    {{^dmg1flag}}
                        <div class="solo">
                            <span class="damage">{{dmg2}}{{#crit}} + {{crit2}}{{/crit}}</span>
                            <span class="sublabel">{{dmg2type}}</span>
                        </div>
                    {{/dmg1flag}}
                {{/dmg2flag}}
                {{#dmg1flag}}
                    {{#dmg2flag}}
                        <div class="adv">
                            <span class="damage">{{dmg1}}{{#crit}} + {{crit1}}{{/crit}}</span>
                            <span class="sublabel">{{dmg1type}}</span>
                        </div>
                        <div class="advspacer"></div>
                        <div class="adv">
                            <span class="damage">{{dmg2}}{{#crit}} + {{crit2}}{{/crit}}</span>
                            <span class="sublabel">{{dmg2type}}</span>
                        </div>
                    {{/dmg2flag}}
                {{/dmg1flag}}
            </div>
            {{^attack}}
                {{#range}}
                    <div class="sublabel" style="color: black;">
                        <span>{{range}}</span>
                    </div>
                {{/range}}
                <div class="label">
                    <span>{{rname}}</span>{{#innate}}<span class="grey">, {{innate}}</span>{{/innate}}
                </div>
                {{#charname}}
                    <div class="charname">
                        <span>{{charname}}</span>
                    </div>
                {{/charname}}
            {{/attack}}
        </div>
    </rolltemplate>

    <rolltemplate class="sheet-rolltemplate-atkdmg">
        {{#attack}}
            <div class="container atk">
                <div class="result">
                    {{#always}}
                        <div class="adv">
                            <span>{{r1}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
                        </div>
                        <div class="advspacer"></div>
                        <div class="adv">
                            <span>{{r2}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
                        </div>
                    {{/always}}
                    {{#normal}}
                        <div class="solo">
                            <span>{{r1}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
                        </div>
                    {{/normal}}
                    {{#advantage}}
                        {{#rollLess() r1 r2}}
                            <div class="adv">
                                <span class="grey">{{r1}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
                            </div>
                            <div class="advspacer"></div>
                            <div class="adv">
                                <span>{{r2}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
                            </div>
                        {{/rollLess() r1 r2}}
                        {{#rollTotal() r1 r2}}
                            <div class="adv">
                                <span>{{r1}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
                            </div>
                            <div class="advspacer"></div>
                            <div class="adv">
                                <span>{{r2}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
                            </div>
                        {{/rollTotal() r1 r2}}
                        {{#rollGreater() r1 r2}}
                            <div class="adv">
                                <span>{{r1}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
                            </div>
                            <div class="advspacer"></div>
                            <div class="adv">
                                <span class="grey">{{r2}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
                            </div>
                        {{/rollGreater() r1 r2}}
                    {{/advantage}}
                    {{#disadvantage}}
                        {{#rollLess() r1 r2}}
                            <div class="adv">
                                <span>{{r1}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
                            </div>
                            <div class="advspacer"></div>
                            <div class="adv">
                                <span class="grey">{{r2}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
                            </div>
                        {{/rollLess() r1 r2}}
                        {{#rollTotal() r1 r2}}
                            <div class="adv">
                                <span>{{r1}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
                            </div>
                            <div class="advspacer"></div>
                            <div class="adv">
                                <span>{{r2}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
                            </div>
                        {{/rollTotal() r1 r2}}
                        {{#rollGreater() r1 r2}}
                            <div class="adv">
                                <span class="grey">{{r1}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
                            </div>
                            <div class="advspacer"></div>
                            <div class="adv">
                                <span>{{r2}}{{#globalattack}} + {{globalattack}}{{/globalattack}}</span>
                            </div>
                        {{/rollGreater() r1 r2}}
                    {{/disadvantage}}
                </div>
                {{#range}}
                    <div class="sublabel">
                        <span>{{range}}</span>
                    </div>
                {{/range}}
                <div class="label">
                    <span>{{rname}}{{#innate}}<span class="grey">, {{innate}}</span>{{/innate}}{{#attack}} <span>({{mod}})</span>{{/attack}}</span>
                </div>
                {{#charname}}
                    <div class="charname">
                        <span>{{charname}}</span>
                    </div>
                {{/charname}}
            </div>
        {{/attack}}
        {{#save}}
            {{#attack}}
                <div class="container desc save">
            {{/attack}}
            {{^attack}}
                <div class="container atk save">
            {{/attack}}
                <div class="savedc">
                    <span class="rolltemplate-inline" data-i18n="difficulty-class-abv">DC</span><span class="rolltemplate-inline">{{savedc}}</span>
                </div>
                {{#savedesc}}
                    <div class="sublabel">
                        <span>{{savedesc}}</span>
                    </div>
                {{/savedesc}}
                <div class="label">
                    <span class="rolltemplate-inline">{{saveattr}}</span> <span class="rolltemplate-inline" data-i18n="save">Save</span>
                </div>
            </div>
        {{/save}}
        {{#desc}}
            <div class="desc info">
                <span>
                    <span class="top"></span><span class="middle">{{desc}}</span><span class="bottom"></span>
                </span>
            </div>
        {{/desc}}
        {{#globaldamage}}
            {{#^rollTotal() globaldamage 0}}
                <div class="desc">
                    <span>
                        {{globaldamage}}
                        {{#attack}}
                            {{#normal}}
                                {{#rollWasCrit() r1}}<span class="plus"> + </span>{{globaldamagecrit}}{{/rollWasCrit() r1}}
                            {{/normal}}
                            {{#always}}
                                {{#rollLess() r1 r2}}{{#rollWasCrit() r2}}<span class="plus"> + </span>{{globaldamagecrit}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
                                {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}<span class="plus"> + </span>{{globaldamagecrit}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                                {{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}<span class="plus"> + </span>{{globaldamagecrit}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
                            {{/always}}
                            {{#advantage}}
                                {{#rollLess() r1 r2}}{{#rollWasCrit() r2}}<span class="plus"> + </span>{{globaldamagecrit}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
                                {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}<span class="plus"> + </span>{{globaldamagecrit}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                                {{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}<span class="plus"> + </span>{{globaldamagecrit}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
                            {{/advantage}}
                            {{#disadvantage}}
                                {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}<span class="plus"> + </span>{{globaldamagecrit}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                            {{/disadvantage}}
                        {{/attack}}
                    </span>
                    <span class="sublabel">{{globaldamagetype}}</span>
                </div>
            {{/^rollTotal() globaldamage 0}}
        {{/globaldamage}}
        {{#hldmg}}
            {{#^rollTotal() hldmg 0}}
                <div class="desc">
                    <span>
                        {{hldmg}}
                        <!-- {{#hldmgcrit}} + {{hldmgcrit}}{{/hldmgcrit}} -->
                        {{#attack}}
                            {{#normal}}
                                {{#rollWasCrit() r1}}<span class="plus"> + </span>{{hldmgcrit}}{{/rollWasCrit() r1}}
                            {{/normal}}
                            {{#always}}
                                {{#rollLess() r1 r2}}{{#rollWasCrit() r2}}<span class="plus"> + </span>{{hldmgcrit}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
                                {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}<span class="plus"> + </span>{{hldmgcrit}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                                {{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}<span class="plus"> + </span>{{hldmgcrit}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
                            {{/always}}
                            {{#advantage}}
                                {{#rollLess() r1 r2}}{{#rollWasCrit() r2}}<span class="plus"> + </span>{{hldmgcrit}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
                                {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}<span class="plus"> + </span>{{hldmgcrit}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                                {{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}<span class="plus"> + </span>{{hldmgcrit}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
                            {{/advantage}}
                            {{#disadvantage}}
                                {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}<span class="plus"> + </span>{{hldmgcrit}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                            {{/disadvantage}}
                        {{/attack}}
                    </span>
                    <span class="sublabel">{{dmg1type}}</span>
                    <div class="label">
                        <span data-i18n="higher-lvl-cast">Higher Level Cast</span>
                    </div>
                </div>
            {{/^rollTotal() hldmg 0}}
        {{/hldmg}}
        {{#damage}}
            <div class="container damagetemplate">
                <div class="result">
                    {{#dmg1flag}}
                        {{^dmg2flag}}
                            <div class="solo">
                                <span class="damage">
                                    {{dmg1}}
                                    {{#attack}}
                                        {{#normal}}
                                            {{#rollWasCrit() r1}}+ {{crit1}}{{/rollWasCrit() r1}}
                                        {{/normal}}
                                        {{#always}}
                                            {{#rollLess() r1 r2}}{{#rollWasCrit() r2}}+ {{crit1}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
                                            {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}+ {{crit1}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                                            {{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}+ {{crit1}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
                                        {{/always}}
                                        {{#advantage}}
                                            {{#rollLess() r1 r2}}{{#rollWasCrit() r2}}+ {{crit1}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
                                            {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}+ {{crit1}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                                            {{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}+ {{crit1}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
                                        {{/advantage}}
                                        {{#disadvantage}}
                                            {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}+ {{crit1}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                                        {{/disadvantage}}
                                    {{/attack}}
                                </span>
                                <span class="sublabel">{{dmg1type}}</span>
                            </div>
                        {{/dmg2flag}}
                    {{/dmg1flag}}
                    {{#dmg2flag}}
                        {{^dmg1flag}}
                            <div class="solo">
                                <span class="damage">
                                    {{dmg2}}
                                    {{#attack}}
                                        {{#normal}}
                                            {{#rollWasCrit() r1}}+ {{crit2}}{{/rollWasCrit() r1}}
                                        {{/normal}}
                                        {{#always}}
                                            {{#rollLess() r1 r2}}{{#rollWasCrit() r2}}+ {{crit2}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
                                            {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}+ {{crit2}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                                            {{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}+ {{crit2}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
                                        {{/always}}
                                        {{#advantage}}
                                            {{#rollLess() r1 r2}}{{#rollWasCrit() r2}}+ {{crit2}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
                                            {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}+ {{crit2}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                                            {{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}+ {{crit2}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
                                        {{/advantage}}
                                        {{#disadvantage}}
                                            {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}+ {{crit2}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                                        {{/disadvantage}}
                                    {{/attack}}
                                </span>
                                <span class="sublabel">{{dmg2type}}</span>
                            </div>
                        {{/dmg1flag}}
                    {{/dmg2flag}}
                    {{#dmg1flag}}
                        {{#dmg2flag}}
                            <div class="adv">
                                <span class="damage">
                                    {{dmg1}}
                                    {{#attack}}
                                        {{#normal}}
                                            {{#rollWasCrit() r1}}+ {{crit1}}{{/rollWasCrit() r1}}
                                        {{/normal}}
                                        {{#always}}
                                            {{#rollLess() r1 r2}}{{#rollWasCrit() r2}}+ {{crit1}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
                                            {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}+ {{crit1}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                                            {{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}+ {{crit1}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
                                        {{/always}}
                                        {{#advantage}}
                                            {{#rollLess() r1 r2}}{{#rollWasCrit() r2}}+ {{crit1}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
                                            {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}+ {{crit1}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                                            {{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}+ {{crit1}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
                                        {{/advantage}}
                                        {{#disadvantage}}
                                            {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}+ {{crit1}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                                        {{/disadvantage}}
                                    {{/attack}}
                                </span>
                                <span class="sublabel">{{dmg1type}}</span>
                            </div>
                            <div class="advspacer"></div>
                            <div class="adv">
                                <span>
                                    {{dmg2}}
                                    {{#attack}}
                                        {{#normal}}
                                            {{#rollWasCrit() r1}}+ {{crit2}}{{/rollWasCrit() r1}}
                                        {{/normal}}
                                        {{#always}}
                                            {{#rollLess() r1 r2}}{{#rollWasCrit() r2}}+ {{crit2}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
                                            {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}+ {{crit2}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                                            {{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}+ {{crit2}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
                                        {{/always}}
                                        {{#advantage}}
                                            {{#rollLess() r1 r2}}{{#rollWasCrit() r2}}+ {{crit2}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
                                            {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}+ {{crit2}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                                            {{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}+ {{crit2}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
                                        {{/advantage}}
                                        {{#disadvantage}}
                                            {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}+ {{crit2}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                                        {{/disadvantage}}
                                    {{/attack}}
                                </span>
                                <span class="sublabel">{{dmg2type}}</span>
                            </div>
                        {{/dmg2flag}}
                    {{/dmg1flag}}
                </div>
                {{^attack}}
                    {{#range}}
                        <div class="sublabel">
                            <span>{{range}}</span>
                        </div>
                    {{/range}}
                    <div class="label">
                        <span>{{rname}}</span>{{#innate}}<span class="grey">, {{innate}}</span>{{/innate}}
                    </div>
                    {{#charname}}
                        <div class="charname">
                            <span>{{charname}}</span>
                        </div>
                    {{/charname}}
                {{/attack}}
            </div>
        {{/damage}}
    </rolltemplate>

    <rolltemplate class="sheet-rolltemplate-desc">
        <div class="desc info">
            <span>
                <span class="top"></span><span class="middle">{{desc}}</span><span class="bottom"></span>
            </span>
        </div>
    </rolltemplate>

    <rolltemplate class="sheet-rolltemplate-spell">
        <div class="container">
            <div class="title row">
                <span>{{name}}</span>{{#innate}}<span class="grey">, {{innate}}</span>{{/innate}}
            </div>
            <div class="italics row">
                <span>{{level}}{{#ritual}} (<span data-i18n="ritual-l"></span>){{/ritual}}</span>
            </div>
            <div class="spacer"></div>
            {{#castingtime}}
            <div class="row">
                <span class="bold" data-i18n="casting-time:">Casting Time:</span> <span>{{castingtime}}</span>
            </div>
            {{/castingtime}}
            {{#range}}
            <div class="row">
                <span class="bold" data-i18n="range:">Range:</span> <span>{{range}}</span>
            </div>
            {{/range}}
            {{#target}}
            <div class="row">
                <span class="bold" data-i18n="target:">Target:</span> <span>{{target}}</span>
            </div>
            {{/target}}
            <div class="row">
                <span class="bold" data-i18n="components:">Components:</span>
                <span>
                    {{#v}}V{{#s}}, {{/s}}{{^s}}{{#m}}, {{/m}}{{/s}}{{/v}}
                    {{#s}}S{{#m}}, {{/m}}{{/s}}
                    {{#m}}M {{#material}}({{material}}){{/material}}{{/m}}
                </span>
            </div>
            {{#duration}}
            <div class="row">
                <span class="bold" data-i18n="duration:">Duration:</span> <span>{{#concentration}}<span data-i18n="concentration">Concentration</span> {{/concentration}}{{duration}}</span>
            </div>
            {{/duration}}
            <div class="spacer"></div>
            {{#description}}
            <div class="row">
                <span class="description">{{description}}</span>
            </div>
            {{/description}}
            {{#athigherlevels}}
            <div class="row">
                <span class="bold italics" data-i18n="at-higher-lvl">At Higher Levels</span>. <span class="description">{{athigherlevels}}</span>
            </div>
            {{/athigherlevels}}
        </div>
    </rolltemplate>

    <rolltemplate class="sheet-rolltemplate-traits">
        <div class="row header">
            <span>{{name}}</span>
        </div>
        {{#source}}
            <div class="row subheader">
                <span class="italics">{{#charname}}{{charname}} {{/charname}}{{source}}</span>
            </div>
        {{/source}}
        {{#description}}
            <div class="row">
                <span class="desc">{{description}}</span>
            </div>
        {{/description}}
    </rolltemplate>

    <rolltemplate class="sheet-rolltemplate-npc">
        <div class="row header">
            <span>{{rname}}</span>
        </div>
        {{#name}}
            <div class="row subheader">
                <span class="italics">{{name}}</span>
            </div>
        {{/name}}
        <div class="arrow-right"></div>
        <div class="row">
            {{#normal}}
                <span class="italics">{{type}}: </span><span>{{r1}}</span>
            {{/normal}}
            {{#always}}
                <span class="italics">{{type}}: </span><span>{{r1}}</span><span> | </span><span>{{r2}}</span>
            {{/always}}
            {{#advantage}}
                {{#rollLess() r1 r2}}
                    <span class="italics">{{type}}: </span><span class="grey">{{r1}}</span><span> | </span><span>{{r2}}</span>
                {{/rollLess() r1 r2}}
                {{#rollTotal() r1 r2}}
                    <span class="italics">{{type}}: </span><span>{{r1}}</span><span> | </span><span>{{r2}}</span>
                {{/rollTotal() r1 r2}}
                {{#rollGreater() r1 r2}}
                    <span class="italics">{{type}}: </span><span>{{r1}}</span><span> | </span><span class="grey">{{r2}}</span>
                {{/rollGreater() r1 r2}}
            {{/advantage}}
            {{#disadvantage}}
                {{#rollLess() r1 r2}}
                    <span class="italics">{{type}}: </span><span>{{r1}}</span><span> | </span><span class="grey">{{r2}}</span>
                {{/rollLess() r1 r2}}
                {{#rollTotal() r1 r2}}
                    <span class="italics">{{type}}: </span><span>{{r1}}</span><span> | </span><span>{{r2}}</span>
                {{/rollTotal() r1 r2}}
                {{#rollGreater() r1 r2}}
                    <span class="italics">{{type}}: </span><span class="grey">{{r1}}</span><span> | </span><span>{{r2}}</span>
                {{/rollGreater() r1 r2}}
            {{/disadvantage}}
        </div>
    </rolltemplate>

    <rolltemplate class="sheet-rolltemplate-npcatk">
        <div class="row header">
            {{#normal}}
                {{#rollWasCrit() r1}}{{rnamec}}{{/rollWasCrit() r1}}
                {{#^rollWasCrit() r1}}{{rname}}{{/^rollWasCrit() r1}}
            {{/normal}}
            {{#always}}
                {{#rollLess() r1 r2}}{{#rollWasCrit() r2}}{{rnamec}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
                {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}{{rnamec}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                {{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}{{rnamec}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
                {{#^rollWasCrit() r1}}{{#^rollWasCrit() r2}}{{rname}}{{/^rollWasCrit() r2}}{{/^rollWasCrit() r1}}
            {{/always}}
            {{#advantage}}
                {{#rollLess() r1 r2}}{{#rollWasCrit() r2}}{{rnamec}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
                {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}{{rnamec}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                {{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}{{rnamec}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
                {{#^rollWasCrit() r1}}{{#^rollWasCrit() r2}}{{rname}}{{/^rollWasCrit() r2}}{{/^rollWasCrit() r1}}
            {{/advantage}}
            {{#disadvantage}}
                {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}{{rnamec}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                {{#rollTotal() r1 r2}}{{#^rollWasCrit() r1}}{{rname}}{{/^rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                {{#rollLess() r1 r2}}{{rname}}{{/rollLess() r1 r2}}
                {{#rollGreater() r1 r2}}{{rnamec}}{{/rollGreater() r1 r2}}
            {{/disadvantage}}
        </div>
        {{#name}}
            <div class="row subheader">
                <span class="italics">{{name}}</span>
            </div>
        {{/name}}
        <div class="arrow-right"></div>
        <div class="row">
            {{#normal}}
                {{#rollWasCrit() r1}}<span class="italics">{{typec}}: </span>{{/rollWasCrit() r1}}
                {{#^rollWasCrit() r1}}<span class="italics">{{type}}: </span>{{/^rollWasCrit() r1}}
            {{/normal}}
            {{#always}}
                {{#rollLess() r1 r2}}{{#rollWasCrit() r2}}<span class="italics">{{typec}}: </span>{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
                {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}<span class="italics">{{typec}}: </span>{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                {{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}<span class="italics">{{typec}}: </span>{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
                {{#^rollWasCrit() r1}}{{#^rollWasCrit() r2}}<span class="italics">{{type}}: </span>{{/^rollWasCrit() r2}}{{/^rollWasCrit() r1}}
            {{/always}}
            {{#advantage}}
                {{#rollLess() r1 r2}}{{#rollWasCrit() r2}}<span class="italics">[{{typec}}: </span>{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
                {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}<span class="italics">{{typec}}: </span>{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                {{#rollGreater() r1 r2}}{{#rollWasCrit() r1}}<span class="italics">{{typec}}: </span>{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
                {{#^rollWasCrit() r1}}{{#^rollWasCrit() r2}}<span class="italics">{{type}}: </span>{{/^rollWasCrit() r2}}{{/^rollWasCrit() r1}}
            {{/advantage}}
            {{#disadvantage}}
                {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}}<span class="italics">{{typec}}: </span>{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                {{#rollTotal() r1 r2}}{{#^rollWasCrit() r1}}<span class="italics">{{type}}: </span>{{/^rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                {{#rollLess() r1 r2}}<span class="italics">{{type}}: </span>{{/rollLess() r1 r2}}
                {{#rollGreater() r1 r2}}<span class="italics">{{typec}}: </span>{{/rollGreater() r1 r2}}
            {{/disadvantage}}
            {{#normal}}
                <span>{{r1}}</span>
            {{/normal}}
            {{#always}}
                <span>{{r1}}</span><span> | </span><span>{{r2}}</span>
            {{/always}}
            {{#advantage}}
                {{#rollLess() r1 r2}}
                    <span class="grey">{{r1}}</span><span> | </span><span>{{r2}}</span>
                {{/rollLess() r1 r2}}
                {{#rollTotal() r1 r2}}
                    <span>{{r1}}</span><span> | </span><span>{{r2}}</span>
                {{/rollTotal() r1 r2}}
                {{#rollGreater() r1 r2}}
                    <span>{{r1}}</span><span> | </span><span class="grey">{{r2}}</span>
                {{/rollGreater() r1 r2}}
            {{/advantage}}
            {{#disadvantage}}
                {{#rollLess() r1 r2}}
                    <span>{{r1}}</span><span> | </span><span class="grey">{{r2}}</span>
                {{/rollLess() r1 r2}}
                {{#rollTotal() r1 r2}}
                    <span>{{r1}}</span><span> | </span><span>{{r2}}</span>
                {{/rollTotal() r1 r2}}
                {{#rollGreater() r1 r2}}
                    <span class="grey">{{r1}}</span><span> | </span><span>{{r2}}</span>
                {{/rollGreater() r1 r2}}
            {{/disadvantage}}
        </div>
        {{#description}}
            <div class="row">
                <span class="desc">{{description}}</span>
            </div>
        {{/description}}
    </rolltemplate>

    <rolltemplate class="sheet-rolltemplate-npcdmg">
        <div class="container dmgcontainer damagetemplate">
            <span class="italics">Damage: </span>
            <span>
                {{#dmg1flag}}
                    {{dmg1}}{{#crit}} + {{crit1}}{{/crit}}{{dmg1type}}
                {{/dmg1flag}}
                {{#dmg1flag}}{{#dmg2flag}}+{{/dmg2flag}}{{/dmg1flag}}
                {{#dmg2flag}}
                    {{dmg2}}{{#crit}} + {{crit2}}{{/crit}}{{dmg2type}}
                {{/dmg2flag}}
            </span>
        </div>
    </rolltemplate>

    <rolltemplate class="sheet-rolltemplate-npcaction">
        <div class="container">
            <div class="row header">
                <span>{{rname}}</span>
            </div>
            {{#name}}
                <div class="row subheader">
                    <span class="italics">{{name}}</span>
                </div>
            {{/name}}
            <div class="arrow-right"></div>
            {{#attack}}
                <div class="row">
                    {{#normal}}
                        <span class="italics">Attack: </span><span>{{r1}}</span>
                    {{/normal}}
                    {{#always}}
                        <span class="italics">Attack: </span><span>{{r1}}</span><span> | </span><span>{{r2}}</span>
                    {{/always}}
                    {{#advantage}}
                        {{#rollLess() r1 r2}}
                            <span class="italics">Attack: </span><span class="grey">{{r1}}</span><span> | </span><span>{{r2}}</span>
                        {{/rollLess() r1 r2}}
                        {{#rollTotal() r1 r2}}
                            <span class="italics">Attack: </span><span>{{r1}}</span><span> | </span><span>{{r2}}</span>
                        {{/rollTotal() r1 r2}}
                        {{#rollGreater() r1 r2}}
                            <span class="italics">Attack: </span><span>{{r1}}</span><span> | </span><span class="grey">{{r2}}</span>
                        {{/rollGreater() r1 r2}}
                    {{/advantage}}
                    {{#disadvantage}}
                        {{#rollLess() r1 r2}}
                            <span class="italics">Attack: </span><span>{{r1}}</span><span> | </span><span class="grey">{{r2}}</span>
                        {{/rollLess() r1 r2}}
                        {{#rollTotal() r1 r2}}
                            <span class="italics">Attack: </span><span>{{r1}}</span><span> | </span><span>{{r2}}</span>
                        {{/rollTotal() r1 r2}}
                        {{#rollGreater() r1 r2}}
                            <span class="italics">Attack: </span><span class="grey">{{r1}}</span><span> | </span><span>{{r2}}</span>
                        {{/rollGreater() r1 r2}}
                    {{/disadvantage}}
                </div>
            {{/attack}}
            {{#description}}
                <span class="desc">{{description}}</span>
            {{/description}}
            </div>
            {{#damage}}
                <div class="container dmgcontainer damagetemplate">
                    <span class="italics">Damage: </span>
                    <span>
                        {{#dmg1flag}}
                            {{dmg1}}
                            {{#normal}}
                                {{#rollWasCrit() r1}} + {{crit1}}{{/rollWasCrit() r1}}
                            {{/normal}}
                            {{#always}}
                                {{#rollLess() r1 r2}}{{#rollWasCrit() r2}} + {{crit1}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
                                {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}} + {{crit1}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                                {{#rollGreater() r1 r2}}{{#rollWasCrit() r1}} + {{crit1}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
                            {{/always}}
                            {{#advantage}}
                                {{#rollLess() r1 r2}}{{#rollWasCrit() r2}} + {{crit1}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
                                {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}} + {{crit1}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                                {{#rollGreater() r1 r2}}{{#rollWasCrit() r1}} + {{crit1}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
                            {{/advantage}}
                            {{#disadvantage}}
                                {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}} + {{crit1}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                            {{/disadvantage}}
                            {{dmg1type}}
                        {{/dmg1flag}}
                        {{#dmg1flag}}{{#dmg2flag}}+{{/dmg2flag}}{{/dmg1flag}}
                        {{#dmg2flag}}
                            {{dmg2}}
                            {{#normal}}
                                {{#rollWasCrit() r1}} + {{crit2}}{{/rollWasCrit() r1}}
                            {{/normal}}
                            {{#always}}
                                {{#rollLess() r1 r2}}{{#rollWasCrit() r2}} + {{crit2}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
                                {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}} + {{crit2}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                                {{#rollGreater() r1 r2}}{{#rollWasCrit() r1}} + {{crit2}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
                            {{/always}}
                            {{#advantage}}
                                {{#rollLess() r1 r2}}{{#rollWasCrit() r2}} + {{crit2}}{{/rollWasCrit() r2}}{{/rollLess() r1 r2}}
                                {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}} + {{crit2}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                                {{#rollGreater() r1 r2}}{{#rollWasCrit() r1}} + {{crit2}}{{/rollWasCrit() r1}}{{/rollGreater() r1 r2}}
                            {{/advantage}}
                            {{#disadvantage}}
                                {{#rollTotal() r1 r2}}{{#rollWasCrit() r1}} + {{crit2}}{{/rollWasCrit() r1}}{{/rollTotal() r1 r2}}
                            {{/disadvantage}}
                            {{dmg2type}}
                        {{/dmg2flag}}
                    </span>
                </div>
            {{/damage}}
    </rolltemplate>

    <rolltemplate class="sheet-rolltemplate-mancerroll">
        <div class="container">
            <div class="row header">
                <span>
                    {{title}}
                    {{#c1}}
                        <span>{{c1}}</span>
                    {{/c1}}
                </span>
            </div>
            {{#r1}}
                <div class="row">
                    <span class="desc">Roll 1: </span>
                    <span class="result">{{r1}}</span>
                </div>
            {{/r1}}
            {{#r2}}
                <div class="row">
                    <span class="desc">Roll 2: </span>
                    <span class="result">{{r2}}</span>
                </div>
            {{/r2}}
            {{#r3}}
                <div class="row">
                    <span class="desc">Roll 3: </span>
                    <span class="result">{{r3}}</span>
                </div>
            {{/r3}}
            {{#r4}}
                <div class="row">
                    <span class="desc">Roll 4: </span>
                    <span class="result">{{r4}}</span>
                </div>
            {{/r4}}
            {{#r5}}
                <div class="row">
                    <span class="desc">Roll 5: </span>
                    <span class="result">{{r5}}</span>
                </div>
            {{/r5}}
            {{#r6}}
                <div class="row">
                    <span class="desc">Roll 6: </span>
                    <span class="result">{{r6}}</span>
                </div>
            {{/r6}}
            <div class="row">
                <span class="desc">
                    {{#rollTotal() c1 1}}{{option1}}{{/rollTotal() c1 1}}
                    {{#rollTotal() c1 2}}{{option2}}{{/rollTotal() c1 2}}
                    {{#rollTotal() c1 3}}{{option3}}{{/rollTotal() c1 3}}
                    {{#rollTotal() c1 4}}{{option4}}{{/rollTotal() c1 4}}
                    {{#rollTotal() c1 5}}{{option5}}{{/rollTotal() c1 5}}
                    {{#rollTotal() c1 6}}{{option6}}{{/rollTotal() c1 6}}
                    {{#rollTotal() c1 7}}{{option7}}{{/rollTotal() c1 7}}
                    {{#rollTotal() c1 8}}{{option8}}{{/rollTotal() c1 8}}
                    {{#rollTotal() c1 9}}{{option9}}{{/rollTotal() c1 9}}
                    {{#rollTotal() c1 10}}{{option10}}{{/rollTotal() c1 10}}
                    {{#rollTotal() c1 11}}{{option11}}{{/rollTotal() c1 11}}
                    {{#rollTotal() c1 12}}{{option12}}{{/rollTotal() c1 12}}
                    {{#rollTotal() c1 13}}{{option13}}{{/rollTotal() c1 13}}
                    {{#rollTotal() c1 14}}{{option14}}{{/rollTotal() c1 14}}
                    {{#rollTotal() c1 15}}{{option15}}{{/rollTotal() c1 15}}
                    {{#rollTotal() c1 16}}{{option16}}{{/rollTotal() c1 16}}
                    {{#rollTotal() c1 17}}{{option17}}{{/rollTotal() c1 17}}
                    {{#rollTotal() c1 18}}{{option18}}{{/rollTotal() c1 18}}
                    {{#rollTotal() c1 19}}{{option19}}{{/rollTotal() c1 19}}
                    {{#rollTotal() c1 20}}{{option20}}{{/rollTotal() c1 20}}
                </span>
            </div>
        </div>
    </rolltemplate>

    <rolltemplate class="sheet-rolltemplate-mancerhproll">
        <div class="container">
            <div class="row header">
                <span>
                    {{title}}
                    {{#c1}}
                        <span>{{c1}}</span>
                    {{/c1}}
                </span>
            </div>
            {{#a1}}
                <div class="row">
                <span class="desc">Average: </span><span class="result">{{a1}}</span>
                </div>
            {{/a1}}
            {{#r1}}
                <div class="row">
                <span class="desc">Roll 1: </span><span class="result">{{r1}}</span>
                </div>
            {{/r1}}
            {{#r2}}
                <div class="row">
                    <span class="desc">Roll 2: </span><span class="result">{{r2}}</span>
                </div>
            {{/r2}}
            {{#r3}}
                <div class="row">
                    <span class="desc">Roll 3: </span><span class="result">{{r3}}</span>
                </div>
            {{/r3}}
            {{#r4}}
                <div class="row">
                    <span class="desc">Roll 4: </span><span class="result">{{r4}}</span>
                </div>
            {{/r4}}
            {{#r5}}
                <div class="row">
                    <span class="desc">Roll 5: </span><span class="result">{{r5}}</span>
                </div>
            {{/r5}}
            {{#r6}}
                <div class="row">
                    <span class="desc">Roll 6: </span><span class="result">{{r6}}</span>
                </div>
            {{/r6}}
            {{#r7}}
                <div class="row">
                    <span class="desc">Roll 7: </span><span class="result">{{r7}}</span>
                </div>
            {{/r7}}
            {{#r8}}
                <div class="row">
                    <span class="desc">Roll 8: </span><span class="result">{{r8}}</span>
                </div>
            {{/r8}}
            {{#r9}}
                <div class="row">
                    <span class="desc">Roll 9: </span><span class="result">{{r9}}</span>
                </div>
            {{/r9}}
            {{#r10}}
                <div class="row">
                    <span class="desc">Roll 10: </span><span class="result">{{r10}}</span>
                </div>
            {{/r10}}
            {{#r11}}
                <div class="row">
                    <span class="desc">Roll 11: </span><span class="result">{{r11}}</span>
                </div>
            {{/r11}}
                        {{#r12}}
                <div class="row">
                    <span class="desc">Roll 12: </span><span class="result">{{r12}}</span>
                </div>
            {{/r12}}
            {{#r13}}
                <div class="row">
                    <span class="desc">Roll 13: </span><span class="result">{{r13}}</span>
                </div>
            {{/r13}}
            {{#r14}}
                <div class="row">
                    <span class="desc">Roll 14: </span><span class="result">{{r14}}</span>
                </div>
            {{/r14}}
            {{#r15}}
                <div class="row">
                    <span class="desc">Roll 15: </span><span class="result">{{r15}}</span>
                </div>
            {{/r15}}
            {{#r16}}
                <div class="row">
                    <span class="desc">Roll 16: </span><span class="result">{{r16}}</span>
                </div>
            {{/r16}}
            {{#r17}}
                <div class="row">
                    <span class="desc">Roll 17: </span><span class="result">{{r17}}</span>
                </div>
            {{/r17}}
            {{#r18}}
                <div class="row">
                    <span class="desc">Roll 18: </span><span class="result">{{r18}}</span>
                </div>
            {{/r18}}
            {{#r19}}
                <div class="row">
                    <span class="desc">Roll 19: </span><span class="result">{{r19}}</span>
                </div>
            {{/r19}}
            {{#r20}}
                <div class="row">
                    <span class="desc">Roll 20: </span><span class="result">{{r20}}</span>
                </div>
            {{/r20}}
        </div>
    </rolltemplate>
</div>

<!--

   $$$$$\  $$$$$$\        $$\      $$\  $$$$$$\  $$$$$$$\  $$\   $$\ $$$$$$$$\ $$$$$$$\   $$$$$$\
   \__$$ |$$  __$$\       $$ | $\  $$ |$$  __$$\ $$  __$$\ $$ | $$  |$$  _____|$$  __$$\ $$  __$$\
      $$ |$$ /  \__|      $$ |$$$\ $$ |$$ /  $$ |$$ |  $$ |$$ |$$  / $$ |      $$ |  $$ |$$ /  \__|
      $$ |\$$$$$$\        $$ $$ $$\$$ |$$ |  $$ |$$$$$$$  |$$$$$  /  $$$$$\    $$$$$$$  |\$$$$$$\
$$\   $$ | \____$$\       $$$$  _$$$$ |$$ |  $$ |$$  __$$< $$  $$<   $$  __|   $$  __$$<  \____$$\
$$ |  $$ |$$\   $$ |      $$$  / \$$$ |$$ |  $$ |$$ |  $$ |$$ |\$$\  $$ |      $$ |  $$ |$$\   $$ |
\$$$$$$  |\$$$$$$  |      $$  /   \$$ | $$$$$$  |$$ |  $$ |$$ | \$$\ $$$$$$$$\ $$ |  $$ |\$$$$$$  |
\______/  \______/       \__/     \__| \______/ \__|  \__|\__|  \__|\________|\__|  \__| \______/

-->

<script type="text/worker">

  on("sheet:opened", function(eventinfo) {
    versioning(function() {
      var getInfo = function(sections, callback, results) {
        results =  results || {};
        if(sections.length > 0) {
          var section = sections.pop();
          getSectionIDs(section, function(ids) {
            results[section] = ids;
            getInfo(sections, callback, results);
          });
        } else {
          callback(results);
        }
      }
      var spellSections = ["spell-cantrip"];
      for(var x=1; x<=9; x++) {
        spellSections.push("spell-" + x);
      }

      getInfo(spellSections, function(results) {
        var getList = ["character_id"];
        _.each(results, function(sectionids, sectionname) {
          _.each(sectionids, function(spellid) {
            getList.push("repeating_" + sectionname + "_" + spellid + "_rollcontent");
          });
        });
        getAttrs(getList, function(attrs) {
          var set = {};
          _.each(attrs, function(data, name) {
            if(data.length === 68 && data.split("|")[0].substr(2) !== attrs["character_id"]) {
              set[name] = "%{" + attrs["character_id"] + data.substr(22);
            }
          });
          setAttrs(set, function() {
            if(eventinfo.sourceType === "sheetworker") {
              setAttrs({l1mancer_status: "completed"})
            }
            setAttrs({l1mancer_status: "completed"})
            // else {
            //     // check_l1_mancer();
            //     // check_lp_mancer();
            // };
          });
        });
      });
    });
  });

  ['strength','perception','endurance','charisma','intelligence','agility','luck'].forEach(attr => {
    on(`change:${attr}_base change:${attr}_bonus`, function() {
      update_attr(`${attr}`);
    });
  });

  ['strength','perception','endurance','charisma','intelligence','agility','luck'].forEach(attr => {
    on(`change:${attr}`, function() {
      update_mod(`${attr}`);

      (attr === "strength") ? update_weight() : false;
      (attr === "endurance") ? update_hp_max() : false;
      (attr === "agility") ? update_initiative() : false;
    });
  });

  ['strength','perception','endurance','charisma','intelligence','agility','luck'].forEach(attr => {
    on(`change:${attr}_mod`, function() {
      update_save(`${attr}`);
      update_attacks(`${attr}`);
      update_tool(`${attr}`);

      switch(`${attr}`) {
        case "strength":
          update_skills(["melee_weapons", "unarmed"]);
          break;
        case "perception":
          update_skills(["energy_weapons", "guns"]);
          update_passive_perception();
          break;
        case "intelligence":
          update_skills(["explosives", "medicine", "repair", "science", "survival"]);
          break;
        case "charisma":
          update_skills(["speech", "speech"]);
          break;
        case "agility":
          update_skills(["lockpick", "sneak"]);
          update_initiative();
          update_defense();
          update_speed();
          break;
        case "luck":
          update_critical_strike();
        default:
          false;
      }
    });
  });

  ['strength','perception','endurance','charisma','intelligence','agility','luck'].forEach(attr => {
    on(`change:${attr}_save_prof change:${attr}_save_mod`, function(eventinfo) {
      if(eventinfo.sourceType === "sheetworker") {return;}
      update_save(`${attr}`);
    });
  });

  on("change:level", function(eventinfo) {
    if(eventinfo.sourceType === "sheetworker") {return;}
    update_hp_max();
  });

  on("change:global_save_mod", function(eventinfo) {
    if(eventinfo.sourceType === "sheetworker") {return;}
    update_all_saves();
  });

  on("change:death_save_mod", function(eventinfo) {
    if(eventinfo.sourceType === "sheetworker") {return;}
    update_save("death");
  });

  ['barter','energy_weapons','explosives','guns','lockpick','medicine','melee_weapons','repair','science','sneak','speech','survival','unarmed'].forEach(skill => {
    on(`change:${skill}_prof change:${skill}_type change:${skill}_flat`, function(eventinfo) {
      if(eventinfo.sourceType === "sheetworker") {return;}
      update_skills([`${skill}`]);
    });
  });

  on("change:repeating_critrangemod:mod remove:repeating_critrangemod", function() {
    update_critrange();
  });

  on("change:repeating_critfailmod:mod remove:repeating_critfailmod", function() {
    update_critfail();
  });

  on("change:repeating_hpmod:mod remove:repeating_hpmod", function() {
    update_hp_max();
  });

  on("change:repeating_defmod:mod remove:repeating_defmod", function() {
    update_defense();
  });

  on("change:repeating_dtmod:mod remove:repeating_dtmod", function() {
    update_dt();
  });

  on("change:repeating_spdmod:mod remove:repeating_spdmod", function() {
    update_speed();
  });

  on("change:repeating_modifiers:active change:repeating_modifiers:modifiers change:repeating_armor:equipped change:repeating_armor:itemmodifiers change:repeating_inventory:equipped change:repeating_inventory:itemmodifiers", function(eventinfo) {
    if(eventinfo.sourceType === "sheetworker") {return;}
    console.log("CUSTOM MODIFIER CHANGE DETECTED!")
    update_global_modifiers();
  });

  on("change:repeating_tool:toolname change:repeating_tool:toolbonus_base change:repeating_tool:toolattr_base change:repeating_tool:tool_mod", function(eventinfo) {
    if(eventinfo.sourceType === "sheetworker") {return;}
    var tool_id = eventinfo.sourceAttribute.substring(15, 35);
    update_tool(tool_id);
  });

  on("change:repeating_attack:atkname change:repeating_attack:atkflag change:repeating_attack:atkbase change:repeating_attack:atkattr change:repeating_attack:atkskill change:repeating_attack:atkcritrange change:repeating_attack:dmgflag change:repeating_attack:dmgbase change:repeating_attack:dmgattr change:repeating_attack:dmgskill change:repeating_attack:dmgroll change:repeating_attack:dmgtype change:repeating_attack:dmgcustcrit change:repeating_attack:saveflag change:repeating_attack:savedc change:repeating_attack:saveflat change:repeating_attack:dmgcustcrit change:repeating_attack:ammo change:repeating_attack:saveattr change:repeating_attack:atkrange", function(eventinfo) {
    if(eventinfo.sourceType === "sheetworker") {return;}
    console.log("ATTACK CHANGE DETECTED!");
    var attackid = eventinfo.sourceAttribute.substring(17, 37);
    update_attacks(attackid);
  });

  on("change:repeating_weapons", function(eventinfo) {
    if(eventinfo.sourceType === "sheetworker") {return;}
    console.log("WEAPON CHANGE DETECTED!");
    var weaponid = eventinfo.sourceAttribute.substring(18,38);
    getAttrs([`repeating_weapons_${weaponid}_itemid`], function(attrs) {
      if(attrs[`repeating_weapons_${weaponid}_itemid`] && attrs[`repeating_weapons_${weaponid}_itemid`] != "") {
        var itemid = attrs[`repeating_weapons_${weaponid}_itemid`];
        update_item_from_weapon(itemid, weaponid);
      }
      update_attacks("all");
    });
  });

  on("change:repeating_weapons:equipped", function(eventinfo) {
    if(eventinfo.sourceType === "sheetworker") {return;}
    console.log("WEAPON CHANGE DETECTED!");
    var weaponid = eventinfo.sourceAttribute.substring(18,38);
    update_equipped_weapon(weaponid);
  });

  on("change:repeating_weapons:type change:repeating_weapons:class", function(eventinfo) {
    if(eventinfo.sourceType === "sheetworker") {return;}
    update_weapon_type_flag();
    update_active_attacks();
  });

  on("change:repeating_weapons:mag", function(eventinfo) {
    if(eventinfo.sourceType === "sheetworker") {return;}
    var weaponid = eventinfo.sourceAttribute.substring(18,38);
    reload_weapon(weaponsid);
  });

  on("change:repeating_attack:type change:repeating_attack:class", function(eventinfo) {
    if(eventinfo.sourceType === "sheetworker") {return;}
    update_attack_type_flag();
    update_active_attacks();
  });

  on("change:repeating_attack:cooldown change:repeating_attack:cooldowncur change:repeating_weapons:shots", function(eventinfo) {
    if(eventinfo.sourceType === "sheetworker") {return;}
    update_active_attacks();
  });

  on("change:repeating_attack:dmgtype change:repeating_weapons:dmgtype", function(eventinfo) {
    if(eventinfo.sourceType === "sheetworker") {return;}
    update_attack_dmg2_flag();
  });

  on("change:repeating_damagemod remove:repeating_damagemod", function(eventinfo) {
    if(eventinfo.sourceType === "sheetworker") {return;}
    update_globaldamage();
  });

  on("change:global_damage_mod_flag", function(eventinfo) {
    getSectionIDs("damagemod", function(ids) {
      var update = {};
      if(eventinfo.newValue === "1") {
        if(!ids || ids.length === 0) {
            var rowid = generateRowID();
            update[`repeating_damagemod_${rowid}_global_damage_active_flag`] = "1";
        }
      } else {
        _.each(ids, function(rowid) {
            update[`repeating_damagemod_${rowid}_global_damage_active_flag`] = "0";
        });
      }
      setAttrs(update);
    });
  });

  on("change:exhaustion_toggle", function(eventinfo) {
    if(eventinfo.newValue !== "0") {
      getAttrs(["exhaustion_level"], function(attrs) {
        if(!attrs.exhaustion_level || attrs.exhaustion_level === "") {
          var update = {};
          update.exhaustion_level = "0";
          setAttrs(update);
        }
      });
    }
  });

  on("change:exhaustion_level", function(eventinfo) {
    const newValue = parseInt(eventinfo.newValue) || 0, previousValue = parseInt(eventinfo.previousValue) || 0;
    let update = {};

   if (newValue === 0) {
      //If exhaustion is 0 the reset exhaustion_1 to "No Effect" and blank the other spans
      for(let i = 2; i <= 6; i++) { update[`exhaustion_${i}`] = ""}
      update[`exhaustion_1`] = "• " + getTranslationByKey(`exhaustion-0`)
    } else if (newValue > previousValue) {
      //If exhaustion increase then add text to the spans
      for(let i = previousValue; i <= newValue; i++)
      {update[`exhaustion_${i}`] = "• " + getTranslationByKey(`exhaustion-${i}`)}
    } else {
      //If exhaustion decrease remove text from spans
      for(let i = newValue + 1; i <= previousValue; i++) {update[`exhaustion_${i}`] = ""}
    };

    setAttrs(update, {silent: true});
  });

  on("change:radiation_toggle", function(eventinfo) {
    if(eventinfo.newValue !== "0") {
      getAttrs(["radiation_level"], function(attrs) {
        if(!attrs.radiation_level || attrs.radiation_level === "") {
          var update = {};
          update.radiation_level = "0";
          setAttrs(update);
        }
      });
    }
  });

  on("change:radiation_level", function(eventinfo) {
    const newValue = Math.floor(parseInt(eventinfo.newValue)/2) || 0, previousValue = Math.floor(parseInt(eventinfo.previousValue)/2) || 0;
    let update = {};

    if (newValue === 0) {
      // If radiation is 0 the reset radiation_1 to "No Effect" and blank the other spans
      for(let i = 2; i <= 6; i++) { update[`radiation_${i}`] = ""}
      update[`radiation_1`] = getTranslationByKey(`radiation-status-0`)
    } else if (newValue > previousValue) {
      // If radiation increase then add text to the spans
      for(let i = previousValue; i <= newValue; i++)
      {update[`radiation_${i+1}`] = "▪ " + getTranslationByKey(`radiation-${i}`)}
      update[`radiation_1`] = getTranslationByKey(`radiation-status-${newValue}`)
    } else {
      // If radiation decrease remove text from spans
      for(let i = newValue+1; i <= previousValue+1; i++) {update[`radiation_${i+1}`] = ""}
      update[`radiation_1`] = getTranslationByKey(`radiation-status-${newValue}`)
    };

    setAttrs(update, {silent: true});
  });

  on("change:repeating_inventory:equipped", function(eventinfo) {
    if(eventinfo.sourceType && eventinfo.sourceType === "sheetworker") {return;}

    const itemid = eventinfo.sourceAttribute.substring(20, 40);
    getAttrs([
      `repeating_inventory_${itemid}_equipped`,
      `repeating_inventory_${itemid}_hasattack`,
      `repeating_inventory_${itemid}_isweapon`,
      `repeating_inventory_${itemid}_isarmor`,
      `repeating_inventory_${itemid}_itemattackid`,
      `repeating_inventory_${itemid}_itemweaponid`,
      `repeating_inventory_${itemid}_itemarmorid`
    ], function(attrs) {
      const equipped = attrs[`repeating_inventory_${itemid}_equipped`];
      const hasattack = attrs[`repeating_inventory_${itemid}_hasattack`];
      const itemattackid = attrs[`repeating_inventory_${itemid}_itemattackid`];
      const isweapon = attrs[`repeating_inventory_${itemid}_isweapon`];
      const itemweaponid = attrs[`repeating_inventory_${itemid}_itemweaponid`];
      const isarmor = attrs[`repeating_inventory_${itemid}_isarmor`];
      const itemarmorid = attrs[`repeating_inventory_${itemid}_itemarmorid`];
      (equipped == 1 && hasattack == 1) ? create_attack_from_item(itemid, {newattack: false}) : remove_attack(itemattackid);
      (equipped == 1 && isweapon == 1) ? create_weapon_from_item(itemid, {newweapon: false}) : remove_weapon(itemweaponid);
      (equipped == 1 && isarmor == 1) ? create_armor_from_item(itemid, {newarmor: false}) : remove_armor(itemarmorid);
    });
  });

  on("change:repeating_inventory:hasattack", function(eventinfo) {
    if(eventinfo.sourceType && eventinfo.sourceType === "sheetworker") {return;}

    const itemid = eventinfo.sourceAttribute.substring(20, 40);
    getAttrs([
      `repeating_inventory_${itemid}_equipped`,
      `repeating_inventory_${itemid}_itemattackid`
    ], function(attrs) {
      const hasattack = eventinfo.newValue;
      const itemattackid = attrs[`repeating_inventory_${itemid}_itemattackid`];
      const equipped = attrs[`repeating_inventory_${itemid}_equipped`];
      (hasattack == 1 && equipped == 1) ? create_attack_from_item(itemid, {newattack: true}) : remove_attack(itemattackid);
    });
  });

  on("change:repeating_inventory:isweapon", function(eventinfo) {
    if(eventinfo.sourceType && eventinfo.sourceType === "sheetworker") {return;}

    const itemid = eventinfo.sourceAttribute.substring(20, 40);
    getAttrs([
      `repeating_inventory_${itemid}_equipped`,
      `repeating_inventory_${itemid}_itemweaponid`
    ], function(attrs) {
      const isweapon = eventinfo.newValue;
      const itemweaponid = attrs[`repeating_inventory_${itemid}_itemweaponid`];
      const equipped = attrs[`repeating_inventory_${itemid}_equipped`];
      (isweapon == 1 && equipped == 1) ? create_weapon_from_item(itemid, {newweapon: true}) : remove_weapon(itemweaponid);
    });
  });

  on("change:repeating_inventory:isarmor", function(eventinfo) {
    if(eventinfo.sourceType && eventinfo.sourceType === "sheetworker") {return;}

    const itemid = eventinfo.sourceAttribute.substring(20, 40);
    getAttrs([
      `repeating_inventory_${itemid}_equipped`,
      `repeating_inventory_${itemid}_itemarmorid`
    ], function(attrs) {
      const isarmor = eventinfo.newValue;
      const itemarmorid = attrs[`repeating_inventory_${itemid}_itemarmorid`];
      const equipped = attrs[`repeating_inventory_${itemid}_equipped`];
      (isarmor == 1 && equipped == 1) ? create_armor_from_item(itemid, {newarmor: true}) : remove_armor(itemarmorid);
    });
  });

  on(`change:repeating_inventory:useasresource`, function(eventinfo) {
    if(eventinfo.sourceType && eventinfo.sourceType === "sheetworker") {return;};

    const itemid = eventinfo.sourceAttribute.substring(20, 40);
    getAttrs([`repeating_inventory_${itemid}_itemresourceid`], function(v) {
      const useasresource = eventinfo.newValue;
      const itemresourceid = v[`repeating_inventory_${itemid}_itemresourceid`];
      (useasresource == 1) ? create_resource_from_item(itemid) : remove_resource(itemresourceid);
    });
  });

  on("change:repeating_inventory:itemname change:repeating_inventory:itemproperties change:repeating_inventory:itemmodifiers change:repeating_inventory:itemcount", function(eventinfo) {
    if(eventinfo.sourceType && eventinfo.sourceType === "sheetworker") {return;}

    var itemid = eventinfo.sourceAttribute.substring(20, 40);
    getAttrs(["repeating_inventory_" + itemid + "_itemattackid", "repeating_inventory_" + itemid + "_itemresourceid"], function(v) {
      var attackid = v["repeating_inventory_" + itemid + "_itemattackid"];
      var resourceid = v["repeating_inventory_" + itemid + "_itemresourceid"];
      if(attackid) {
        update_attack_from_item(itemid, attackid);
      }
      if(resourceid) {
        update_resource_from_item(itemid, resourceid);
      }
    });
  });

  ['other_resource','repeating_resource:resource_left','repeating_resource:resource_right'].forEach(attr => {
    on(`change:${attr} change:${attr}_name`, (eventinfo) => {
      if(eventinfo.sourceType && eventinfo.sourceType === "sheetworker") {return;}
      const resourceid = (eventinfo.sourceAttribute.includes("_name")) ? eventinfo.sourceAttribute.slice(0, -5) : eventinfo.sourceAttribute;
      getAttrs([`${resourceid}_itemid`], (v) => {
        const value = eventinfo.newValue;
        //Update repeating_inventory if an itemid is associated with a resource
        if (v[`${resourceid}_itemid`] && v[`${resourceid}_itemid`] != "") {
          const itemid = v[`${resourceid}_itemid`];
          let update = {};
          if (eventinfo.sourceAttribute.includes("_name")) {
            update[`repeating_inventory_${itemid}_itemname`]  = eventinfo.newValue;
          } else {
            update[`repeating_inventory_${itemid}_itemcount`] = eventinfo.newValue;
          };
          setAttrs(update, {silent: true}, () => {update_weight()});
        };
      });
    });
  });

  on("change:repeating_inventory:itemweight change:repeating_inventory:itemcount change:cp change:sp change:ep change:gp change:pp change:encumberance_setting change:size change:carrying_capacity_mod", function() {
    update_weight();
  });

  on("change:repeating_armor", function(eventinfo) {
    if(eventinfo.sourceType === "sheetworker") {return;}
    console.log("ARMOR CHANGE DETECTED!");
    var armorid = eventinfo.sourceAttribute.substring(16, 36);
    getAttrs([`repeating_armor_${armorid}_itemid`], function(attrs) {
      if(attrs[`repeating_armor_${armorid}_itemid`] && attrs[`repeating_armor_${armorid}_itemid`] != "") {
        var itemid = attrs[`repeating_armor_${armorid}_itemid`];
        update_item_from_armor(itemid, armorid);
      }
    });
  });

  on("change:repeating_armor:armordt change:repeating_armor:equipped", function(eventinfo) {
    console.log("ARMOR DT CHANGE DETECTED!");
    update_dt();
  });

  on("change:repeating_armor:itemmodifiers change:repeating_armor:equipped", function(eventinfo) {
    console.log("ARMOR MODIFIERS CHANGE DETECTED!");
    if(eventinfo.sourceType && eventinfo.sourceType === "sheetworker") {return;}
    var armorid = eventinfo.sourceAttribute.substring(16, 36);
    getAttrs(["repeating_armor_" + armorid + "_itemmodifiers"], function(attrs) {
      if(attrs["repeating_armor_" + armorid + "_itemmodifiers"]) {
        check_itemmodifiers(attrs["repeating_armor_" + armorid + "_itemmodifiers"], eventinfo.previousValue);
      }
      update_equipped_armor(armorid);
    });
  });

  on("change:repeating_armor:type", function(eventinfo) {
    console.log("ARMOR TYPE CHANGE DETECTED!");
    if(eventinfo.sourceType && eventinfo.sourceType === "sheetworker") {return;}
    update_defense();
  });

  on("change:repeating_inventory:itemmodifiers change:repeating_inventory:equipped", function(eventinfo) {
    console.log("CHANGE REPEATING INVENTORY");
    if(eventinfo.sourceType && eventinfo.sourceType === "sheetworker") {return;};
    var itemid = eventinfo.sourceAttribute.substring(20, 40);
    getAttrs(["repeating_inventory_" + itemid + "_itemmodifiers"], function(attrs) {
      if(attrs["repeating_inventory_" + itemid + "_itemmodifiers"]) {
        check_itemmodifiers(attrs["repeating_inventory_" + itemid + "_itemmodifiers"], eventinfo.previousValue);
      };
    });
  });

  on("change:custom_ac_flag change:custom_ac_base change:custom_ac_part1 change:custom_ac_part2 change:custom_ac_shield", function(eventinfo) {
    if(eventinfo.sourceType && eventinfo.sourceType === "sheetworker") {return;}
    update_dt();
  });

  on("change:pb_type change:pb_custom change:tag_skill_mod", function(eventinfo) {
    if(eventinfo.sourceType && eventinfo.sourceType === "sheetworker") {return;}
    update_pb();
  });

  on("change:dtype", function(eventinfo) {
    if(eventinfo.sourceType && eventinfo.sourceType === "sheetworker") {return;}
    update_attacks("all");
    update_npc_action("all");
  });

  on("change:initmod change:init_tiebreaker", function(eventinfo) {
    if(eventinfo.sourceType && eventinfo.sourceType === "sheetworker") {return;}
    update_initiative();
  });

  on("change:npc_challenge", function() {
    update_challenge();
  });

  on("change:npc_str_save_base change:npc_dex_save_base change:npc_con_save_base change:npc_int_save_base change:npc_wis_save_base change:npc_cha_save_base", function(eventinfo) {
    update_npc_saves();
  });

  on("change:npc_acrobatics_base change:npc_animal_handling_base change:npc_arcana_base change:npc_athletics_base change:npc_deception_base change:npc_history_base change:npc_insight_base change:npc_intimidation_base change:npc_investigation_base change:npc_medicine_base change:npc_nature_base change:npc_perception_base change:npc_performance_base change:npc_persuasion_base change:npc_religion_base change:npc_sleight_of_hand_base change:npc_stealth_base change:npc_survival_base", function(eventinfo) {
    update_npc_skills();
  });

  on("change:repeating_npcaction:attack_flag change:repeating_npcaction:attack_type change:repeating_npcaction:attack_range change:repeating_npcaction:attack_target change:repeating_npcaction:attack_tohit change:repeating_npcaction:attack_damage change:repeating_npcaction:attack_damagetype change:repeating_npcaction:attack_damage2 change:repeating_npcaction:attack_damagetype2 change:repeating_npcaction-l:attack_flag change:repeating_npcaction-l:attack_type change:repeating_npcaction-l:attack_range change:repeating_npcaction-l:attack_target change:repeating_npcaction-l:attack_tohit change:repeating_npcaction-l:attack_damage change:repeating_npcaction-l:attack_damagetype change:repeating_npcaction-l:attack_damage2 change:repeating_npcaction-l:attack_damagetype2 change:repeating_npcaction:show_desc change:repeating_npcaction-l:show_desc change:repeating_npcaction:description change:repeating_npcaction-l:description", function(eventinfo) {
    const actionid  = eventinfo.sourceAttribute.split("_")[2];
    const legendary = eventinfo.sourceAttribute.includes("npcaction-l") ? true : false;

    update_npc_action(actionid, legendary);
  });

  on("change:core_die change:halflingluck_flag", function() {
    getAttrs(["core_die","halflingluck_flag"], function(v) {
      core = v.core_die && v.core_die != "" ? v.core_die : "1d20";
      luck = v.halflingluck_flag && v.halflingluck_flag === "1" ? "ro<1" : "";
      update = {};
      update["d20"] = core + luck;
      if(!v.core_die || v.core_die === "") {
          update["core_die"] = "1d20";
      }
      setAttrs(update);
    });
  });

  [`ac`,`attack`,'save','skill',].forEach(attr => {
    on(`change:global_${attr}_mod_flag`, (eventinfo) => {
      const mod = (attr === "attack") ? "tohitmod" : `${attr}mod`;
      if(eventinfo.newValue === "1") {
        const firstAttr       = (attr === "ac")  ? "val" : "roll";
        const firstAttrValue  = (attr === "ac")  ? 1 : "1d4";
        const secondAttrValue = (attr === "ac")  ? "Defense" : (attr === "skill") ? "GUIDANCE" : "BLESS";

        getSectionIDs(mod, (ids) => {
          if(!ids || ids.length === 0) {
            var update = {};
            var rowid = generateRowID();
            update[`repeating_${mod}_${rowid}_global_${attr}_${firstAttr}`]= `${firstAttrValue}`;
            update[`repeating_${mod}_${rowid}_global_${attr}_name`]        = `${secondAttrValue}`;
            update[`repeating_${mod}_${rowid}_global_${attr}_active_flag`] = "1";
            setAttrs(update);
          }
        });
      } else {
        getSectionIDs(mod, function(ids) {
          var update = {};
          var rowid = generateRowID();
          _.each(ids, function(rowid) {
            update[`repeating_${mod}_${rowid}_global_${attr}_active_flag`] = "0";
          });
          setAttrs(update);
        });
      }
    });
  });

  on("change:repeating_skillmod remove:repeating_skillmod", function(eventinfo) {
    update_globalskills();
  });

  on("change:repeating_savemod remove:repeating_savemod", function(eventinfo) {
    update_globalsaves();
  });

  on("change:repeating_tohitmod remove:repeating_tohitmod", function(eventinfo) {
    update_globalattack();
  });

  on("change:repeating_acmod remove:repeating_acmod", function(eventinfo) {
    update_dt();
  });

  on("change:confirm", function(eventinfo) {
    setAttrs({monster_confirm_flag: ""});
    getAttrs(["drop_category"], function(v) {
      if(v["drop_category"]) {
        handle_drop(v["drop_category"]);
      }
    });
  });

  on("change:cancel", function(eventinfo) {
    setAttrs({monster_confirm_flag: ""});
    var update = {};
    update["drop_category"] = "";
    update["drop_name"] = "";
    update["drop_data"] = "";
    update["drop_content"] = "";
    setAttrs(update, {silent: true});
  });

  on("change:passive_perception_mod", function(eventinfo) {
    update_passive_perception();
  });

  on("change:critical_strike_mod", function(eventinfo) {
    update_critical_strike();
  });

  on("change:repeating_attack:cooldown", function(eventinfo) {
    var attackid = eventinfo.sourceAttribute.substring(17, 37);
    var attrs_to_get = [`repeating_${attackid}_cooldown`];
    getAttrs(attrs_to_get, function(attrs) {
      var update = {};
      if (!isNaN(parseInt(attrs[`repeating_${attackid}_cooldown`],10))) {
        update[`repeating_${attackid}_cooldowncur`] = parseInt(attrs[`repeating_${attackid}_cooldown`],10);
      }
      setAttrs(update, {silent:true});
    });
  });

  on("clicked:increment_cooldowns", function(eventinfo) {
    increment_cooldowns();
  });

  on("clicked:reload", function(eventinfo) {
    console.log("RELOADING!");
    var attrs_to_get = ["equippedweaponid"];
    getAttrs(attrs_to_get, function(attrs) {
      if (attrs["equippedweaponid"] != "") {
        var equippedweaponid = attrs["equippedweaponid"];
        reload_weapon(equippedweaponid);
      }
    });
  });

  on("clicked:switch_page", function(eventinfo) {
    console.log("SWITCHING PAGE!");
    var attrs_to_get = ["currpage"];
    getAttrs(attrs_to_get, function(attrs) {
      var update = {};
      var page = attrs["currpage"];
      var newpage = (page === "0") ? "1" : "0";
      update["currpage"] = newpage;
      setAttrs(update, {silent:true});
    });
  });

  on("remove:repeating_inventory", function(eventinfo) {
    var itemid = eventinfo.sourceAttribute.substring(20, 40);
    var attackids = eventinfo.removedInfo && eventinfo.removedInfo["repeating_inventory_" + itemid + "_itemattackid"] ? eventinfo.removedInfo["repeating_inventory_" + itemid + "_itemattackid"] : undefined;
    var weaponids = eventinfo.removedInfo && eventinfo.removedInfo["repeating_inventory_" + itemid + "_itemweaponid"] ? eventinfo.removedInfo["repeating_inventory_" + itemid + "_itemweaponid"] : undefined;
    var armorids = eventinfo.removedInfo && eventinfo.removedInfo["repeating_inventory_" + itemid + "_itemarmorid"] ? eventinfo.removedInfo["repeating_inventory_" + itemid + "_itemarmorid"] : undefined;
    var resourceid = eventinfo.removedInfo && eventinfo.removedInfo["repeating_inventory_" + itemid + "_itemresourceid"] ? eventinfo.removedInfo["repeating_inventory_" + itemid + "_itemresourceid"] : undefined;

    if(attackids) {
      _.each(attackids.split(","), function(value) { remove_attack(value); });
    }
    if(weaponids) {
      _.each(weaponids.split(","), function(value) { remove_weapon(value); });
    }
    if(armorids) {
      _.each(armorids.split(","), function(value) { remove_armor(value); });
    }
    if(resourceid) {
      remove_resource(resourceid);
    }

    if(eventinfo.removedInfo && eventinfo.removedInfo["repeating_inventory_" + itemid + "_itemmodifiers"]) {
      check_itemmodifiers(eventinfo.removedInfo["repeating_inventory_" + itemid + "_itemmodifiers"]);
    }

    update_weight();
  });

  on("remove:repeating_attack", function(eventinfo) {
    var attackid = eventinfo.sourceAttribute.substring(17, 37);
    var itemid = eventinfo.removedInfo["repeating_attack_" + attackid + "_itemid"];
    var spellid = eventinfo.removedInfo["repeating_attack_" + attackid + "_spellid"];
    var spelllvl = eventinfo.removedInfo["repeating_attack_" + attackid + "_spelllevel"];
    if(itemid) {
      getAttrs(["repeating_inventory_" + itemid + "_hasattack"], function(v) {
        if(v["repeating_inventory_" + itemid + "_hasattack"] && v["repeating_inventory_" + itemid + "_hasattack"] == 1) {
          var update = {};
          update["repeating_inventory_" + itemid + "_itemattackid"] = "";
          update["repeating_inventory_" + itemid + "_hasattack"] = 0;
          setAttrs(update, {silent: true});
        }
      });
    };
    if(spellid && spelllvl) {
      getAttrs(["repeating_spell-" + spelllvl + "_" + spellid + "_spelloutput"], function(v) {
        if(v["repeating_spell-" + spelllvl + "_" + spellid + "_spelloutput"] && v["repeating_spell-" + spelllvl + "_" + spellid + "_spelloutput"] == "ATTACK") {
          var update = {};
          update["repeating_spell-" + spelllvl + "_" + spellid + "_spellattackid"] = "";
          update["repeating_spell-" + spelllvl + "_" + spellid + "_spelloutput"] = "SPELLCARD";
          setAttrs(update, {silent: true});
        }
      });
    };
  });

  on("remove:repeating_resource", function(eventinfo) {
    const resourceid = eventinfo.sourceAttribute.substring(19, 39);
    let update = {};

    _.each(['left','right'], (side) => {
      const itemid = eventinfo.removedInfo[`repeating_resource_${resourceid}_resource_${side}_itemid`];
      if (itemid) {
        update[`repeating_inventory_${itemid}_useasresource`] = 0;
        update[`repeating_inventory_${itemid}_itemresourceid`] = "";
      };
    });

    setAttrs(update, {silent: true});
  });

  on("change:experience", function(eventinfo) {
    set_level();
  });

  var update_d20 = function() {
    console.log("UPDATING D20!");
    var attrs_to_get = ["critrange", "critfail"];
    getAttrs(attrs_to_get, function(attrs) {
      var update = {};
      var critrange = !isNaN(parseInt(attrs["critrange"], 10)) ? parseInt(attrs["critrange"], 10) : 20
      var critfail = !isNaN(parseInt(attrs["critfail"], 10)) ? parseInt(attrs["critfail"], 10) : 1
      var d20 = (critrange != 20) ? "1d20cs>" + critrange : "1d20";
      d20 = (critfail != 1) ? d20 + "cf<" + critfail : d20;
      update["d20"] = d20;
      setAttrs(update, {silent:true});
    });
  }

  var update_global_modifiers = function() {
    var attrs_to_get = ["global_mods"];
    getSectionIDs("repeating_modifiers", function(mod_id_arr) {
      _.each(mod_id_arr, function(currentID, i) {
        attrs_to_get.push("repeating_modifiers_" + currentID + "_active");
        attrs_to_get.push("repeating_modifiers_" + currentID + "_modifiers");
      });
      getSectionIDs("repeating_armor", function(armor_id_arr) {
        _.each(armor_id_arr, function(currentID, i) {
          attrs_to_get.push("repeating_armor_" + currentID + "_equipped");
          attrs_to_get.push("repeating_armor_" + currentID + "_itemmodifiers");
        });
        getSectionIDs("repeating_inventory", function(inv_id_arr) {
          _.each(inv_id_arr, function(currentID, i) {
            attrs_to_get.push("repeating_inventory_" + currentID + "_equipped");
            attrs_to_get.push("repeating_inventory_" + currentID + "_itemmodifiers");
          });
          getAttrs(attrs_to_get, function(attrs) {
            var update = {};
            var callbacks = [];
            var mods = "";
            var prev_mods = attrs["global_mods"];
            var update_attr_flag = false;
            var update_critrange_flag = false;
            var update_critfail_flag = false;
            var update_critical_strike_flag = false;
            var update_pb_flag = false;
            var update_skills_flag = false;
            var update_all_saves_flag = false;
            var update_initiative_flag = false;
            var update_hp_max_flag = false;
            var update_defense_flag = false;
            var update_dt_flag = false;
            var update_speed_flag = false;
            var update_weight_flag = false;

            _.each(mod_id_arr, function(currentID) {
              if((attrs["repeating_modifiers_" + currentID + "_active"] && attrs["repeating_modifiers_" + currentID + "_active"] === "1")
              && attrs["repeating_modifiers_" + currentID + "_modifiers"] && attrs["repeating_modifiers_" + currentID + "_modifiers"] != "") {
                var mod_mods = attrs["repeating_modifiers_" + currentID + "_modifiers"];
                mods = (mods != "") ? mods + ", " + mod_mods : mod_mods;
              }
            });
            _.each(armor_id_arr, function(currentID) {
              if((attrs["repeating_armor_" + currentID + "_equipped"] && attrs["repeating_armor_" + currentID + "_equipped"] === "1")
              && attrs["repeating_armor_" + currentID + "_itemmodifiers"] && attrs["repeating_armor_" + currentID + "_itemmodifiers"] != "") {
                var armor_mods = attrs["repeating_armor_" + currentID + "_itemmodifiers"];
                mods = (mods != "") ? mods + ", " + armor_mods : armor_mods
              }
            });
            _.each(inv_id_arr, function(currentID) {
              if((attrs["repeating_inventory_" + currentID + "_equipped"] && attrs["repeating_inventory_" + currentID + "_equipped"] === "1")
              && attrs["repeating_inventory_" + currentID + "_itemmodifiers"] && attrs["repeating_inventory_" + currentID + "_itemmodifiers"] != "") {
                var inv_mods = attrs["repeating_inventory_" + currentID + "_itemmodifiers"];
                mods = (mods != "") ? mods + ", " + inv_mods : inv_mods
              }
            });

            update["global_mods"] = mods;

            var mod_list = mods.toLowerCase().split(",").concat(prev_mods.toLowerCase().split(","));
            _.each(mod_list, function(mod) {
              ['strength','perception','endurance','charisma','intelligence','agility','luck','special'].forEach(attr => {
                if(mod.indexOf(attr) > -1 && mod.indexOf("save") === -1 && mod.indexOf("saving throw") === -1){
                  update_attr_flag = true;
                }
              });
              ['barter','energy_weapons','explosives','guns','lockpick','medicine','melee_weapons','repair','science','sneak','speech','survival','unarmed','skills'].forEach(skill => {
                if(mod.indexOf(skill) > -1) {
                  update_skills_flag = true;
                }
              });
              if(mod.indexOf("crit") > -1 && mod.indexOf("thresh") === -1 && mod.indexOf("range") === -1) {
                update_critical_strike_flag = true;
              } else if(mod.indexOf("crit") > -1 && (mod.indexOf("thresh") > -1 || mod.indexOf("range") > -1) && mod.indexOf("fail") === -1) {
                update_critrange_flag = true;
              } else if(mod.indexOf("crit" > -1) && mod.indexOf("fail") > -1) {
                update_critfail_flag = true;
              } else if(mod.indexOf("tag") > -1) {
                update_pb_flag = true;
              } else if(mod.indexOf("save") > -1 || mod.indexOf("saving throw") > -1) {
                update_all_saves_flag = true;
              } else if(mod.indexOf("init") > -1) {
                update_initiative_flag = true;
              } else if(mod.indexOf("hp") > -1 || mod.indexOf("hit points") > -1 || mod.indexOf("health") > -1) {
                update_hp_max_flag = true;
              } else if(mod.indexOf("def") > -1) {
                update_defense_flag = true;
              } else if(mod.indexOf("dt") > -1 || mod.indexOf("damage threshold") > -1) {
                update_dt_flag = true;
              } else if(mod.indexOf("spd") > -1 || mod.indexOf("speed") > -1) {
                update_speed_flag = true;
              } else if(mod.indexOf("wgt") > -1 || mod.indexOf("weight") > -1 || mod.indexOf("capacity") > -1) {
                update_weight_flag = true;
              }
            });

            if(update_attr_flag){callbacks.push(() => {update_attr("all");});}
            if(update_critical_strike_flag){callbacks.push(() => {update_critical_strike();});}
            if(update_critrange_flag){callbacks.push(() => {update_critrange();});}
            if(update_critfail_flag){callbacks.push(() => {update_critfail();});}
            if(update_pb_flag){callbacks.push(() => {update_pb("global_mods");});}
            if(update_skills_flag){callbacks.push(() => {update_skills("all");});}
            if(update_all_saves_flag){callbacks.push(() => {update_all_saves();});}
            if(update_initiative_flag){callbacks.push(() => {update_initiative();});}
            if(update_hp_max_flag){callbacks.push(() => {update_hp_max();});}
            if(update_defense_flag){callbacks.push(() => {update_defense();});}
            if(update_dt_flag){callbacks.push(() => {update_dt();});}
            if(update_speed_flag){callbacks.push(() => {update_speed();});}
            if(update_weight_flag){callbacks.push(() => {update_weight();});}

            setAttrs(update, function() {callbacks.forEach(function(callback) { callback(); })});
          });
        });
      });
    });
  }

  var update_attr = function(attr) {
    var update = {};
    if (attr === "all") {
      ['strength','perception','endurance','charisma','intelligence','agility','luck'].forEach(attr => {
        update_attr(`${attr}`);
      });
      return;
    }
    var attrs_to_get = [attr + "_base", attr + "_bonus"];
    attrs_to_get.push("global_mods");
    getAttrs(attrs_to_get, function(attrs) {
      var base = attrs[attr + "_base"] && !isNaN(parseInt(attrs[attr + "_base"], 10)) ? parseInt(attrs[attr + "_base"], 10) : 10;
      var bonus = attrs[attr + "_bonus"] && !isNaN(parseInt(attrs[attr + "_bonus"], 10)) ? parseInt(attrs[attr + "_bonus"], 10) : 0;
      var attr_mod_bonus = 0;
      var mods = attrs["global_mods"].toLowerCase().split(",");
      _.each(mods, function(mod) {
        if((mod.indexOf(attr) > -1 || mod.indexOf("special") > -1) && (mod.indexOf("save") === -1 && mod.indexOf("saving throw") === -1)) {
          if(mod.indexOf(":") > -1) {
            var new_attr_base = !isNaN(parseInt(mod.replace(/[^0-9]/g, ""), 10)) ? parseInt(mod.replace(/[^0-9]/g, ""), 10) : false;
            base = new_attr_base && new_attr_base > base ? new_attr_base : base;
          }
          else if(mod.indexOf("-") > -1) {
            var new_attr_mod = !isNaN(parseInt(mod.replace(/[^0-9]/g, ""), 10)) ? parseInt(mod.replace(/[^0-9]/g, ""), 10) : false;
            attr_mod_bonus = new_attr_mod ? attr_mod_bonus - new_attr_mod : attr_mod_bonus;
          }
          else {
            var new_attr_mod = !isNaN(parseInt(mod.replace(/[^0-9]/g, ""), 10)) ? parseInt(mod.replace(/[^0-9]/g, ""), 10) : false;
            attr_mod_bonus = new_attr_mod ? attr_mod_bonus + new_attr_mod : attr_mod_bonus;
          }
        }
      });
      update[attr + "_flag"] = (bonus > 0 || attr_mod_bonus > 0 || attr_mod_bonus > base) ? 1 : 0;
      update[attr] = base + bonus + attr_mod_bonus;
      setAttrs(update);
    });
  };

  var update_mod = function (attr) {
    getAttrs([attr], function(v) {
      var attr_abr = attr.substring(0,3);
      var finalattr = v[attr] && isNaN(v[attr]) === false ? Math.floor((parseInt(v[attr], 10) - 10) / 2) : 0;
      var update = {};
      update[attr + "_mod"] = finalattr;
      update["npc_" + attr_abr + "_negative"] = v[attr] && !isNaN(v[attr]) && parseInt(v[attr], 10) < 10 ? 1 : 0;
      setAttrs(update);
    });
  };

  // TODO implement armor
  var update_save = function (attr) {
    if(attr === "all") {
      ['strength','perception','endurance','charisma','intelligence','agility','luck'].forEach(attr => {
        update_save(`${attr}`);
      });
      return;
    }

    var save_attrs = [attr + "_mod", attr + "_save_prof", attr + "_save_mod", "pb", "global_save_mod", "pb_type", "global_mods"];

    getAttrs(save_attrs, function(save_attrs) {
      var attr_mod = save_attrs[attr + "_mod"] ? parseInt(save_attrs[attr + "_mod"], 10) : 0;
      var prof = save_attrs[attr + "_save_prof"] && save_attrs[attr + "_save_prof"] != 0 && !isNaN(save_attrs["pb"]) ? parseInt(save_attrs["pb"], 10) : 0;
      var save_mod = save_attrs[attr + "_save_mod"] && !isNaN(parseInt(save_attrs[attr + "_save_mod"], 10)) ? parseInt(save_attrs[attr + "_save_mod"], 10) : 0;
      var global_save_mod = save_attrs["global_save_mod"] && !isNaN(save_attrs["global_save_mod"]) ? parseInt(save_attrs["global_save_mod"], 10) : 0;
      var mod_bonus = 0;
      if(save_attrs["global_mods"] && save_attrs["global_mods"] != "" ) {
        var mods = save_attrs["global_mods"].toLowerCase().split(",");
        _.each(mods, function(mod) {
          if((mod.indexOf(attr) > -1 && mod.indexOf("save") > -1) || mod.indexOf("saving throws") > -1 ) {
            if(mod.indexOf("-") > -1) {
              var new_mod = !isNaN(parseInt(mod.replace(/[^0-9]/g, ""), 10)) ? parseInt(mod.replace(/[^0-9]/g, ""), 10) : false;
              mod_bonus = new_mod ? mod_bonus - new_mod : mod_bonus;
            } else {
              var new_mod = !isNaN(parseInt(mod.replace(/[^0-9]/g, ""), 10)) ? parseInt(mod.replace(/[^0-9]/g, ""), 10) : false;
              mod_bonus = new_mod ? mod_bonus + new_mod : mod_bonus;
            }
          }
        });
      }
      var total = attr_mod + prof + save_mod + global_save_mod + mod_bonus;
      if(save_attrs["pb_type"] && save_attrs["pb_type"] === "die" && save_attrs[attr + "_save_prof"] != 0 && attr != "death") {
        total = total + "+" + save_attrs["pb"];
      };
      var update = {};
      update[attr + "_save_bonus"] = total;
      setAttrs(update, {silent: true});
    });
  };

  var update_all_saves = function() {
    update_save("strength");
    update_save("perception");
    update_save("endurance");
    update_save("charisma");
    update_save("intelligence");
    update_save("agility");
    update_save("luck");
    update_save("death");
  };

  var update_all_ability_checks = function(){
    update_initiative();
    update_skills("all");
  };

  var update_skills = function (skills_array) {
    console.log("UPDATING SKILLS");
    var skill_parent = {barter: "charisma", energy_weapons: "perception", explosives: "intelligence", guns: "perception", lockpick: "agility", medicine: "intelligence", melee_weapons: "strength", repair: "intelligence", science: "intelligence", sneak: "agility", speech: "charisma", survival: "intelligence", unarmed: "strength"};
    var attrs_to_get = ["pb","global_mods"];
    var update = {};
    var callbacks = [];

    if(skills_array === "all") {
      return update_skills(["barter", "energy_weapons", "explosives", "guns", "lockpick", "medicine", "melee_weapons", "repair", "science", "sneak", "speech", "survival", "unarmed"]);
    }

    // get proficency and flat bonus of each skill
    _.each(skills_array, function(skill) {
      if(skill_parent[skill] && attrs_to_get.indexOf(skill_parent[skill]) === -1) {attrs_to_get.push(skill_parent[skill] + "_mod")};
      attrs_to_get.push(skill + "_prof");
      attrs_to_get.push(skill + "_flat");
    });

    getAttrs(attrs_to_get, function(attr_dict) {
      _.each(skills_array, function(skill) {
        var attr_mod = attr_dict[skill_parent[skill] + "_mod"] ? parseInt(attr_dict[skill_parent[skill] + "_mod"], 10) : 0;
        var prof = attr_dict[skill + "_prof"] != 0 && !isNaN(attr_dict["pb"]) ? parseInt(attr_dict["pb"], 10) : 0;
        var flat = attr_dict[skill + "_flat"] && !isNaN(parseInt(attr_dict[skill + "_flat"], 10)) ? parseInt(attr_dict[skill + "_flat"], 10) : 0;
        var mod_bonus = 0;

        if(attr_dict["global_mods"] && (attr_dict["global_mods"].toLowerCase().replace(/ /g,"_").indexOf(skill) > -1 || attr_dict["global_mods"].toLowerCase().indexOf("skills") > -1)) {
          var mods = attr_dict["global_mods"].toLowerCase().split(",");
          _.each(mods, function(mod) {
            if(mod.replace(/ /g,"_").indexOf(skill) > -1 || mod.indexOf("skills") > -1) {
              if(mod.indexOf("-") > -1) {
                var new_mod = !isNaN(parseInt(mod.replace(/[^0-9]/g, ""), 10)) ? parseInt(mod.replace(/[^0-9]/g, ""), 10) : false;
                mod_bonus = new_mod ? mod_bonus - new_mod : mod_bonus;
              }
              else {
                var new_mod = !isNaN(parseInt(mod.replace(/[^0-9]/g, ""), 10)) ? parseInt(mod.replace(/[^0-9]/g, ""), 10) : false;
                mod_bonus = new_mod ? mod_bonus + new_mod : mod_bonus;
              }
            };
          });
        };

        var total_skill_bonus = prof + flat + mod_bonus;
        var total_skill_check_bonus = total_skill_bonus + attr_mod;

        update[skill + "_bonus"] = total_skill_bonus;
        update[skill + "_check_bonus"] = total_skill_check_bonus
      });

      callbacks.push(() => {update_attacks("all");});

      setAttrs(update, {silent: true}, function() {callbacks.forEach(function(callback) { callback(); })});
    });
  };

  var update_tool = function(tool_id) {
    if(tool_id.substring(0,1) === "-" && tool_id.length === 20) {
      do_update_tool([tool_id]);
    } else if(tool_id === "all") {
      getSectionIDs("repeating_tool", function(idarray) {
        do_update_tool(idarray);
      });
    } else {
      getSectionIDs("repeating_tool", function(idarray) {
        var tool_attribs = [];
        _.each(idarray, function(id) {
          tool_attribs.push("repeating_tool_" + id + "_toolattr_base");
        });
        getAttrs(tool_attribs, function(v) {
          var attr_tool_ids = [];
          _.each(idarray, function(id) {
            if(v["repeating_tool_" + id + "_toolattr_base"] && v["repeating_tool_" + id + "_toolattr_base"].indexOf(tool_id) > -1) {
              attr_tool_ids.push(id);
            }
          });
          if(attr_tool_ids.length > 0) {
            do_update_tool(attr_tool_ids);
          }
        });
      });
    };
  };

  var do_update_tool = function(tool_array) {
      var tool_attribs = ["pb","pb_type","jack","strength_mod","perception_mod","endurance_mod","charisma_mod","intelligence_mod","agility_mod","luck_mod"];
      var update = {};
      _.each(tool_array, function(tool_id) {
          tool_attribs.push("repeating_tool_" + tool_id + "_toolbonus_base");
          tool_attribs.push("repeating_tool_" + tool_id + "_tool_mod");
          tool_attribs.push("repeating_tool_" + tool_id + "_toolattr_base");
      });

      getAttrs(tool_attribs, function(v) {
          _.each(tool_array, function(tool_id) {
              console.log("UPDATING TOOL: " + tool_id);
              var query = false;
              if(v["repeating_tool_" + tool_id + "_toolattr_base"] && v["repeating_tool_" + tool_id + "_toolattr_base"].substring(0,2) === "?{") {
                  update["repeating_tool_" + tool_id + "_toolattr"] = "QUERY";
                  var mod = "?{Attribute?|Strength,@{strength_mod}|Perception,@{perception_mod}|Endurance,@{endurance_mod}|Charisma,@{charisma_mod}|Intelligence,@{intelligence_mod}|Agility,@{agility_mod}|Luck,@{luck_mod}}";
                  if(v["repeating_tool_" + tool_id + "_tool_mod"]) {
                      mod = mod + "+" + v["repeating_tool_" + tool_id + "_tool_mod"];
                  }
                  query = true;
              } else {
                  var attr = v["repeating_tool_" + tool_id + "_toolattr_base"].substring(0, v["repeating_tool_" + tool_id + "_toolattr_base"].length - 5).substr(2);
                  var attr_mod = v[attr + "_mod"] ? parseInt(v[attr + "_mod"], 10) : 0;
                  var tool_mod = v["repeating_tool_" + tool_id + "_tool_mod"] && !isNaN(parseInt(v["repeating_tool_" + tool_id + "_tool_mod"], 10)) ? parseInt(v["repeating_tool_" + tool_id + "_tool_mod"], 10) : 0;
                  var mod = attr_mod + tool_mod;
                  update["repeating_tool_" + tool_id + "_toolattr"] = attr.toUpperCase();
                  if(v["repeating_tool_" + tool_id + "_tool_mod"] && v["repeating_tool_" + tool_id + "_tool_mod"].indexOf("@{") > -1) {
                      update["repeating_tool_" + tool_id + "_toolbonus"] = update["repeating_tool_" + tool_id + "_toolbonus"] + "+" + v["repeating_tool_" + tool_id + "_tool_mod"];
                  }
                  if(!v["repeating_tool_" + tool_id + "_tool_mod"]) {
                      update["repeating_tool_" + tool_id + "_tool_mod"] = 0;
                  }
              };

              if(v["pb_type"] && v["pb_type"] === "die" ) {
                  if(v["repeating_tool_" + tool_id + "_toolbonus_base"] === "(@{pb})") {update["repeating_tool_" + tool_id + "_toolbonus"] = mod + "+" + v.pb}
                  else if(v["repeating_tool_" + tool_id + "_toolbonus_base"] === "(@{pb}*2)") {update["repeating_tool_" + tool_id + "_toolbonus"] = mod + "+2" + v.pb}
                  else if(v["repeating_tool_" + tool_id + "_toolbonus_base"] === "(floor(@{pb}/2))") {update["repeating_tool_" + tool_id + "_toolbonus"] = mod + "+" + v.jack};
              }
              else if(v["repeating_tool_" + tool_id + "_toolattr_base"] && v["repeating_tool_" + tool_id + "_toolattr_base"].substring(0,2) === "?{") {
                  if(v["repeating_tool_" + tool_id + "_toolbonus_base"] === "(@{pb})") {update["repeating_tool_" + tool_id + "_toolbonus"] = mod + "+" + parseInt(v.pb, 10)}
                  else if(v["repeating_tool_" + tool_id + "_toolbonus_base"] === "(@{pb}*2)") {update["repeating_tool_" + tool_id + "_toolbonus"] = mod + "+" + (parseInt(v.pb, 10)*2)}
                  else if(v["repeating_tool_" + tool_id + "_toolbonus_base"] === "(floor(@{pb}/2))") {update["repeating_tool_" + tool_id + "_toolbonus"] = mod + "+" + parseInt(v.jack, 10)};
              }
              else {
                  if(v["repeating_tool_" + tool_id + "_toolbonus_base"] === "(@{pb})") {update["repeating_tool_" + tool_id + "_toolbonus"] = mod + parseInt(v.pb, 10)}
                  else if(v["repeating_tool_" + tool_id + "_toolbonus_base"] === "(@{pb}*2)") {update["repeating_tool_" + tool_id + "_toolbonus"] = mod + (parseInt(v.pb, 10)*2)}
                  else if(v["repeating_tool_" + tool_id + "_toolbonus_base"] === "(floor(@{pb}/2))") {update["repeating_tool_" + tool_id + "_toolbonus"] = mod + parseInt(v.jack, 10)};
              };

              if(query) {
                  update["repeating_tool_" + tool_id + "_toolbonus_display"] = "?";
              }
              else {
                  update["repeating_tool_" + tool_id + "_toolbonus_display"] = update["repeating_tool_" + tool_id + "_toolbonus"];
              };

          });

          setAttrs(update, {silent: true});
      });
  };

  var get_repeating_data = function(callback) {
      var getallrepeating = function(getobj, thiscallback, attrlist) {
          attrlist = attrlist || [];
          var thisget = getobj.pop();
          getSectionIDs(thisget.name, function(ids) {
              _.each(ids, function(sectionId) {
                  _.each(thisget.list, function(attr) {
                      attrlist.push("repeating_" + thisget.name + "_" + sectionId + "_" + attr);
                  });
              });
              if(getobj.length > 0) {
                  getallrepeating(getobj, thiscallback, attrlist);
              } else {
                  getAttrs(attrlist, function(vals) {
                      thiscallback(vals);
                  });
              };
          });
      };
      var getList = [
          {name: "proficiencies", list: ["name"]},
          {name: "tool", list: ["toolname", "toolattr_base"]},
          {name: "traits", list: ["name", "source"]},
          {name: "resource", list: ["resource_left_name", "resource_right_name"]},
          {name: "spell-cantrip", list: ["spellname", "spellattackid", "spellsource", "spellattackid"]},
          {name: "savemod", list: ["global_save_name"]},
          {name: "tohitmod", list: ["global_attack_name"]},
          {name: "damagemod", list: ["global_damage_name"]},
          {name: "acmod", list: ["global_dt_name"]},
          {name: "skillmod", list: ["global_skill_name"]},
          {name: "attack", list: ["atkname", "spellid"]},
          {name: "weapon", list: ["wpnname", "spellid"]},
          {name: "hpmod", list: ["levels", "source", "mod"]}
      ];
      for(var x=1; x<=9; x++) {
          getList.push({ name: "spell-" + x, list: ["spellname", "spellattackid", "spellsource", "spellattackid"] });
      }
      var repeating = {prof_names: [], traits: []};
      _.each(getList, function(section) {
          if(!["proficiencies", "traits"].includes(section.name)) {
              repeating[section.name] = {};
          }
      });
      getallrepeating(getList, function(vals) {
          var traitstemp = {};
          _.each(vals, function(value, name) {
              if(name.split("_")[1] == "proficiencies") {
                  repeating.prof_names.push(value.toLowerCase());
              } else if(name.split("_")[1] == "tool") {
                  repeating.tool[name.split("_")[2]] = repeating.tool[name.split("_")[2]] || {};
                  let attr = _.last(name.split("_"));
                  repeating.tool[name.split("_")[2]][attr] = value.toLowerCase();
                  if(attr == "toolname") repeating.prof_names.push(value.toLowerCase());
              } else if (name.split("_")[1] == "traits") {
                  traitstemp[name.split("_")[2]] = traitstemp[name.split("_")[2]] ? traitstemp[name.split("_")[2]] : {};
                  traitstemp[name.split("_")[2]][_.last(name.split("_"))] = value;
              } else if (name.split("_")[1] == "resource") {
                  repeating.resource[name.split("_")[2]] = repeating.resource[name.split("_")[2]] || {};
                  repeating.resource[name.split("_")[2]][name.split("_")[4]] = value;
              } else if (name.split("_")[1] == "hpmod") {
                  repeating.hpmod[name.split("_")[2]] = repeating.hpmod[name.split("_")[2]] || {};
                  repeating.hpmod[name.split("_")[2]][name.split("_")[3]] = value;
              } else if (name.split("_")[1].split("-")[0] == "spell") {
                  repeating[name.split("_")[1]][name.split("_")[2]] = repeating[name.split("_")[1]][name.split("_")[2]] || {};
                  repeating[name.split("_")[1]][name.split("_")[2]][name.split("_")[3]] = value;
              } else if (name.split("_")[1] == "attack") {
                  repeating[name.split("_")[1]][name.split("_")[2]] = repeating[name.split("_")[1]][name.split("_")[2]] || {};
                  repeating[name.split("_")[1]][name.split("_")[2]][name.split("_")[3]] = value;
              } else {
                  repeating[name.split("_")[1]][name.split("_")[2]] = value;
              }
          });
          _.each(traitstemp, function(v, k) {
              var trait = _.clone(v);
              trait.id = k;
              repeating.traits.push(trait);
          });
          callback(repeating);
      });
  };

  var check_itemmodifiers = function(modifiers, previousValue) {
    console.log("CHECKING ITEM MODIFIERS");
    var mods = modifiers.toLowerCase().split(",");
    if(previousValue) {
      prevmods = previousValue.toLowerCase().split(",");
      mods = _.union(mods, prevmods);
    };
    _.each(mods, function(mod) {
      if(mod.indexOf("dt:") > -1 || mod.indexOf("dt +") > -1 || mod.indexOf("dt -") > -1) {update_dt();};
      if(mod.indexOf("saving throws") > -1) {update_all_saves();};
      if(mod.indexOf("strength save") > -1) {update_save("strength");} else if(mod.indexOf("strength") > -1) {update_attr("strength");};
      if(mod.indexOf("perception save") > -1) {update_save("perception");} else if(mod.indexOf("perception") > -1) {update_attr("perception");};
      if(mod.indexOf("endurance save") > -1) {update_save("endurance");} else if(mod.indexOf("endurance") > -1) {update_attr("endurance");};
      if(mod.indexOf("charisma save") > -1) {update_save("charisma");} else if(mod.indexOf("charisma") > -1) {update_attr("charisma");};
      if(mod.indexOf("intellligence save") > -1) {update_save("intellligence");} else if(mod.indexOf("intellligence") > -1) {update_attr("intellligence");};
      if(mod.indexOf("agility save") > -1) {update_save("agility");} else if(mod.indexOf("agility") > -1) {update_attr("agility");};
      if(mod.indexOf("luck save") > -1) {update_save("luck");} else if(mod.indexOf("luck") > -1) {update_attr("luck");};
      if(mod.indexOf("ability checks") > -1) {update_all_ability_checks();};
      if(mod.indexOf("barter") > -1) {update_skills(["barter"]);};
      if(mod.indexOf("energy weapons") > -1) {update_skills(["energy_weapons"]);};
      if(mod.indexOf("explosives") > -1) {update_skills(["explosives"]);};
      if(mod.indexOf("guns") > -1) {update_skills(["guns"]);};
      if(mod.indexOf("lockpick") > -1) {update_skills(["lockpick"]);};
      if(mod.indexOf("medicine") > -1) {update_skills(["medicine"]);};
      if(mod.indexOf("melee weapons") > -1) {update_skills(["melee_weapons"]);};
      if(mod.indexOf("repair") > -1) {update_skills(["repair"]);};
      if(mod.indexOf("science") > -1) {update_skills(["science"]);};
      if(mod.indexOf("sneak") > -1) {update_skills(["sneak"]);};
      if(mod.indexOf("speech") > -1) {update_skills(["speech"]);};
      if(mod.indexOf("perception") > -1) {update_skills(["perception"]);};
      if(mod.indexOf("survival") > -1) {update_skills(["survival"]);};
      if(mod.indexOf("unarmed") > -1) {update_skills(["unarmed"]);};
    });
  };

  var create_attack_from_item = function(itemid, options) {
    console.log("CREATING ATTACK FROM ITEM!");
    var update = {};
    var newrowid = generateRowID();
    update[`repeating_inventory_${itemid}_itemattackid`] = newrowid;
    setAttrs(update, {}, update_attack_from_item(itemid, newrowid, options));
  };

  var update_attack_from_item = function(itemid, attackid, options) {
    console.log("UPDATING ATTACK FROM ITEM!");
    getAttrs([
      `repeating_inventory_${itemid}_itemattackid`,
      `repeating_inventory_${itemid}_itemname`,
      `repeating_inventory_${itemid}_atk_actioncost`,
      `repeating_inventory_${itemid}_atk_cooldown`,
      `repeating_inventory_${itemid}_atk_atkname`,
      `repeating_inventory_${itemid}_atk_class`,
      `repeating_inventory_${itemid}_atk_typeflag`,
      `repeating_inventory_${itemid}_atk_type`,
      `repeating_inventory_${itemid}_atk_atkflag`,
      `repeating_inventory_${itemid}_atk_atkbase`,
      `repeating_inventory_${itemid}_atk_atkattr`,
      `repeating_inventory_${itemid}_atk_atkskill`,
      `repeating_inventory_${itemid}_atk_atkrange`,
      `repeating_inventory_${itemid}_atk_atkcritrange`,
      `repeating_inventory_${itemid}_atk_dmgflag`,
      `repeating_inventory_${itemid}_atk_dmgbase`,
      `repeating_inventory_${itemid}_atk_dmgattr`,
      `repeating_inventory_${itemid}_atk_dmgskill`,
      `repeating_inventory_${itemid}_atk_dmgroll`,
      `repeating_inventory_${itemid}_atk_dmgtype`,
      `repeating_inventory_${itemid}_atk_dmgcustcrit`,
      `repeating_inventory_${itemid}_atk_saveflag`,
      `repeating_inventory_${itemid}_atk_saveattr`,
      `repeating_inventory_${itemid}_atk_saveattr`,
      `repeating_inventory_${itemid}_atk_savedc`,
      `repeating_inventory_${itemid}_atk_saveeffect`,
      `repeating_inventory_${itemid}_atk_atk_desc`
    ], function(attrs) {
      var update = {};

      if(options && options.newattack) {
        update[`repeating_attack_${attackid}_options-flag`] = "1";
        update[`repeating_attack_${attackid}_itemid`] = itemid;
        update[`repeating_attack_${attackid}_atkname`] = attrs[`repeating_inventory_${itemid}_itemname`];
      } else {
        update[`repeating_attack_${attackid}_options-flag`] = "0";
        update[`repeating_attack_${attackid}_itemid`] = itemid;
        update[`repeating_attack_${attackid}_atkname`] = attrs[`repeating_inventory_${itemid}_atk_atkname`];
      }

      update[`repeating_attack_${attackid}_actioncost`]    = attrs[`repeating_inventory_${itemid}_atk_actioncost`];
      update[`repeating_attack_${attackid}_cooldown`]      = attrs[`repeating_inventory_${itemid}_atk_cooldown`];
      update[`repeating_attack_${attackid}_type`]          = attrs[`repeating_inventory_${itemid}_atk_type`];
      update[`repeating_attack_${attackid}_typeflag`]          = attrs[`repeating_inventory_${itemid}_atk_typeflag`];
      update[`repeating_attack_${attackid}_class`]         = attrs[`repeating_inventory_${itemid}_atk_class`];
      update[`repeating_attack_${attackid}_atkflag`]       = attrs[`repeating_inventory_${itemid}_atk_atkflag`];
      update[`repeating_attack_${attackid}_atkbase`]       = attrs[`repeating_inventory_${itemid}_atk_atkbase`];
      update[`repeating_attack_${attackid}_atkattr`]       = attrs[`repeating_inventory_${itemid}_atk_atkattr`];
      update[`repeating_attack_${attackid}_atkskill`]      = attrs[`repeating_inventory_${itemid}_atk_atkskill`];
      update[`repeating_attack_${attackid}_atkrange`]      = attrs[`repeating_inventory_${itemid}_atk_atkrange`];
      update[`repeating_attack_${attackid}_atkcritrange`]  = attrs[`repeating_inventory_${itemid}_atk_atkcritrange`];
      update[`repeating_attack_${attackid}_dmgflag`]       = attrs[`repeating_inventory_${itemid}_atk_dmgflag`];
      update[`repeating_attack_${attackid}_dmgbase`]       = attrs[`repeating_inventory_${itemid}_atk_dmgbase`];
      update[`repeating_attack_${attackid}_dmgattr`]       = attrs[`repeating_inventory_${itemid}_atk_dmgattr`];
      update[`repeating_attack_${attackid}_dmgskill`]      = attrs[`repeating_inventory_${itemid}_atk_dmgskill`];
      update[`repeating_attack_${attackid}_dmgroll`]       = attrs[`repeating_inventory_${itemid}_atk_dmgroll`];
      update[`repeating_attack_${attackid}_dmgtype`]       = attrs[`repeating_inventory_${itemid}_atk_dmgtype`];
      update[`repeating_attack_${attackid}_dmgcustcrit`]   = attrs[`repeating_inventory_${itemid}_atk_dmgcustcrit`];
      update[`repeating_attack_${attackid}_saveflag`]      = attrs[`repeating_inventory_${itemid}_atk_saveflag`];
      update[`repeating_attack_${attackid}_saveattr`]      = attrs[`repeating_inventory_${itemid}_atk_saveattr`];
      update[`repeating_attack_${attackid}_saveattr`]      = attrs[`repeating_inventory_${itemid}_atk_saveattr`];
      update[`repeating_attack_${attackid}_savedc`]        = attrs[`repeating_inventory_${itemid}_atk_savedc`];
      update[`repeating_attack_${attackid}_saveeffect`]    = attrs[`repeating_inventory_${itemid}_atk_saveeffect`];
      update[`repeating_attack_${attackid}_atk_desc`]      = attrs[`repeating_inventory_${itemid}_atk_atk_desc`];

      var callback = function() {update_attacks(attackid, "item")};
      setAttrs(update, {silent: true}, callback);
    });
  };

  var update_item_from_attack = function(itemid, attackid) {
    console.log("UPDATING ITEM FROM ATTACK!");

    getAttrs([
      `repeating_attack_${attackid}_actioncost`,
      `repeating_attack_${attackid}_cooldown`,
      `repeating_attack_${attackid}_atkname`,
      `repeating_attack_${attackid}_typeflag`,
      `repeating_attack_${attackid}_type`,
      `repeating_attack_${attackid}_class`,
      `repeating_attack_${attackid}_atkflag`,
      `repeating_attack_${attackid}_atkbase`,
      `repeating_attack_${attackid}_atkattr`,
      `repeating_attack_${attackid}_atkskill`,
      `repeating_attack_${attackid}_atkrange`,
      `repeating_attack_${attackid}_atkcritrange`,
      `repeating_attack_${attackid}_dmgflag`,
      `repeating_attack_${attackid}_dmgbase`,
      `repeating_attack_${attackid}_dmgattr`,
      `repeating_attack_${attackid}_dmgskill`,
      `repeating_attack_${attackid}_dmgroll`,
      `repeating_attack_${attackid}_dmgtype`,
      `repeating_attack_${attackid}_dmgcustcrit`,
      `repeating_attack_${attackid}_saveflag`,
      `repeating_attack_${attackid}_saveattr`,
      `repeating_attack_${attackid}_saveattr`,
      `repeating_attack_${attackid}_savedc`,
      `repeating_attack_${attackid}_saveeffect`,
      `repeating_attack_${attackid}_atk_desc`
    ], function(attrs) {
      var update = {};

      update[`repeating_inventory_${itemid}_atk_actioncost`]   = attrs[`repeating_attack_${attackid}_actioncost`];
      update[`repeating_inventory_${itemid}_atk_cooldown`]     = attrs[`repeating_attack_${attackid}_cooldown`];
      update[`repeating_inventory_${itemid}_atk_atkname`]      = attrs[`repeating_attack_${attackid}_atkname`];
      update[`repeating_inventory_${itemid}_atk_type`]         = attrs[`repeating_attack_${attackid}_type`];
      update[`repeating_inventory_${itemid}_atk_typeflag`]    = attrs[`repeating_attack_${attackid}_typeflag`];
      update[`repeating_inventory_${itemid}_atk_class`]        = attrs[`repeating_attack_${attackid}_class`];
      update[`repeating_inventory_${itemid}_atk_atkflag`]      = attrs[`repeating_attack_${attackid}_atkflag`];
      update[`repeating_inventory_${itemid}_atk_atkbase`]      = attrs[`repeating_attack_${attackid}_atkbase`];
      update[`repeating_inventory_${itemid}_atk_atkattr`]      = attrs[`repeating_attack_${attackid}_atkattr`];
      update[`repeating_inventory_${itemid}_atk_atkskill`]     = attrs[`repeating_attack_${attackid}_atkskill`];
      update[`repeating_inventory_${itemid}_atk_atkrange`]     = attrs[`repeating_attack_${attackid}_atkrange`];
      update[`repeating_inventory_${itemid}_atk_atkcritrange`] = attrs[`repeating_attack_${attackid}_atkcritrange`];
      update[`repeating_inventory_${itemid}_atk_dmgflag`]      = attrs[`repeating_attack_${attackid}_dmgflag`];
      update[`repeating_inventory_${itemid}_atk_dmgbase`]      = attrs[`repeating_attack_${attackid}_dmgbase`];
      update[`repeating_inventory_${itemid}_atk_dmgattr`]      = attrs[`repeating_attack_${attackid}_dmgattr`];
      update[`repeating_inventory_${itemid}_atk_dmgskill`]     = attrs[`repeating_attack_${attackid}_dmgskill`];
      update[`repeating_inventory_${itemid}_atk_dmgroll`]      = attrs[`repeating_attack_${attackid}_dmgroll`];
      update[`repeating_inventory_${itemid}_atk_dmgtype`]      = attrs[`repeating_attack_${attackid}_dmgtype`];
      update[`repeating_inventory_${itemid}_atk_dmgcustcrit`]  = attrs[`repeating_attack_${attackid}_dmgcustcrit`];
      update[`repeating_inventory_${itemid}_atk_saveflag`]     = attrs[`repeating_attack_${attackid}_saveflag`];
      update[`repeating_inventory_${itemid}_atk_saveattr`]     = attrs[`repeating_attack_${attackid}_saveattr`];
      update[`repeating_inventory_${itemid}_atk_saveattr`]     = attrs[`repeating_attack_${attackid}_saveattr`];
      update[`repeating_inventory_${itemid}_atk_savedc`]       = attrs[`repeating_attack_${attackid}_savedc`];
      update[`repeating_inventory_${itemid}_atk_saveeffect`]   = attrs[`repeating_attack_${attackid}_saveeffect`];
      update[`repeating_inventory_${itemid}_atk_atk_desc`]     = attrs[`repeating_attack_${attackid}_atk_desc`];

      setAttrs(update, {silent: true});
    });
  };

  var create_weapon_from_item = function(itemid, options) {
    console.log("CREATING WEAPON FROM ITEM!");
    var update = {};
    var newrowid = generateRowID();
    update[`repeating_inventory_${itemid}_itemweaponid`] = newrowid;
    setAttrs(update, {}, update_weapon_from_item(itemid, newrowid, options));
  };

  var update_weapon_from_item = function(itemid, weaponid, options) {
    console.log("UPDATING WEAPON FROM ITEM!");
    getAttrs([
      `repeating_inventory_${itemid}_itemname`,
      `repeating_inventory_${itemid}_wpn_wpnname`,
      `repeating_inventory_${itemid}_wpn_shots`,
      `repeating_inventory_${itemid}_wpn_type`,
      `repeating_inventory_${itemid}_wpn_typeflag`,
      `repeating_inventory_${itemid}_wpn_class`,
      `repeating_inventory_${itemid}_wpn_magflag`,
      `repeating_inventory_${itemid}_wpn_mag`,
      `repeating_inventory_${itemid}_wpn_ammo`,
      `repeating_inventory_${itemid}_wpn_atkflag`,
      `repeating_inventory_${itemid}_wpn_atkbase`,
      `repeating_inventory_${itemid}_wpn_atkattr`,
      `repeating_inventory_${itemid}_wpn_atkskill`,
      `repeating_inventory_${itemid}_wpn_atkrange`,
      `repeating_inventory_${itemid}_wpn_atkcritrange`,
      `repeating_inventory_${itemid}_wpn_dmgflag`,
      `repeating_inventory_${itemid}_wpn_dmgbase`,
      `repeating_inventory_${itemid}_wpn_dmgattr`,
      `repeating_inventory_${itemid}_wpn_dmgskill`,
      `repeating_inventory_${itemid}_wpn_dmgroll`,
      `repeating_inventory_${itemid}_wpn_dmgtype`,
      `repeating_inventory_${itemid}_wpn_dmgcustcrit`,
      `repeating_inventory_${itemid}_wpn_properties`,
      `repeating_inventory_${itemid}_wpn_description`
    ], function(attrs) {
      var update = {};
      var itemtype;
      var damage;
      var damagetype;
      var damage2;
      var damagetype2;
      var attackmod;
      var damagemod;
      var range;
      var alt = {};

      if(options && options.newweapon) {
        update[`repeating_weapons_${weaponid}_options-flag`] = "1";
        update[`repeating_weapons_${weaponid}_itemid`] = itemid;
        update[`repeating_weapons_${weaponid}_wpnname`] = attrs[`repeating_inventory_${itemid}_itemname`];
      } else {
        update[`repeating_weapons_${weaponid}_options-flag`] = "0";
        update[`repeating_weapons_${weaponid}_itemid`] = itemid;
        update[`repeating_weapons_${weaponid}_wpnname`] = attrs[`repeating_inventory_${itemid}_wpn_wpnname`];
      }

      update[`repeating_weapons_${weaponid}_shots`]         = attrs[`repeating_inventory_${itemid}_wpn_shots`];
      update[`repeating_weapons_${weaponid}_type`]          = attrs[`repeating_inventory_${itemid}_wpn_type`];
      update[`repeating_weapons_${weaponid}_typeflag`]      = attrs[`repeating_inventory_${itemid}_wpn_typeflag`];
      update[`repeating_weapons_${weaponid}_class`]         = attrs[`repeating_inventory_${itemid}_wpn_class`];
      update[`repeating_weapons_${weaponid}_magflag`]       = attrs[`repeating_inventory_${itemid}_wpn_magflag`];
      update[`repeating_weapons_${weaponid}_mag`]           = attrs[`repeating_inventory_${itemid}_wpn_mag`];
      update[`repeating_weapons_${weaponid}_ammo`]          = attrs[`repeating_inventory_${itemid}_wpn_ammo`];
      update[`repeating_weapons_${weaponid}_atkflag`]       = attrs[`repeating_inventory_${itemid}_wpn_atkflag`];
      update[`repeating_weapons_${weaponid}_atkbase`]       = attrs[`repeating_inventory_${itemid}_wpn_atkbase`];
      update[`repeating_weapons_${weaponid}_atkattr`]       = attrs[`repeating_inventory_${itemid}_wpn_atkattr`];
      update[`repeating_weapons_${weaponid}_atkskill`]      = attrs[`repeating_inventory_${itemid}_wpn_atkskill`];
      update[`repeating_weapons_${weaponid}_atkrange`]      = attrs[`repeating_inventory_${itemid}_wpn_atkrange`];
      update[`repeating_weapons_${weaponid}_atkcritrange`]  = attrs[`repeating_inventory_${itemid}_wpn_atkcritrange`];
      update[`repeating_weapons_${weaponid}_dmgflag`]       = attrs[`repeating_inventory_${itemid}_wpn_dmgflag`];
      update[`repeating_weapons_${weaponid}_dmgbase`]       = attrs[`repeating_inventory_${itemid}_wpn_dmgbase`];
      update[`repeating_weapons_${weaponid}_dmgattr`]       = attrs[`repeating_inventory_${itemid}_wpn_dmgattr`];
      update[`repeating_weapons_${weaponid}_dmgskill`]      = attrs[`repeating_inventory_${itemid}_wpn_dmgskill`];
      update[`repeating_weapons_${weaponid}_dmgroll`]       = attrs[`repeating_inventory_${itemid}_wpn_dmgroll`];
      update[`repeating_weapons_${weaponid}_dmgtype`]       = attrs[`repeating_inventory_${itemid}_wpn_dmgtype`];
      update[`repeating_weapons_${weaponid}_dmgcustcrit`]   = attrs[`repeating_inventory_${itemid}_wpn_dmgcustcrit`];
      update[`repeating_weapons_${weaponid}_properties`]    = attrs[`repeating_inventory_${itemid}_wpn_properties`];
      update[`repeating_weapons_${weaponid}_description`]   = attrs[`repeating_inventory_${itemid}_wpn_description`];

      setAttrs(update, {silent: true});
    });
  };

  var update_item_from_weapon = function(itemid, weaponid) {
    console.log("UPDATING ITEM FROM WEAPON!");

    getAttrs([
      `repeating_weapons_${weaponid}_wpnname`,
      `repeating_weapons_${weaponid}_shots`,
      `repeating_weapons_${weaponid}_type`,
      `repeating_weapons_${weaponid}_typeflag`,
      `repeating_weapons_${weaponid}_class`,
      `repeating_weapons_${weaponid}_magflag`,
      `repeating_weapons_${weaponid}_mag`,
      `repeating_weapons_${weaponid}_ammo`,
      `repeating_weapons_${weaponid}_atkflag`,
      `repeating_weapons_${weaponid}_atkbase`,
      `repeating_weapons_${weaponid}_atkattr`,
      `repeating_weapons_${weaponid}_atkskill`,
      `repeating_weapons_${weaponid}_atkrange`,
      `repeating_weapons_${weaponid}_atkcritrange`,
      `repeating_weapons_${weaponid}_dmgflag`,
      `repeating_weapons_${weaponid}_dmgbase`,
      `repeating_weapons_${weaponid}_dmgattr`,
      `repeating_weapons_${weaponid}_dmgskill`,
      `repeating_weapons_${weaponid}_dmgroll`,
      `repeating_weapons_${weaponid}_dmgtype`,
      `repeating_weapons_${weaponid}_dmgcustcrit`,
      `repeating_weapons_${weaponid}_properties`,
      `repeating_weapons_${weaponid}_description`
    ], function(attrs) {
      var update = {};

      update[`repeating_inventory_${itemid}_wpn_wpnname`]       = attrs[`repeating_weapons_${weaponid}_wpnname`];
      update[`repeating_inventory_${itemid}_wpn_shots`]         = attrs[`repeating_weapons_${weaponid}_shots`];
      update[`repeating_inventory_${itemid}_wpn_type`]          = attrs[`repeating_weapons_${weaponid}_type`];
      update[`repeating_inventory_${itemid}_wpn_typeflag`]      = attrs[`repeating_weapons_${weaponid}_typeflag`];
      update[`repeating_inventory_${itemid}_wpn_class`]         = attrs[`repeating_weapons_${weaponid}_class`];
      update[`repeating_inventory_${itemid}_wpn_magflag`]       = attrs[`repeating_weapons_${weaponid}_magflag`];
      update[`repeating_inventory_${itemid}_wpn_mag`]           = attrs[`repeating_weapons_${weaponid}_mag`];
      update[`repeating_inventory_${itemid}_wpn_ammo`]          = attrs[`repeating_weapons_${weaponid}_ammo`];
      update[`repeating_inventory_${itemid}_wpn_atkflag`]       = attrs[`repeating_weapons_${weaponid}_atkflag`];
      update[`repeating_inventory_${itemid}_wpn_atkbase`]       = attrs[`repeating_weapons_${weaponid}_atkbase`];
      update[`repeating_inventory_${itemid}_wpn_atkattr`]       = attrs[`repeating_weapons_${weaponid}_atkattr`];
      update[`repeating_inventory_${itemid}_wpn_atkskill`]      = attrs[`repeating_weapons_${weaponid}_atkskill`];
      update[`repeating_inventory_${itemid}_wpn_atkrange`]      = attrs[`repeating_weapons_${weaponid}_atkrange`];
      update[`repeating_inventory_${itemid}_wpn_atkcritrange`]  = attrs[`repeating_weapons_${weaponid}_atkcritrange`];
      update[`repeating_inventory_${itemid}_wpn_dmgflag`]       = attrs[`repeating_weapons_${weaponid}_dmgflag`];
      update[`repeating_inventory_${itemid}_wpn_dmgbase`]       = attrs[`repeating_weapons_${weaponid}_dmgbase`];
      update[`repeating_inventory_${itemid}_wpn_dmgattr`]       = attrs[`repeating_weapons_${weaponid}_dmgattr`];
      update[`repeating_inventory_${itemid}_wpn_dmgskill`]      = attrs[`repeating_weapons_${weaponid}_dmgskill`];
      update[`repeating_inventory_${itemid}_wpn_dmgroll`]       = attrs[`repeating_weapons_${weaponid}_dmgroll`];
      update[`repeating_inventory_${itemid}_wpn_dmgtype`]       = attrs[`repeating_weapons_${weaponid}_dmgtype`];
      update[`repeating_inventory_${itemid}_wpn_dmgcustcrit`]   = attrs[`repeating_weapons_${weaponid}_dmgcustcrit`];
      update[`repeating_inventory_${itemid}_wpn_properties`]    = attrs[`repeating_weapons_${weaponid}_properties`];
      update[`repeating_inventory_${itemid}_wpn_description`]   = attrs[`repeating_weapons_${weaponid}_description`];

      setAttrs(update, {silent: true});
    });
  };

  var create_armor_from_item = function(itemid, options) {
    console.log("CREATING ARMOR FROM ITEM!");
    var update = {};
    var newrowid = generateRowID();
    update[`repeating_inventory_${itemid}_itemarmorid`] = newrowid;
    setAttrs(update, {}, update_armor_from_item(itemid, newrowid, options));
  };

  var update_armor_from_item = function(itemid, armorid, options) {
    console.log("UPDATING ARMOR FROM ITEM!");
    getAttrs([
      `repeating_inventory_${itemid}_itemname`,
      `repeating_inventory_${itemid}_arm_armorname`,
      `repeating_inventory_${itemid}_arm_armordt`,
      `repeating_inventory_${itemid}_arm_type`,
      `repeating_inventory_${itemid}_arm_armorproperties`,
      `repeating_inventory_${itemid}_arm_itemmodifiers`,
      `repeating_inventory_${itemid}_arm_armorcontent`
    ], function(attrs) {
      var update = {};

      if(options && options.newarmor) {
        update[`repeating_armor_${armorid}_options-flag`] = "0";
        update[`repeating_armor_${armorid}_itemid`] = itemid;
        update[`repeating_armor_${armorid}_armorname`] = attrs[`repeating_inventory_${itemid}_itemname`];
      } else {
        update[`repeating_armor_${armorid}_itemid`] = itemid;
        update[`repeating_armor_${armorid}_armorname`] = attrs[`repeating_inventory_${itemid}_arm_armorname`];
      }

      update[`repeating_armor_${armorid}_armordt`]          = attrs[`repeating_inventory_${itemid}_arm_armordt`];
      update[`repeating_armor_${armorid}_type`]             = attrs[`repeating_inventory_${itemid}_arm_type`];
      update[`repeating_armor_${armorid}_armorproperties`]  = attrs[`repeating_inventory_${itemid}_arm_armorproperties`];
      update[`repeating_armor_${armorid}_itemmodifiers`]     = attrs[`repeating_inventory_${itemid}_arm_itemmodifiers`];
      update[`repeating_armor_${armorid}_armorcontent`]     = attrs[`repeating_inventory_${itemid}_arm_armorcontent`];

      setAttrs(update, {silent: true});
    });
  };

  var update_item_from_armor = function(itemid, armorid) {
    console.log("UPDATING ITEM FROM ARMOR!");

    getAttrs([
      `repeating_armor_${armorid}_armorname`,
      `repeating_armor_${armorid}_armordt`,
      `repeating_armor_${armorid}_type`,
      `repeating_armor_${armorid}_armorproperties`,
      `repeating_armor_${armorid}_itemmodifiers`,
      `repeating_armor_${armorid}_armorcontent`
    ], function(attrs) {
      var update = {};

      update[`repeating_inventory_${itemid}_arm_armorname`]        = attrs[`repeating_armor_${armorid}_armorname`];
      update[`repeating_inventory_${itemid}_arm_armordt`]          = attrs[`repeating_armor_${armorid}_armordt`];
      update[`repeating_inventory_${itemid}_arm_type`]             = attrs[`repeating_armor_${armorid}_type`];
      update[`repeating_inventory_${itemid}_arm_armorproperties`]  = attrs[`repeating_armor_${armorid}_armorproperties`];
      update[`repeating_inventory_${itemid}_arm_itemmodifiers`]     = attrs[`repeating_armor_${armorid}_itemmodifiers`];
      update[`repeating_inventory_${itemid}_arm_armorcontent`]     = attrs[`repeating_armor_${armorid}_armorcontent`];

      setAttrs(update, {silent: true});
    });
  };

  const create_resource_from_item = (itemid) => {
    const newrowid = generateRowID();
    let update     = {};

    getAttrs(["other_resource_name"], (v) => {
      // Use other_resource if it is empty
      if (!v.other_resource_name || v.other_resource_name == "") {
        update[`repeating_inventory_${itemid}_itemresourceid`] = "other_resource";
        setAttrs(update, {}, update_resource_from_item(itemid, "other_resource", true));
      // If other_resource is populated look through the repeating sections for an empty spot
      } else {
        getSectionIDs(`repeating_resource`, (idarray) => {
          if (idarray.length == 0) {
            update[`repeating_inventory_${itemid}_itemresourceid`] = `${newrowid}_resource_left`;
            setAttrs(update, {}, update_resource_from_item(itemid, `${newrowid}_resource_left`, true));
          } else {
            let array = [];
            _.each(idarray, (currentID, i) => {
              ["left", "right"].forEach(side => {
                array.push(`repeating_resource_${currentID}_resource_${side}`);
                array.push(`repeating_resource_${currentID}_resource_${side}_name`);
                array.push(`repeating_resource_${currentID}_resource_${side}_max`);
              });
            });
            getAttrs(array, (y) => {
              let existing = false;
             _.each(idarray, (currentID, i) => {
                ["left", "right"].forEach(side => {
                  const Name  = y[`repeating_resource_${currentID}_resource_${side}_name`] || false;
                  const Value = y[`repeating_resource_${currentID}_resource_${side}`] || false;
                  const Max   = y[`repeating_resource_${currentID}_resource_${side}_max`] || false;

                  // If Name, Value, & Max are empty and existing === false then populate a resource there
                  if ((!Name && !Value && !Max) && existing === false) {
                    update[`repeating_inventory_${itemid}_itemresourceid`] = `${currentID}_resource_${side}`;
                    setAttrs(update, {}, update_resource_from_item(itemid, `${currentID}_resource_${side}`, true));
                    existing = true;
                  };
                });
              });
              // If nothing is empty then generatae a new row
              if(!existing) {
                update[`repeating_inventory_${itemid}_itemresourceid`] = `${newrowid}_resource_left`;
                setAttrs(update, {}, update_resource_from_item(itemid, `${newrowid}_resource_left`, true));
              };
            });
          };
        });
      };
    });
  };

  var update_resource_from_item = function(itemid, resourceid, newresource) {
    getAttrs(["repeating_inventory_" + itemid + "_itemname","repeating_inventory_" + itemid + "_itemcount"], function(attrs) {
      var update = {}; var id;

      if(resourceid && resourceid == "other_resource") {
        id = resourceid;
      }
      else {
        id = "repeating_resource_" + resourceid;
      };

      if(newresource) {
        update[id + "_itemid"] = itemid;
      };

      if(!attrs["repeating_inventory_" + itemid + "_itemname"]) {
        update["repeating_inventory_" + itemid + "_useasresource"] = 0;
        update["repeating_inventory_" + itemid + "_itemresourceid"] = "";
        remove_resource(resourceid);
      };
      if(attrs["repeating_inventory_" + itemid + "_itemname"] && attrs["repeating_inventory_" + itemid + "_itemname"] != "") {
        update[id + "_name"] = attrs["repeating_inventory_" + itemid + "_itemname"];
      };
      if(attrs["repeating_inventory_" + itemid + "_itemcount"] && attrs["repeating_inventory_" + itemid + "_itemcount"] != "") {
        update[id] = attrs["repeating_inventory_" + itemid + "_itemcount"];
      };

      setAttrs(update, {silent: true});
    });
  };

  var increment_cooldowns = function() {
    console.log("INCREMENTING COOLDOWNS!");
    attrs_to_get = [];
    getSectionIDs("repeating_attack", function(attackids) {
      _.each(attackids, function(id) {
        attrs_to_get.push(`repeating_attack_${id}_cooldown`);
        attrs_to_get.push(`repeating_attack_${id}_cooldowncur`);
      });
      getAttrs(attrs_to_get, function(attrs) {
        var update = {};
        _.each(attackids, function(id) {
          var cooldown = parseInt(attrs[`repeating_attack_${id}_cooldown`],10);
          var cooldowncur = parseInt(attrs[`repeating_attack_${id}_cooldowncur`],10);
          cooldowncur = (cooldowncur === cooldown) ? cooldown : cooldowncur + 1;
          update[`repeating_attack_${id}_cooldowncur`] = cooldowncur;
        });
        setAttrs(update, {silent:true}, update_active_attacks());
      });
    });
  }

  const update_attacks = (update_id, source) => {
    if (update_id.substring(0,1) === "-" && update_id.length === 20) {
      do_update_attack([update_id], source);
    } else if(["strength","perception","endurance","charisma","intelligence","agility","luck","all"].indexOf(update_id) > -1) {
      getSectionIDs("repeating_attack", function(idarray) {
        if(update_id === "all") {
          do_update_attack(idarray);
        } else {
            var attrs_to_get = ["spellcasting_ability"];
            _.each(idarray, function(id) {
              attrs_to_get.push("repeating_attack_" + id + "_atkbase");
              attrs_to_get.push("repeating_attack_" + id + "_dmgattr");
              attrs_to_get.push("repeating_attack_" + id + "_dmg2attr");
              attrs_to_get.push("repeating_attack_" + id + "_savedc");
            });
            getAttrs(attrs_to_get, function(attrs) {
              var attr_attack_ids = [];
              _.each(idarray, function(id) {
                if((attrs["repeating_attack_" + id + "_atkbase"]
                  && attrs["repeating_attack_" + id + "_atkbase"].indexOf(update_id) > -1)
                  || (attrs["repeating_attack_" + id + "_dmgattr"] && attrs["repeating_attack_" + id + "_dmgattr"].indexOf(update_id) > -1)
                  || (attrs["repeating_attack_" + id + "_dmg2attr"] && attrs["repeating_attack_" + id + "_dmg2attr"].indexOf(update_id) > -1)
                  || (attrs["repeating_attack_" + id + "_savedc"] && attrs["repeating_attack_" + id + "_savedc"].indexOf(update_id) > -1)
                  || (attrs["repeating_attack_" + id + "_savedc"] && attrs["repeating_attack_" + id + "_savedc"] === "(@{spell_save_dc})"
                  && attrs["spellcasting_ability"] && attrs["spellcasting_ability"].indexOf(update_id) > -1)) {
                    attr_attack_ids.push(id);
                }
              });
              if(attr_attack_ids.length > 0) {
                do_update_attack(attr_attack_ids);
              }
            });
          };
      });
    };
  };

  var do_update_attack = function(attack_array, source) {
    console.log("UPDATING ATTACK");
    getAttrs(["equippedweaponid"], function(attrs) {
      var weaponid = attrs["equippedweaponid"] ? attrs["equippedweaponid"] : "";
      var attrs_to_get = ["level","d20","pb","pb_type","pbd_safe","dtype","globalmagicmod","strength_mod","perception_mod","endurance_mod","charisma_mod","intelligence_mod","agility_mod","luck_mod","barter_bonus","energy_weapons_bonus","explosives_bonus","guns_bonus","lockpick_bonus","medicine_bonus","melee_weapons_bonus","repair_bonus","science_bonus","sneak_bonus","speech_bonus","survival_bonus","unarmed_bonus","global_damage_mod_roll","global_damage_mod_crit","critrange","critical_strike"];
      _.each(attack_array, function(attackid) {
        attrs_to_get.push("repeating_attack_" + attackid + "_activeflag");
        attrs_to_get.push("repeating_attack_" + attackid + "_cooldown");
        attrs_to_get.push("repeating_attack_" + attackid + "_atkname");
        attrs_to_get.push("repeating_attack_" + attackid + "_type");
        attrs_to_get.push("repeating_attack_" + attackid + "_class");
        attrs_to_get.push("repeating_attack_" + attackid + "_atkflag");
        attrs_to_get.push("repeating_attack_" + attackid + "_atkbase");
        attrs_to_get.push("repeating_attack_" + attackid + "_atkattr");
        attrs_to_get.push("repeating_attack_" + attackid + "_atkskill");
        attrs_to_get.push("repeating_attack_" + attackid + "_atkrange");
        attrs_to_get.push("repeating_attack_" + attackid + "_atkcritrange");
        attrs_to_get.push("repeating_attack_" + attackid + "_dmgflag");
        attrs_to_get.push("repeating_attack_" + attackid + "_dmg2flag");
        attrs_to_get.push("repeating_attack_" + attackid + "_dmgbase");
        attrs_to_get.push("repeating_attack_" + attackid + "_dmgattr");
        attrs_to_get.push("repeating_attack_" + attackid + "_dmgskill");
        attrs_to_get.push("repeating_attack_" + attackid + "_dmgroll");
        attrs_to_get.push("repeating_attack_" + attackid + "_dmgtype");
        attrs_to_get.push("repeating_attack_" + attackid + "_dmgcustcrit");
        attrs_to_get.push("repeating_attack_" + attackid + "_saveflag");
        attrs_to_get.push("repeating_attack_" + attackid + "_savedc");
        attrs_to_get.push("repeating_attack_" + attackid + "_saveflat");
        attrs_to_get.push("repeating_attack_" + attackid + "_saveeffect");

        attrs_to_get.push("repeating_attack_" + attackid + "_hldmg");
        attrs_to_get.push("repeating_attack_" + attackid + "_spellid");
        attrs_to_get.push("repeating_attack_" + attackid + "_spelllevel");

        attrs_to_get.push("repeating_attack_" + attackid + "_itemid");
        attrs_to_get.push("repeating_attack_" + attackid + "_global_damage_mod_field");

        attrs_to_get.push("repeating_weapons_" + weaponid + "_atkname");
        attrs_to_get.push("repeating_weapons_" + weaponid + "_type");
        attrs_to_get.push("repeating_weapons_" + weaponid + "_class");
        attrs_to_get.push("repeating_weapons_" + weaponid + "_ammo");
        attrs_to_get.push("repeating_weapons_" + weaponid + "_atkflag");
        attrs_to_get.push("repeating_weapons_" + weaponid + "_atkbase");
        attrs_to_get.push("repeating_weapons_" + weaponid + "_atkattr");
        attrs_to_get.push("repeating_weapons_" + weaponid + "_atkskill");
        attrs_to_get.push("repeating_weapons_" + weaponid + "_atkrange");
        attrs_to_get.push("repeating_weapons_" + weaponid + "_atkcritrange");
        attrs_to_get.push("repeating_weapons_" + weaponid + "_dmgflag");
        attrs_to_get.push("repeating_weapons_" + weaponid + "_dmgbase");
        attrs_to_get.push("repeating_weapons_" + weaponid + "_dmgattr");
        attrs_to_get.push("repeating_weapons_" + weaponid + "_dmgskill");
        attrs_to_get.push("repeating_weapons_" + weaponid + "_dmgroll");
        attrs_to_get.push("repeating_weapons_" + weaponid + "_dmgtype");
        attrs_to_get.push("repeating_weapons_" + weaponid + "_dmgcustcrit");
      });

      getAttrs(attrs_to_get, function(attrs) {
        _.each(attack_array, function(attackid) {
          var callbacks = [];
          var update = {};
          var hbonus = "";
          var hdmg1 = "";
          var hdmg2 = "";
          var hwpndmg = "";
          var hatkdmg = "";
          var dmg = "";
          var dmg2 = "";
          var rollbase = "";
          var atkattr_abrev = "";
          var dmgattr_abrev = "";
          var dmg2attr_abrev = "";
          var global_crit = attrs["repeating_attack_" + attackid + "_global_damage_mod_field"] && attrs["repeating_attack_" + attackid + "_global_damage_mod_field"] != "" ? "@{global_damage_mod_crit}" : "";
          var hldmgcrit = attrs["repeating_attack_" + attackid + "_hldmg"] && attrs["repeating_attack_" + attackid + "_hldmg"] != "" ? attrs["repeating_attack_" + attackid + "_hldmg"].slice(0, 7) + "crit" + attrs["repeating_attack_" + attackid + "_hldmg"].slice(7) : "";

          // ATTACK ATTRIBUTES
          if(!attrs["repeating_attack_" + attackid + "_atkattr"] || attrs["repeating_attack_" + attackid + "_atkattr"] === "0") {
            atkattr = 0;
          } else {
            atkattr = parseInt(attrs[attrs["repeating_attack_" + attackid + "_atkattr"].substring(2, attrs["repeating_attack_" + attackid + "_atkattr"].length - 1)], 10);
          }

          if(!attrs["repeating_attack_" + attackid + "_atkskill"] || attrs["repeating_attack_" + attackid + "_atkskill"] === "0") {
            atkskill = 0;
          } else {
            atkskill = parseInt(attrs[attrs["repeating_attack_" + attackid + "_atkskill"].substring(2, attrs["repeating_attack_" + attackid + "_atkskill"].length - 1)], 10);
          }

          if(!attrs["repeating_attack_" + attackid + "_dmgattr"] || attrs["repeating_attack_" + attackid + "_dmgattr"] === "0") {
            dmgattr = 0;
          } else {
            dmgattr = parseInt(attrs[attrs["repeating_attack_" + attackid + "_dmgattr"].substring(2, attrs["repeating_attack_" + attackid + "_dmgattr"].length - 1)], 10);
          }

          if(!attrs["repeating_attack_" + attackid + "_dmgskill"] || attrs["repeating_attack_" + attackid + "_dmgskill"] === "0") {
            dmgskill = 0;
          } else {
            dmgskill = parseInt(attrs[attrs["repeating_attack_" + attackid + "_dmgskill"].substring(2, attrs["repeating_attack_" + attackid + "_dmgskill"].length - 1)], 10);
          }

          var atkbase = attrs["repeating_attack_" + attackid + "_atkbase"] && isNaN(parseInt(attrs["repeating_attack_" + attackid + "_atkbase"],10)) === false ? parseInt(attrs["repeating_attack_" + attackid + "_atkbase"],10) : 0;
          var dmgbase = attrs["repeating_attack_" + attackid + "_dmgbase"] && isNaN(parseInt(attrs["repeating_attack_" + attackid + "_dmgbase"],10)) === false ? parseInt(attrs["repeating_attack_" + attackid + "_dmgbase"],10) : 0;
          var dmgroll = attrs["repeating_attack_" + attackid + "_dmgroll"] && attrs["repeating_attack_" + attackid + "_dmgroll"] != "" ? attrs["repeating_attack_" + attackid + "_dmgroll"] : 0;
          var dmgtype = attrs["repeating_attack_" + attackid + "_dmgtype"] ? attrs["repeating_attack_" + attackid + "_dmgtype"] + " " : "";

          // WEAPON ATTRIBUTES
          if(!attrs["repeating_weapons_" + weaponid + "_atkattr"] || attrs["repeating_weapons_" + weaponid + "_atkattr"] === "0" || attrs["repeating_weapons_" + weaponid + "_atkflag"] === "0" || attrs["repeating_attack_" + attackid + "_activeflag"] === "0") {
            wpnatkattr = 0;
          } else {
            wpnatkattr = parseInt(attrs[attrs["repeating_weapons_" + weaponid + "_atkattr"].substring(2, attrs["repeating_weapons_" + weaponid + "_atkattr"].length - 1)], 10);
          }

          if(!attrs["repeating_weapons_" + weaponid + "_atkskill"] || attrs["repeating_weapons_" + weaponid + "_atkskill"] === "0" || attrs["repeating_weapons_" + weaponid + "_atkflag"] === "0" || attrs["repeating_attack_" + attackid + "_activeflag"] === "0") {
            wpnatkskill = 0;
          } else {
            wpnatkskill = parseInt(attrs[attrs["repeating_weapons_" + weaponid + "_atkskill"].substring(2, attrs["repeating_weapons_" + weaponid + "_atkskill"].length - 1)], 10);
          }

          if(!attrs["repeating_weapons_" + weaponid + "_dmgattr"] || attrs["repeating_weapons_" + weaponid + "_dmgattr"] === "0" || attrs["repeating_weapons_" + weaponid + "_dmgflag"] === "0" || attrs["repeating_attack_" + attackid + "_activeflag"] === "0") {
            wpndmgattr = 0;
          } else {
            wpndmgattr = parseInt(attrs[attrs["repeating_weapons_" + weaponid + "_dmgattr"].substring(2, attrs["repeating_weapons_" + weaponid + "_dmgattr"].length - 1)], 10);
          }

          if(!attrs["repeating_weapons_" + weaponid + "_dmgskill"] || attrs["repeating_weapons_" + weaponid + "_dmgskill"] === "0" || attrs["repeating_weapons_" + weaponid + "_dmgflag"] === "0" || attrs["repeating_attack_" + attackid + "_activeflag"] === "0") {
            wpndmgskill = 0;
          } else {
            wpndmgskill = parseInt(attrs[attrs["repeating_weapons_" + weaponid + "_dmgskill"].substring(2, attrs["repeating_weapons_" + weaponid + "_dmgskill"].length - 1)], 10);
          }

          var wpnatkbase = attrs["repeating_weapons_" + weaponid + "_atkbase"] && isNaN(parseInt(attrs["repeating_weapons_" + weaponid + "_atkbase"],10)) === false && attrs["repeating_weapons_" + weaponid + "_atkflag"] != "0" && attrs["repeating_attack_" + attackid + "_activeflag"] === "1" ? parseInt(attrs["repeating_weapons_" + weaponid + "_atkbase"],10) : 0;
          var wpndmgbase = attrs["repeating_weapons_" + weaponid + "_dmgbase"] && isNaN(parseInt(attrs["repeating_weapons_" + weaponid + "_dmgbase"],10)) === false && attrs["repeating_weapons_" + weaponid + "_dmgflag"] != "0" && attrs["repeating_attack_" + attackid + "_activeflag"] === "1" ? parseInt(attrs["repeating_weapons_" + weaponid + "_dmgbase"],10) : 0;
          var wpndmgroll = attrs["repeating_weapons_" + weaponid + "_dmgroll"] && attrs["repeating_weapons_" + weaponid + "_dmgroll"] != "" && attrs["repeating_weapons_" + weaponid + "_dmgflag"] != "0" && attrs["repeating_attack_" + attackid + "_activeflag"] === "1" ? attrs["repeating_weapons_" + weaponid + "_dmgroll"] : 0;
          var wpndmgtype = attrs["repeating_weapons_" + weaponid + "_dmgtype"] && attrs["repeating_weapons_" + weaponid + "_dmgflag"] != "0" && attrs["repeating_attack_" + attackid + "_activeflag"] === "1" ? attrs["repeating_weapons_" + weaponid + "_dmgtype"] + " " : "";

          // DISPLAY CALCULATION
          if(attrs["repeating_attack_" + attackid + "_atkflag"] && attrs["repeating_attack_" + attackid + "_atkflag"] != 0) {
            atk_bonus_mod = atkbase + atkattr + atkskill;
            wpn_bonus_mod = wpnatkbase + wpnatkattr + wpnatkskill;
            bonus_mod = atk_bonus_mod + wpn_bonus_mod;
            plus_minus = bonus_mod > -1 ? "+" : "";
            bonus = plus_minus + bonus_mod;
          } else if(attrs["repeating_attack_" + attackid + "_saveflag"] && attrs["repeating_attack_" + attackid + "_saveflag"] != 0) {
            if(attrs["repeating_attack_" + attackid + "_savedc"] && attrs["repeating_attack_" + attackid + "_savedc"] === "(@{saveflat})") {
              var tempdc = isNaN(parseInt(attrs["repeating_attack_" + attackid + "_saveflat"])) === false ? parseInt(attrs["repeating_attack_" + attackid + "_saveflat"]) : "0";
            } else {
              var pb = attrs["pb"];
              var savedcattr = attrs["repeating_attack_" + attackid + "_savedc"].replace(/^[^{]*{/,"").replace(/\_.*$/,"");
              var safe_pb = attrs["pb_type"] && attrs["pb_type"] === "die" ? parseInt(pb.substring(1), 10) / 2 : parseInt(pb,10);
              var safe_attr = attrs[savedcattr + "_mod"] ? parseInt(attrs[savedcattr + "_mod"],10) : 0;
              var tempdc = 8 + safe_attr + safe_pb;
            };
            bonus = "DC" + tempdc;
          } else {
            bonus = "-";
          }

          if(attrs["repeating_attack_" + attackid + "_dmgflag"] && attrs["repeating_attack_" + attackid + "_dmgflag"] != 0) {
            var atkflat = dmgbase + dmgattr + dmgskill;
            var wpnflat = wpndmgbase + wpndmgattr + wpndmgskill;
            var dmgflat = atkflat + wpnflat;
            if (attrs["repeating_attack_" + attackid + "_dmg2flag"] && attrs["repeating_attack_" + attackid + "_dmg2flag"] != 0) {
              if(wpndmgroll === 0 && wpnflat === 0) {
                dmg = 0;
              }
              if(wpnflat != 0) {
                dmg = wpnflat;
              }
              if(wpnflat != 0 && wpndmgroll != 0) {
                dmg = wpndmgroll.startsWith("-") ? dmg : dmg + "+";
              }
              if(wpndmgroll != 0) {
                dmg = dmg + wpndmgroll;
              }
              dmg = dmg + " " + wpndmgtype;

              if(dmgroll === 0 && atkflat === 0) {
                dmg2 = 0;
              }
              if(atkflat != 0) {
                dmg2 = atkflat;
              }
              if(atkflat != 0 && dmgroll != 0) {
                dmg2 = dmgroll.startsWith("-") ? dmg2 : dmg2 + "+";
              }
              if(dmgroll != 0) {
                dmg2 = dmg2 + dmgroll;
              }
              dmg2 = dmg2 + " " + dmgtype;
            } else {
              if(dmgroll === 0 && dmgflat === 0) {
                dmg = 0;
              }
              if(dmgflat != 0) {
                dmg = dmgflat;
              }
              if(dmgflat != 0 && wpndmgroll != 0) {
                dmg = wpndmgroll.startsWith("-") ? dmg : dmg + "+";
              }
              if(wpndmgroll != 0) {
                dmg = dmg + wpndmgroll;
              }
              if(dmgflat != 0 && (wpndmgroll == 0 || wpndmgroll.startsWith("-")) && dmgroll != 0) {
                dmg = dmgroll.startsWith("-") ? dmg : dmg + "+";
              }
              if(dmgroll != 0) {
                dmg = dmg + dmgroll;
              }
              dmg = dmg + " " + wpndmgtype;
              dmg2 = "";
            }
          } else {
            dmg = "";
            dmg2 = "";
          }

          var dmgspacer = attrs["repeating_attack_" + attackid + "_dmgflag"] && attrs["repeating_attack_" + attackid + "_dmgflag"] != 0 && attrs["repeating_attack_" + attackid + "_dmg2flag"] && attrs["repeating_attack_" + attackid + "_dmg2flag"] != 0 ? "+ " : "";
          var critrange = attrs["critrange"] && !isNaN(parseInt(attrs["critrange"],10)) ? parseInt(attrs["critrange"],10) : 20;
          var wpncritange = critrange;
          if (attrs["repeating_weapons_" + weaponid + "_atkcritrange"] && attrs["repeating_weapons_" + weaponid + "_atkcritrange"] != "") {
            let critrangemod = attrs["repeating_weapons_" + weaponid + "_atkcritrange"];
            if(critrangemod.indexOf("+") > -1) {
              critrangemod = !isNaN(parseInt(critrangemod.replace(/[^0-9]/g, ""), 10)) ? parseInt(critrangemod.replace(/[^0-9]/g, ""), 10) : false;
              wpncritange = critrangemod ? wpncritange + critrangemod : wpncritange;
            }
            else if(critrangemod.indexOf("-") > -1) {
              critrangemod = !isNaN(parseInt(critrangemod.replace(/[^0-9]/g, ""), 10)) ? parseInt(critrangemod.replace(/[^0-9]/g, ""), 10) : false;
              wpncritange = critrangemod ? wpncritange - critrangemod : wpncritange;
            }
            else {
              critrangemod = !isNaN(parseInt(critrangemod.replace(/[^0-9]/g, ""), 10)) ? parseInt(critrangemod.replace(/[^0-9]/g, ""), 10) : false;
              wpncritange = critrangemod ? critrangemod : wpncritange;
            }
          }
          attrs["repeating_weapons_" + weaponid + "_atkcritrange"] && !isNaN(parseInt(attrs["repeating_weapons_" + weaponid + "_atkcritrange"],10)) ? parseInt(attrs["repeating_weapons_" + weaponid + "_atkcritrange"],10) : critrange;
          var atkcritrange = critrange;
          if (attrs["repeating_attack_" + attackid + "_atkcritrange"] && attrs["repeating_attack_" + attackid + "_atkcritrange"] != "") {
            let critrangemod = attrs["repeating_attack_" + attackid + "_atkcritrange"];
            if(critrangemod.indexOf("+") > -1) {
              critrangemod = !isNaN(parseInt(critrangemod.replace(/[^0-9]/g, ""), 10)) ? parseInt(critrangemod.replace(/[^0-9]/g, ""), 10) : false;
              atkcritrange = critrangemod ? atkcritrange + critrangemod : atkcritrange;
            }
            else if(critrangemod.indexOf("-") > -1) {
              critrangemod = !isNaN(parseInt(critrangemod.replace(/[^0-9]/g, ""), 10)) ? parseInt(critrangemod.replace(/[^0-9]/g, ""), 10) : false;
              atkcritrange = critrangemod ? atkcritrange - critrangemod : atkcritrange;
            }
            else {
              critrangemod = !isNaN(parseInt(critrangemod.replace(/[^0-9]/g, ""), 10)) ? parseInt(critrangemod.replace(/[^0-9]/g, ""), 10) : false;
              atkcritrange = critrangemod ? critrangemod : atkcritrange;
            }
          }
          atkcritrange = (atkcritrange < wpncritange) ? atkcritrange : wpncritange;
          var critical_strike = attrs["critical_strike"] && !isNaN(parseInt(attrs["critical_strike"], 10)) ? attrs["critical_strike"] : 0;
          var crit1 = attrs["repeating_attack_" + attackid + "_dmgcustcrit"] && attrs["repeating_attack_" + attackid + "_dmgcustcrit"] != "" ? critical_strike + " + " + attrs["repeating_attack_" + attackid + "_dmgcustcrit"] : critical_strike;
          var crit2 = attrs["repeating_weapons_" + weaponid + "_dmgcustcrit"] && attrs["repeating_weapons_" + weaponid + "_dmgcustcrit"] != "" ? attrs["repeating_weapons_" + weaponid + "_dmgcustcrit"] : 0;
          var r1 = attrs["repeating_attack_" + attackid + "_atkflag"] && attrs["repeating_attack_" + attackid + "_atkflag"] != 0 ? "1d20" : "0d20";
          var r2 = attrs["repeating_attack_" + attackid + "_atkflag"] && attrs["repeating_attack_" + attackid + "_atkflag"] != 0 ? "@{rtype}" : "{{r2=[[0d20";

          // ROLL FORMATTING
          if(attrs["repeating_attack_" + attackid + "_atkflag"] && attrs["repeating_attack_" + attackid + "_atkflag"] != 0) {
            if(wpn_bonus_mod != 0) {hbonus = hbonus + " + " + wpn_bonus_mod + "[WPN]"};
            if(atk_bonus_mod != 0) {hbonus = hbonus + " + " + atk_bonus_mod + "[ATK]"};
          } else {
            hbonus = "";
          }
          if(attrs["repeating_attack_" + attackid + "_dmg2flag"] && attrs["repeating_attack_" + attackid + "_dmg2flag"] != 0) {
            if(attrs["repeating_attack_" + attackid + "_dmgflag"] && attrs["repeating_attack_" + attackid + "_dmgflag"] != 0) {
              if(wpnflat != 0) {hwpndmg = hwpndmg + wpnflat};
              if(wpndmgroll != 0) {hwpndmg = wpndmgroll.startsWith("-") ? hwpndmg + wpndmgroll : hwpndmg + "+" + wpndmgroll};
              if(atkflat != 0) {hatkdmg = hatkdmg + atkflat};
              if(dmgroll != 0) {hatkdmg = dmgroll.startsWith("-") ? hatkdmg + dmgroll : hatkdmg + "+" + dmgroll};
              hdmg1 = hwpndmg === "" ? "0" : hwpndmg + "[WPN]";
              hdmg2 = hatkdmg === "" ? "0" : hatkdmg + "[ATK]";
            } else {
              hdmg1 = "0";
              hdmg2 = "0";
            }
          } else {
            if(attrs["repeating_attack_" + attackid + "_dmgflag"] && attrs["repeating_attack_" + attackid + "_dmgflag"] != 0) {
              if(wpnflat != 0) {hwpndmg = hwpndmg + wpnflat};
              if(wpndmgroll != 0) {hwpndmg = wpndmgroll.startsWith("-") ? hwpndmg + wpndmgroll : hwpndmg + "+" + wpndmgroll};
              if(atkflat != 0) {hatkdmg = hatkdmg + atkflat};
              if(dmgroll != 0) {hatkdmg = dmgroll.startsWith("-") ? hatkdmg + dmgroll : hatkdmg + "+" + dmgroll};
              if(hwpndmg != "") {hdmg1 = hdmg1 + hwpndmg + "[WPN]"};
              if(hatkdmg != "") {hdmg1 = hwpndmg === "" ? hdmg1 + hatkdmg + "[ATK]" : hdmg1 + " + " + hatkdmg + "[ATK]";};
            } else {
              hdmg1 = "0";
            }
            hdmg2 = "0";
          }

          var globaldamage = `[[${attrs.global_damage_mod_roll && attrs.global_damage_mod_roll !== "" ? attrs.global_damage_mod_roll : "0"}]]`;
          var globaldamagecrit = `[[${attrs.global_damage_mod_crit && attrs.global_damage_mod_crit !== "" ? attrs.global_damage_mod_crit : "0"}]]`;

          var ammo = (attrs["repeating_weapons_" + weaponid + "_ammo"]) ? attrs["repeating_weapons_" + weaponid + "_ammo"] : "";

          if(attrs.dtype === "1") {
            rollbase = "@{wtype}&{template:atkdmg} {{mod=@{atkbonus}}} {{rname=@{atkname}}} {{r1=[[" + r1 + "cs>" + atkcritrange + hbonus + "]]}} " + r2 + "cs" + atkcritrange + hbonus + "]]}} @{atkflag} {{range=@{atkrange}}} @{dmgflag} {{dmg1=[[" + hdmg1 + "]]}} {{dmg1type=" + dmgtype + "}} @{dmg2flag} {{dmg2=[[" + hdmg2 + "]]}} {{dmg2type=" + wpndmgtype + "}} {{crit1=[[" + crit1 + "[CRIT]]]}} {{crit2=[[" + crit2 + "[CRIT]]]}} @{saveflag} {{desc=@{atk_desc}}} @{hldmg} " + hldmgcrit + "  {{globalattack=@{global_attack_mod}}} {{globaldamage=" + globaldamage + "}} {{globaldamagecrit=" + globaldamagecrit + "}} {{globaldamagetype=@{global_damage_mod_type}}} ammo=" + ammo + " @{charname_output}";
          } else if(attrs["repeating_attack_" + attackid + "_atkflag"] && attrs["repeating_attack_" + attackid + "_atkflag"] != 0) {
            rollbase = "@{wtype}&{template:atk} {{mod=@{atkbonus}}} {{rname=[@{atkname}](~repeating_attack_attack_dmg)}} {{rnamec=[@{atkname}](~repeating_attack_attack_crit)}} {{r1=[[" + r1 + "cs>" + atkcritrange + hbonus + "]]}} " + r2 + "cs>" + atkcritrange + hbonus + "]]}} {{range=@{atkrange}}} {{desc=@{atk_desc}}} {{globalattack=@{global_attack_mod}}} ammo=" + ammo + " @{charname_output}";
          } else if(attrs["repeating_attack_" + attackid + "_dmgflag"] && attrs["repeating_attack_" + attackid + "_dmgflag"] != 0) {
            rollbase = "@{wtype}&{template:dmg} {{rname=@{atkname}}} @{atkflag} {{range=@{atkrange}}} @{dmgflag} {{dmg1=[[" + hdmg1 + "]]}} {{dmg1type=" + dmgtype + "}} @{dmg2flag} {{dmg2=[[" + hdmg2 + "]]}} {{dmg2type=" + wpndmgtype + "}} @{saveflag} {{desc=@{atk_desc}}} @{hldmg} {{globaldamage=" + globaldamage + "}} {{globaldamagetype=@{global_damage_mod_type}}} ammo=" + ammo + " @{charname_output}"
          } else {
            rollbase = "@{wtype}&{template:dmg} {{rname=@{atkname}}} @{atkflag} {{range=@{atkrange}}} @{saveflag} {{desc=@{atk_desc}}} ammo=" + ammo + " @{charname_output}"
          }

          update["repeating_attack_" + attackid + "_rollbase_dmg"] = "@{wtype}&{template:dmg} {{rname=@{atkname}}} @{atkflag} {{range=@{atkrange}}} @{dmgflag} {{dmg1=[[" + hdmg1 + "]]}} {{dmg1type=" + wpndmgtype + "}} @{dmg2flag} {{dmg2=[[" + hdmg2 + "]]}} {{dmg2type=" + dmgtype + "}} @{saveflag} {{desc=@{atk_desc}}} @{hldmg} {{globaldamage=" + globaldamage + "}} {{globaldamagetype=@{global_damage_mod_type}}} @{charname_output}";
          update["repeating_attack_" + attackid + "_rollbase_crit"] = "@{wtype}&{template:dmg} {{crit=1}} {{rname=@{atkname}}} @{atkflag} {{range=@{atkrange}}} @{dmgflag} {{dmg1=[[" + hdmg1 + "]]}} {{dmg1type=" + wpndmgtype + "}} @{dmg2flag} {{dmg2=[[" + hdmg2 + "]]}} {{dmg2type=" + dmgtype + "}} {{crit1=[[" + crit1 + "]]}} {{crit2=[[" + crit2 + "]]}} @{saveflag} {{desc=@{atk_desc}}} @{hldmg} " + hldmgcrit + " {{globaldamage=" + globaldamage + "}} {{globaldamagecrit=" + globaldamagecrit + "}} {{globaldamagetype=@{global_damage_mod_type}}} @{charname_output}";
          update["repeating_attack_" + attackid + "_atkbonus"] = bonus;
          update["repeating_attack_" + attackid + "_atkdmgtype"] = dmg + dmgspacer + dmg2 + " ";
          update["repeating_attack_" + attackid + "_rollbase"] = rollbase;

          if((attrs["repeating_attack_" + attackid + "_itemid"] && attrs["repeating_attack_" + attackid + "_itemid"] != "") && (!source || (source && source != "item"))) {
            var itemid = attrs["repeating_attack_" + attackid + "_itemid"];
            callbacks.push( function() {update_item_from_attack(itemid, attackid);} );
          }

          setAttrs(update, {silent: true}, function() {callbacks.forEach(function(callback) {callback(); })} );
        });
      });
    });
  };

  var remove_attack = function(attackid) {
    removeRepeatingRow("repeating_attack_" + attackid);
  };

  var remove_weapon = function(weaponid) {
    removeRepeatingRow("repeating_weapons_" + weaponid);
  };

  var remove_armor = function(armorid) {
    removeRepeatingRow("repeating_armor_" + armorid);
  };

  var update_equipped_weapon = function(weaponid) {
    var update = {};
    var callbacks = [];
    getSectionIDs("repeating_weapons", function(idarray) {
      var weapon_attrs = [];
      _.each(idarray, function(id) {
        weapon_attrs.push("repeating_weapons_" + id + "_equipped");
      });
      getAttrs(weapon_attrs, function(attrs) {
        _.each(idarray, function(id) {
          if(id != weaponid) {
            if(attrs["repeating_weapons_" + id + "_equipped"] && attrs["repeating_weapons_" + id + "_equipped"] === "1") {
              update["repeating_weapons_" + id + "_equipped"] = 0;
            }
          } else {
            if(attrs["repeating_weapons_" + id + "_equipped"] && attrs["repeating_weapons_" + id + "_equipped"] === "1") {
              update["equippedweaponid"] = id;
            } else {
              update["equippedweaponid"] = "";
            }
          }
        });
        callbacks.push(() => {update_active_attacks();});
        setAttrs(update, {silent:true}, () => {callbacks.forEach((callback) => {callback();})});
      });
    });
  };

  var reload_weapon = function(weaponid) {
    console.log("RELOADING!");
    var attrs_to_get = [`repeating_weapons_${weaponid}_mag`];
    getAttrs(attrs_to_get, function(attrs) {
      var update = {};
      var new_shots = attrs[`repeating_weapons_${weaponid}_mag`];
      update[`repeating_weapons_${weaponid}_shots`] = new_shots;
      setAttrs(update, {silent:true}, update_active_attacks());
    });
  }

  var update_equipped_armor = function(armorid) {
    console.log("UPDATING EQUIPPED ARMOR!");
    var update = {};
    var callbacks = [];
    var attrs_to_get = [];
    getSectionIDs("repeating_armor", function(idarray) {
      _.each(idarray, function(id) {
        attrs_to_get.push("repeating_armor_" + id + "_equipped");
        attrs_to_get.push("repeating_armor_" + id + "_type");
      });
      getAttrs(attrs_to_get, function(attrs) {
        if(attrs["repeating_armor_" + armorid + "_type"] === "clothing") {
          // Update clothing
          _.each(idarray, function(id) {
            if(id != armorid) {
              if(attrs["repeating_armor_" + id + "_equipped"] && attrs["repeating_armor_" + id + "_equipped"] === "1"
              && attrs["repeating_armor_" + id + "_type"] && attrs["repeating_armor_" + id + "_type"] === "clothing") {
                update["repeating_armor_" + id + "_equipped"] = 0;
              }
            } else {
              if(attrs["repeating_armor_" + id + "_equipped"] && attrs["repeating_armor_" + id + "_equipped"] === "1") {
                update["equippedclothingid"] = id;
              } else {
                update["equippedclothingid"] = "";
              }
            }
          });
          setAttrs(update, {silent:true});
        } else if(attrs["repeating_armor_" + armorid + "_type"] != "clothing" && attrs["repeating_armor_" + armorid + "_type"] != "accessory") {
          // Update armor
          _.each(idarray, function(id) {
            if(id != armorid) {
              if(attrs["repeating_armor_" + id + "_equipped"] && attrs["repeating_armor_" + id + "_equipped"] === "1"
              && attrs["repeating_armor_" + id + "_type"] && attrs["repeating_armor_" + id + "_type"] != "clothing" && attrs["repeating_armor_" + armorid + "_type"] != "accessory") {
                update["repeating_armor_" + id + "_equipped"] = 0;
              }
            } else {
              if(attrs["repeating_armor_" + id + "_equipped"] && attrs["repeating_armor_" + id + "_equipped"] === "1") {
                update["equippedarmorid"] = id;
              } else {
                update["equippedarmorid"] = "";
              }
            }
          });
          callbacks.push(() => {update_defense();});
          callbacks.push(() => {update_speed();});
          setAttrs(update, {silent:true}, () => {callbacks.forEach((callback) => {callback();})});
        }
      });
    });
  };

  var update_active_attacks = function() {
    console.log("UPDATING ACTIVE ATTACKS");
    var update = {};
    var callbacks = [];
    var attrs_to_get = ["equippedweaponid"];
    attrs_to_get.push("equippedweaponid");
    getAttrs(attrs_to_get, function(attrs) {
      var weaponid = attrs["equippedweaponid"];
      attrs_to_get.push("repeating_weapons_" + weaponid + "_type");
      attrs_to_get.push("repeating_weapons_" + weaponid + "_class");
      attrs_to_get.push("repeating_weapons_" + weaponid + "_shots");
      getSectionIDs("repeating_attack", function(attack_idarray) {
        _.each(attack_idarray, function(id) {
          attrs_to_get.push("repeating_attack_" + id + "_activeflag");
          attrs_to_get.push("repeating_attack_" + id + "_type");
          attrs_to_get.push("repeating_attack_" + id + "_class");
          attrs_to_get.push("repeating_attack_" + id + "_cooldown");
          attrs_to_get.push("repeating_attack_" + id + "_cooldowncur");
        });
        getAttrs(attrs_to_get, function(attrs) {
          _.each(attack_idarray, function(id) {
            if ((attrs["repeating_attack_" + id + "_type"] && attrs["repeating_attack_" + id + "_type"] === attrs["repeating_weapons_" + weaponid + "_type"] || attrs["repeating_attack_" + id + "_type"] === "none")
            && (attrs["repeating_attack_" + id + "_class"] && attrs["repeating_attack_" + id + "_class"] === attrs["repeating_weapons_" + weaponid + "_class"] || attrs["repeating_attack_" + id + "_class"] === "none")
            && (attrs["repeating_attack_" + id + "_cooldown"] && parseInt(attrs["repeating_attack_" + id + "_cooldown"],10) === attrs["repeating_attack_" + id + "_cooldowncur"])
            && attrs["repeating_weapons_" + weaponid + "_shots"] != "0" ) {
              update["repeating_attack_" + id + "_activeflag"] = "1";
            } else {
              update["repeating_attack_" + id + "_activeflag"] = "0";
            }
          });
          callbacks.push(() => {update_attacks("all");});
          setAttrs(update, {silent:true}, () => {callbacks.forEach((callback) => {callback();})});
        });
      });
    });
  };

  var update_attack_type_flag = function() {
    console.log("UPDATING ATTACK TYPE FLAG");
    var attrs_to_get = [];
    getSectionIDs("repeating_attack", function(idarray) {
      _.each(idarray, function(id) {
        attrs_to_get.push("repeating_attack_" + id + "_type");
      });
      getAttrs(attrs_to_get, function(attrs) {
        var update = {};
        _.each(idarray, function(id) {
          if(attrs["repeating_attack_" + id + "_type"]) {
            if(attrs["repeating_attack_" + id + "_type"] === "melee") {
              update["repeating_attack_" + id + "_typeflag"] = "melee";
            } else if(attrs["repeating_attack_" + id + "_type"] === "ranged") {
              update["repeating_attack_" + id + "_typeflag"] = "ranged";
            } else {
              update["repeating_attack_" + id + "_typeflag"] = "none";
            }
          }
        });
        setAttrs(update, {silent:true});
      });
    });
  };

  var update_weapon_type_flag = function() {
    console.log("UPDATING WEAPON TYPE FLAG");
    var attrs_to_get = [];
    getSectionIDs("repeating_weapons", function(idarray) {
      _.each(idarray, function(id) {
        attrs_to_get.push("repeating_weapons_" + id + "_type");
      });
      getAttrs(attrs_to_get, function(attrs) {
        var update = {};
        _.each(idarray, function(id) {
          if(attrs["repeating_weapons_" + id + "_type"]) {
            if(attrs["repeating_weapons_" + id + "_type"] === "melee") {
              update["repeating_weapons_" + id + "_typeflag"] = "melee";
              update["repeating_weapons_" + id + "_magflag"] = "0";
            } else if(attrs["repeating_weapons_" + id + "_type"] === "ranged") {
              update["repeating_weapons_" + id + "_typeflag"] = "ranged";
              update["repeating_weapons_" + id + "_magflag"] = "1";
            } else {
              update["repeating_weapons_" + id + "_typeflag"] = "none";
            }
          }
        });
        setAttrs(update, {silent:true});
      });
    });
  };

  var update_attack_dmg2_flag = function() {
    console.log("UPDATING DMG2 FLAG");
    var update = {};
    var callbacks = [];
    var attrs_to_get = [];
    attrs_to_get.push("equippedweaponid");
    getAttrs(attrs_to_get, function(attrs) {
      var weaponid = attrs["equippedweaponid"];
      attrs_to_get.push("repeating_weapons_" + weaponid + "_dmgflag");
      attrs_to_get.push("repeating_weapons_" + weaponid + "_dmgtype");
      getSectionIDs("repeating_attack", function(attack_idarray) {
        _.each(attack_idarray, function(id) {
          attrs_to_get.push("repeating_attack_" + id + "_dmgflag");
          attrs_to_get.push("repeating_attack_" + id + "_dmgtype");
        });
        getAttrs(attrs_to_get, function(attrs) {
          _.each(attack_idarray, function(id) {
            var dmg2flag;
            if (attrs["repeating_attack_" + id + "_dmgtype"] && attrs["repeating_attack_" + id + "_dmgtype"] != attrs["repeating_weapons_" + weaponid + "_dmgtype"]){
              dmg2flag = "{{damage=1}} {{dmg2flag=1}}";
            } else {
              dmg2flag = 0;
            }
            update["repeating_attack_" + id + "_dmg2flag"] = dmg2flag;
          });
          callbacks.push(() => {update_attacks("all");});
          setAttrs(update, {silent:true}, () => {callbacks.forEach((callback) => {callback();})});
        });
      });
    });
  };

  const remove_resource = (id) => {
    const attr = (id === "other_resource") ? id : `repeating_resource_${id}_itemid`;
    let update = {};
    getAttrs([`${attr}`], (v) => {
      const itemid = v[`${attr}`];
      //Uncheck Use As A Resource in inventory for an item if its resource row is deleted
      if (itemid) {
        update[`repeating_inventory_${itemid}_useasresource`]  = 0;
        update[`repeating_inventory_${itemid}_itemresourceid`] = "";
      };
      if (id == "other_resource") {
        update["other_resource"]        = "";
        update["other_resource_name"]   = "";
        update["other_resource_itemid"] = "";
        setAttrs(update, {silent: true});
      } else {
        const currentID = id.replace("repeating_resource_", "").substring(0,20);
        const side  = (id.includes("left")) ? `right` : `left`;
        //Get the inputs for the opposite side to see if they are empty.
        //If they are empty delete the entire row. Otherwise set the side that was the source of this event to empty strings
        getAttrs([`repeating_resource_${currentID}_resource_${side}`, `repeating_resource_${currentID}_resource_${side}_name`, `repeating_resource_${currentID}_resource_${side}_max`], (v) => {
          const Name  = v[`repeating_resource_${currentID}_resource_${side}_name`] || false;
          const Value = v[`repeating_resource_${currentID}_resource_${side}`] || false;
          const Max   = v[`repeating_resource_${currentID}_resource_${side}_max`] || false;
          if (!Name && !Value && !Max) {
            removeRepeatingRow(`repeating_resource_${currentID}`);
          } else {
            update[`repeating_resource_${id}`]        = "";
            update[`repeating_resource_${id}_name`]   = "";
            update[`repeating_resource_${id}_max`]    = "";
            update[`repeating_resource_${id}_itemid`] = "";
          };
          setAttrs(update, {silent: true});
        });
      };
    });
  };

  const update_weight = function() {
    console.log("UPDATING WEIGHT!");
    let update = {};
    let wtotal = 0;
    let attrs_to_get = ["cp","sp","ep","gp","pp","encumberance_setting","strength","size","carrying_capacity_mod","global_mods"];
    getSectionIDs("repeating_inventory", (idarray) => {
      _.each(idarray, (currentID, i) => {
        attrs_to_get.push(`repeating_inventory_${currentID}_itemweight`);
        attrs_to_get.push(`repeating_inventory_${currentID}_itemcount`);
      });
      getAttrs(attrs_to_get, (wgt_attrs) => {
        let coinWeight = 0;
        coinWeight += (isNaN(parseInt(wgt_attrs["cp"], 10)) === false) ? parseInt(wgt_attrs["cp"], 10) : 0;
        wtotal = wtotal + ((coinWeight) / 50);

        _.each(idarray, (currentID, i) => {
          if (wgt_attrs[`repeating_inventory_${currentID}_itemweight`] && isNaN(parseInt(wgt_attrs[`repeating_inventory_${currentID}_itemweight`], 10)) === false) {
            count = wgt_attrs[`repeating_inventory_${currentID}_itemcount`] && isNaN(parseFloat(wgt_attrs[`repeating_inventory_${currentID}_itemcount`])) === false ? parseFloat(wgt_attrs[`repeating_inventory_${currentID}_itemcount`]) : 1;
            wtotal = wtotal + (parseFloat(wgt_attrs[`repeating_inventory_${currentID}_itemweight`]) * count);
          }
        });
        wtotal = Math.floor(wtotal);
        update["weighttotal"] = wtotal;

        const str_base = parseInt(wgt_attrs.strength, 10);
        let size_multiplier = 1;
        if (wgt_attrs["size"] && wgt_attrs["size"] != "") {
          const size = wgt_attrs["size"].toLowerCase().trim();
          size_multiplier =
            (size === "tiny") ? .5 : (size === "large") ? 2 : (size === "huge") ? 4 : (size === "gargantuan") ? 8 : size_multiplier;
        };
        let cap = str_base * 10 * size_multiplier;
        let cap_bonus = 0;
        if(wgt_attrs["global_mods"] && wgt_attrs["global_mods"] != "") {
          var mods = wgt_attrs["global_mods"].toLowerCase().split(",");
          _.each(mods, function(mod) {
            if(mod.indexOf("wgt" > -1) || mod.indexOf("weight") > -1 || mod.indexOf("capacity") > -1) {
              if(mod.indexOf(":") > -1) {
                var new_cap = !isNaN(parseInt(mod.replace(/[^0-9]/g, ""), 10)) ? parseInt(mod.replace(/[^0-9]/g, ""), 10) : false;
                cap = new_cap && new_cap > cap ? new_cap : cap;
              } else if(mod.indexOf("-") > -1) {
                var new_cap_bonus = !isNaN(parseInt(mod.replace(/[^0-9]/g, ""), 10)) ? parseInt(mod.replace(/[^0-9]/g, ""), 10) : false;
                cap_bonus = new_cap_bonus ? cap_bonus - new_cap_bonus : cap_bonus;
              } else {
                var new_cap_bonus = !isNaN(parseInt(mod.replace(/[^0-9]/g, ""), 10)) ? parseInt(mod.replace(/[^0-9]/g, ""), 10) : false;
                cap_bonus = new_cap_bonus ? cap_bonus + new_cap_bonus : cap_bonus;
              }
            };
          });
        }
        cap += cap_bonus
        // Parse the carrying capacitiy modificator if any
        if(wgt_attrs.carrying_capacity_mod) {
          const operator = wgt_attrs.carrying_capacity_mod.substring(0,1);
          const value    = wgt_attrs.carrying_capacity_mod.substring(1);
          if(["*","x","+","-"].indexOf(operator) > -1 && isNaN(parseFloat(value,10)) === false) {
            cap =
              (operator === "*" || operator == "x") ? cap * parseFloat(value,10) :
              (operator === "+") ? cap + parseFloat(value,10) :
              (operator === "-") ? cap - parseFloat(value,10) :
              cap;
          }
        }
        cap = Math.floor(cap);
        update["carrying_capacity"] = cap;

        if (!wgt_attrs.encumberance_setting || wgt_attrs.encumberance_setting === "0") {
          update["encumberance"] = (wtotal > cap) ? "OVER ENCUMBERED" : " ";
        } else if (wgt_attrs.encumberance_setting === "1") {
          update["encumberance"] =
            (wtotal > cap * 1.5) ? "IMMOBILE" :
            (wtotal > cap) ? "HEAVILY ENCUMBERED" :
            (wtotal > cap * 0.5)  ? "ENCUMBERED" :
            " ";
        } else {
          update["encumberance"] = " ";
        }
        setAttrs(update, {silent: true});
      });
    });
  };

  var update_hp_max = function() {
    console.log("UPDATING MAX HP!")
    attrs_to_get = ["level", "endurance", "global_mods"];
    getSectionIDs("repeating_hpmod", function(idArray) {
      _.each(idArray, function(currentId, i) {
        attrs_to_get.push("repeating_hpmod_" + currentId + "_mod");
      });
      getAttrs(attrs_to_get, function(hp_attrs) {
        var update = {};
        var hp_base = 30;
        var endurance = parseInt(hp_attrs["endurance"], 10);
        var level = parseInt(hp_attrs["level"], 10);
        var hp_mod = 0;
        _.each(idArray, function(currentId, i) {
          if(hp_attrs["repeating_hpmod_" + currentId + "_mod"] && !isNaN(parseInt(hp_attrs["repeating_hpmod_" + currentId + "_mod"], 10))) {
            hp_mod += parseInt(hp_attrs["repeating_hpmod_" + currentId + "_mod"], 10);
          }
        });
        if(hp_attrs["global_mods"] && hp_attrs["global_mods"] != "") {
          var mods = hp_attrs["global_mods"].toLowerCase().split(",");
          _.each(mods, function(mod) {
            if(mod.indexOf("hp") > -1 || mod.indexOf("health") > -1 || mod.indexOf("hit points") > -1) {
              if(mod.indexOf(":") > -1) {
                var new_base = !isNaN(parseInt(mod.replace(/[^0-9]/g, ""), 10)) ? parseInt(mod.replace(/[^0-9]/g, ""), 10) : false;
                hp_base = new_base && new_base > hp_base ? new_base : hp_base;
              }
              else if(mod.indexOf("-") > -1) {
                var new_mod = !isNaN(parseInt(mod.replace(/[^0-9]/g, ""), 10)) ? parseInt(mod.replace(/[^0-9]/g, ""), 10) : false;
                hp_mod = new_mod ? hp_mod - new_mod : hp_mod;
              }
              else {
                var new_mod = !isNaN(parseInt(mod.replace(/[^0-9]/g, ""), 10)) ? parseInt(mod.replace(/[^0-9]/g, ""), 10) : false;
                hp_mod = new_mod ? hp_mod + new_mod : hp_mod;
              }
            };
          });
        }
        var final_hp_max = hp_base + endurance + level + hp_mod;
        update["hp_max"] = final_hp_max;
        setAttrs(update, {silent: true});
      });
    });
  };

  var update_defense = function() {
    console.log("UPDATING DEFENSE!");
    var attrs_to_get = ["equippedarmorid", "agility_mod", "pb", "global_mods"];
    getAttrs(attrs_to_get, function(def_attrs){
      var equipped_armor_id = def_attrs["equippedarmorid"];
      attrs_to_get.push("repeating_armor_" + equipped_armor_id + "_type");
      getSectionIDs("repeating_defmod", function(defmod_idarray){
        _.each(defmod_idarray, function(currentId, i) {
          attrs_to_get.push("repeating_defmod_" + currentId + "_mod");
        });
        getAttrs(attrs_to_get, function(def_attrs) {
          var update = {};
          var def_base = 10;
          var agility_mod = parseInt(def_attrs["agility_mod"], 10);
          var pb = parseInt(def_attrs["pb"], 10);
          var armor_mod = 0;
          var def_mod = 0;
          switch(def_attrs["repeating_armor_" + equipped_armor_id + "_type"]) {
            case "light": armor_mod = -1; break;
            case "medium": armor_mod = -2; break;
            case "heavy": armor_mod = -3; break;
            case "power": armor_mod = -4; break;
          }
          _.each(defmod_idarray, function(currentId, i) {
            if(def_attrs["repeating_defmod_" + currentId + "_mod"] && !isNaN(parseInt(def_attrs["repeating_defmod_" + currentId + "_mod"], 10))) {
              def_mod += parseInt(def_attrs["repeating_defmod_" + currentId + "_mod"], 10);
            }
          });
          if(def_attrs["global_mods"] && def_attrs["global_mods"] != "") {
            var mods = def_attrs["global_mods"].toLowerCase().split(",");
            _.each(mods, function(mod) {
              if(mod.indexOf("def") > -1 || mod.indexOf("defense") > -1) {
                if(mod.indexOf(":") > -1) {
                  var new_base = !isNaN(parseInt(mod.replace(/[^0-9]/g, ""), 10)) ? parseInt(mod.replace(/[^0-9]/g, ""), 10) : false;
                  def_base = new_base && new_base > def_base ? new_base : def_base;
                }
                else if(mod.indexOf("-") > -1) {
                  var new_mod = !isNaN(parseInt(mod.replace(/[^0-9]/g, ""), 10)) ? parseInt(mod.replace(/[^0-9]/g, ""), 10) : false;
                  def_mod = new_mod ? def_mod - new_mod : def_mod;
                }
                else {
                  var new_mod = !isNaN(parseInt(mod.replace(/[^0-9]/g, ""), 10)) ? parseInt(mod.replace(/[^0-9]/g, ""), 10) : false;
                  def_mod = new_mod ? def_mod + new_mod : def_mod;
                }
              };
            });
          }
          var final_def = def_base + agility_mod + armor_mod + def_mod + pb;
          final_def = final_def > 0 ? final_def : 0;
          update["def"] = final_def;
          setAttrs(update, {silent: true});
        });
      });
    });
  };

  var update_dt = function() {
    console.log("UPDATE DT");
    var dt_attrs = ["global_mods"];
    getSectionIDs("repeating_dtmod", function(dt_idarray) {
      _.each(dt_idarray, function(currentID, i) {
        dt_attrs.push("repeating_dtmod_" + currentID + "_mod");
      });
      getSectionIDs("repeating_armor", function(armor_idarray) {
        _.each(armor_idarray, function(currentID, i) {
          dt_attrs.push("repeating_armor_" + currentID + "_equipped");
          dt_attrs.push("repeating_armor_" + currentID + "_armordt");
          dt_attrs.push("repeating_armor_" + currentID + "_type");
        });
        getAttrs(dt_attrs, function(dt_attrs) {
          var update = {};
          var dt_base = 0;
          var armor_dt = 0;
          var dt_mod = 0;
          var final_dt = 0;
          _.each(armor_idarray, function(currentID, i) {
            if(dt_attrs["repeating_armor_" + currentID + "_equipped"] && dt_attrs["repeating_armor_" + currentID + "_equipped"] === "1"
            && dt_attrs["repeating_armor_" + currentID + "_armordt"] && !isNaN(parseInt(dt_attrs["repeating_armor_" + currentID + "_armordt"], 10))) {
              armor_dt += parseInt(dt_attrs["repeating_armor_" + currentID + "_armordt"], 10);
            }
          });
          _.each(dt_idarray, function(currentID, i) {
            if(!isNaN(parseInt(dt_attrs["repeating_dtmod_" + currentID + "_mod"], 10))) {
              dt_mod += parseInt(dt_attrs["repeating_dtmod_" + currentID + "_mod"], 10);
            }
          });
          if(dt_attrs["global_mods"] && dt_attrs["global_mods"] != "") {
            var mods = dt_attrs["global_mods"].toLowerCase().split(",");
            _.each(mods, function(mod) {
              if(mod.indexOf("dt") > -1 || mod.indexOf("damage threshold") > -1) {
                if(mod.indexOf(":") > -1) {
                  var new_base = !isNaN(parseInt(mod.replace(/[^0-9]/g, ""), 10)) ? parseInt(mod.replace(/[^0-9]/g, ""), 10) : false;
                  dt_base = new_base && new_base > dt_base ? new_base : dt_base;
                }
                else if(mod.indexOf("-") > -1) {
                  var new_mod = !isNaN(parseInt(mod.replace(/[^0-9]/g, ""), 10)) ? parseInt(mod.replace(/[^0-9]/g, ""), 10) : false;
                  dt_mod = new_mod ? dt_mod - new_mod : dt_mod;
                }
                else {
                  var new_mod = !isNaN(parseInt(mod.replace(/[^0-9]/g, ""), 10)) ? parseInt(mod.replace(/[^0-9]/g, ""), 10) : false;
                  dt_mod = new_mod ? dt_mod + new_mod : dt_mod;
                }
              };
            });
          }
          var final_dt = dt_base + armor_dt + dt_mod;
          final_dt = final_dt > 0 ? final_dt : 0;
          update["dt"] = final_dt;
          setAttrs(update, {silent: true});
        });
      });
    });
  };

  var update_speed = function() {
    console.log("UPDATING SPEED!");
    attrs_to_get = ["equippedarmorid", "agility_mod", "global_mods"];
    getAttrs(attrs_to_get, function(a){
      var equipped_armor_id = a["equippedarmorid"];
      attrs_to_get.push("repeating_armor_" + equipped_armor_id + "_type");
      getSectionIDs("repeating_spdmod", function(idArray){
        _.each(idArray, function(currentId, i) {
          attrs_to_get.push("repeating_spdmod_" + currentId + "_mod");
        });
        getAttrs(attrs_to_get, function(spd_attrs) {
          var update = {};
          var spd_base = 6;
          var spd_bonus =  Math.floor(parseInt(spd_attrs["agility_mod"], 10)/2);
          var armor_mod = 0;
          var spd_mod = 0;
          switch(spd_attrs["repeating_armor_" + equipped_armor_id + "_type"]) {
            case "heavy": armor_mod = -1; break;
            case "power": armor_mod = -2; break;
          }
          _.each(idArray, function(currentId, i) {
            if(spd_attrs["repeating_spdmod_" + currentId + "_mod"] && !isNaN(parseInt(spd_attrs["repeating_spdmod_" + currentId + "_mod"], 10))) {
              spd_mod += parseInt(spd_attrs["repeating_spdmod_" + currentId + "_mod"], 10);
            }
          });
          if(spd_attrs["global_mods"] && spd_attrs["global_mods"] != "") {
            var mods = spd_attrs["global_mods"].toLowerCase().split(",");
            _.each(mods, function(mod) {
              if(mod.indexOf("spd") > -1 || mod.indexOf("speed") > -1) {
                if(mod.indexOf(":") > -1) {
                  var new_base = !isNaN(parseInt(mod.replace(/[^0-9]/g, ""), 10)) ? parseInt(mod.replace(/[^0-9]/g, ""), 10) : false;
                  spd_base = new_base && new_base > spd_base ? new_base : spd_base;
                }
                else if(mod.indexOf("-") > -1) {
                  var new_mod = !isNaN(parseInt(mod.replace(/[^0-9]/g, ""), 10)) ? parseInt(mod.replace(/[^0-9]/g, ""), 10) : false;
                  spd_mod = new_mod ? spd_mod - new_mod : spd_mod;
                }
                else {
                  var new_mod = !isNaN(parseInt(mod.replace(/[^0-9]/g, ""), 10)) ? parseInt(mod.replace(/[^0-9]/g, ""), 10) : false;
                  spd_mod = new_mod ? spd_mod + new_mod : spd_mod;
                }
              };
            });
          }
          var final_spd = spd_base + spd_bonus + armor_mod + spd_mod;
          update["speed"] = final_spd;
          setAttrs(update, {silent: true});
        });
      });
    });
  };

  var update_initiative = function() {
    var attrs_to_get = ["agility","agility_mod","initmod","init_tiebreaker","pb_type","global_mods"];
    getAttrs(attrs_to_get, function(init_attrs) {
      var update = {};
      var final_init = parseInt(init_attrs["agility_mod"], 10);
      if(init_attrs["init_tiebreaker"] && init_attrs["init_tiebreaker"] != 0) {
        final_init = final_init + (parseInt(init_attrs["agility"], 10)/100);
      }
      if(init_attrs["global_mods"] && init_attrs["rglobal_mods"] != "") {
        var mods = init_attrs["global_mods"].toLowerCase().split(",");
        _.each(mods, function(mod) {
          if(mod.indexOf("init") > -1 || mod.indexOf("initative") > -1) {
            if(mod.indexOf("-") > -1) {
              var new_mod = !isNaN(parseInt(mod.replace(/[^0-9]/g, ""), 10)) ? parseInt(mod.replace(/[^0-9]/g, ""), 10) : false;
              final_init = new_mod ? final_init - new_mod : final_init;
            }
            else {
              var new_mod = !isNaN(parseInt(mod.replace(/[^0-9]/g, ""), 10)) ? parseInt(mod.replace(/[^0-9]/g, ""), 10) : false;
              final_init = new_mod ? final_init + new_mod : final_init;
            }
          }
        });
      }
      if(init_attrs["initmod"]) {
        const operator = init_attrs["initmod"].substring(0,1);
        const value    = init_attrs["initmod"].substring(1);
        if(["*","x","+","-"].indexOf(operator) > -1 && isNaN(parseFloat(value,10)) === false) {
          final_init =
            (operator === "*" || operator == "x") ? final_init * parseFloat(value,10) :
            (operator === "+") ? final_init + parseFloat(value,10) :
            (operator === "-") ? final_init - parseFloat(value,10) :
            final_init;
        }
      }
      if(final_init % 1 != 0) {
        final_init = parseFloat(final_init.toPrecision(12)); // ROUNDING ERROR BUGFIX
      }
      update["initiative_bonus"] = final_init;
      setAttrs(update, {silent: true});
    });
  };

  const set_level = function() {
    getAttrs(["base_level", "experience"], (attrs) => {
      let update        = {};
      let callbacks     = [];
      let exp           = (attrs[`experience`] && attrs[`experience`] >= 0) ? parseInt(attrs.experience,10) : 0;
      let final_level   = Math.floor(Math.sqrt(2*exp/1000));

      update["base_level"] = final_level;
      update["level"]      = final_level;

      callbacks.push(() => {update_pb();} );
      callbacks.push(() => {update_hp_max();} );
      setAttrs(update, {silent: true},() => {callbacks.forEach((callback) => {callback(); })} );
    });
  };

  var update_pb = function(source) {
    console.log("UPDATING TAG SKILL BONUS!")
    callbacks = [];
    getAttrs(["level","global_mods", "tag_skill_mod"], function(pb_attrs) {
      var update = {};
      var pb_base = 1;
      var pb_bonus = 0;
      var pb_mod_bonus = 0;
      if (pb_attrs["level"] && !isNaN(parseInt(pb_attrs["level"],10))) {
        var lvl = parseInt(pb_attrs["level"],10);
        pb_bonus = Math.floor(lvl/5);
      }
      if(pb_attrs["global_mods"] && pb_attrs["global_mods"] != "") {
        var mods = pb_attrs["global_mods"].toLowerCase().split(",");
        _.each(mods, function(mod) {
          if(mod.indexOf("tag") > -1) {
            if(mod.indexOf("-") > -1) {
              var new_pb_mod = !isNaN(parseInt(mod.replace(/[^0-9]/g, ""), 10)) ? parseInt(mod.replace(/[^0-9]/g, ""), 10) : false;
              pb_mod_bonus = new_pb_mod ? pb_mod_bonus - new_pb_mod : pb_mod_bonus;
            }
            else {
              var new_pb_mod = !isNaN(parseInt(mod.replace(/[^0-9]/g, ""), 10)) ? parseInt(mod.replace(/[^0-9]/g, ""), 10) : false;
              pb_mod_bonus = new_pb_mod ? pb_mod_bonus + new_pb_mod : pb_mod_bonus;
            }
          }
        });
      }
      if(pb_attrs["tag_skill_mod"] && !isNaN(parseInt(pb_attrs["tag_skill_mod"],10))) {
        pb_mod_bonus += parseInt(pb_attrs["tag_skill_mod"],10);
      }

      var final_pb = pb_base + pb_bonus + pb_mod_bonus;
      update["pb"] = final_pb;

      callbacks.push( function() {update_skills("all");} );
      callbacks.push( function() {update_all_saves();} );
      callbacks.push( function() {update_attacks("all");} );
      callbacks.push( function() {update_initiative();} );

      setAttrs(update, {silent: true}, function() {callbacks.forEach(function(callback) {callback(); })} );
    });
  };

  var update_passive_perception = function() {
    getAttrs(["pb_type","perception_mod","passive_perception_mod","perception_bonus"], function(attrs) {
      var pass_per_base = 10;
      var per_mod = !isNaN(parseInt(attrs["perception_mod"],10)) ? parseInt(attrs["perception_mod"],10) : 0;
      var final_pass_per = pass_per_base + per_mod;
      if(attrs["passive_perception_mod"]) {
        const operator = attrs["passive_perception_mod"].substring(0,1);
        const value    = attrs["passive_perception_mod"].substring(1);
        if(["*","x","+","-"].indexOf(operator) > -1 && isNaN(parseFloat(value,10)) === false) {
          final_pass_per =
            (operator === "*" || operator == "x") ? final_pass_per * parseFloat(value,10) :
            (operator === "+") ? final_pass_per + parseFloat(value,10) :
            (operator === "-") ? final_pass_per - parseFloat(value,10) :
            final_pass_per;
        }
      }
      final_pass_per = Math.floor(final_pass_per);
      setAttrs({passive_perception: final_pass_per})
    });
  };

  var update_critrange = function() {
    console.log("UPDATING CRITRANGE!");
    var attrs_to_get = [];
    getSectionIDs("repeating_critrangemod", function(idArray) {
      attrs_to_get.push("global_mods");
      _.each(idArray, function(currentId, i) {
        attrs_to_get.push("repeating_critrangemod_" + currentId + "_mod");
      });
      getAttrs(attrs_to_get, function(critrange_attrs) {
        var update = {};
        var callbacks = [];
        var critrange_base = 20;
        var critrange_bonus = 0;
        _.each(idArray, function(currentId, i) {
          if(critrange_attrs["repeating_critrangemod_" + currentId + "_mod"] && !isNaN(parseInt(critrange_attrs["repeating_critrangemod_" + currentId + "_mod"], 10))) {
            critrange_bonus += parseInt(critrange_attrs["repeating_critrangemod_" + currentId + "_mod"], 10);
          }
        });
        if(critrange_attrs["global_mods"] && critrange_attrs["global_mods"] != "") {
          var mods = critrange_attrs["global_mods"].toLowerCase().split(",");
          _.each(mods, function(mod) {
            if(mod.indexOf("crit") > -1 && (mod.indexOf("thresh") > -1 || mod.indexOf("range") > -1) && mod.indexOf("fail") === -1) {
              if(mod.indexOf(":") > -1) {
                var new_critrange_base = !isNaN(parseInt(mod.replace(/[^0-9]/g, ""), 10)) ? parseInt(mod.replace(/[^0-9]/g, ""), 10) : false;
                critrange_base = new_critrange_base && new_critrange_base < critrange_base ? new_critrange_base : critrange_base;
              }
              else if(mod.indexOf("-") > -1) {
                var new_critrange_mod = !isNaN(parseInt(mod.replace(/[^0-9]/g, ""), 10)) ? parseInt(mod.replace(/[^0-9]/g, ""), 10) : false;
                critrange_bonus = new_critrange_mod ? critrange_bonus - new_critrange_mod : critrange_bonus;
              } else {
                var new_critrange_mod = !isNaN(parseInt(mod.replace(/[^0-9]/g, ""), 10)) ? parseInt(mod.replace(/[^0-9]/g, ""), 10) : false;
                critrange_bonus = new_critrange_mod ? critrange_bonus + new_critrange_mod : critrange_bonus;
              }
            };
          });
        }
        var final_critrange = critrange_base + critrange_bonus;
        update["critrange"] = final_critrange;
        callbacks.push(() => {update_d20();});
        callbacks.push(() => {update_attacks("all");});
        setAttrs(update, {silent:true}, () => {callbacks.forEach((callback) => {callback();})});
      });
    });
  }

  var update_critfail = function() {
    console.log("UPDATING CRITFAIL!");
    attrs_to_get = [];
    getSectionIDs("repeating_critrangemod", function(idArray) {
      attrs_to_get.push("global_mods");
      _.each(idArray, function(currentId, i) {
        attrs_to_get.push("repeating_critrangemod_" + currentId + "_mod");
      });
      getAttrs(attrs_to_get, function(critfail_attrs) {
        var update = {};
        var callbacks = [];
        var critfail_base = 1;
        var critfail_bonus = 0;
        _.each(idArray, function(currentId, i) {
          if(critfail_attrs["repeating_critrangemod_" + currentId + "_mod"] && !isNaN(parseInt(critfail_attrs["repeating_critrangemod_" + currentId + "_mod"], 10))) {
            critfail_bonus += parseInt(critfail_attrs["repeating_critrangemod_" + currentId + "_mod"], 10);
          }
        });
        if(critfail_attrs["global_mods"] && critfail_attrs["global_mods"] != "") {
          var mods = critfail_attrs["global_mods"].toLowerCase().split(",");
          _.each(mods, function(mod) {
            if(mod.indexOf("crit" > -1) && mod.indexOf("fail") > -1) {
              if(mod.indexOf(":") > -1) {
                var new_critfail_base = !isNaN(parseInt(mod.replace(/[^0-9]/g, ""), 10)) ? parseInt(mod.replace(/[^0-9]/g, ""), 10) : false;
                critfail_base = new_critfail_base && new_critfail_base > critfail_base ? new_critfail_base : critfail_base;
              }
              else if(mod.indexOf("-") > -1) {
                var new_critfail_mod = !isNaN(parseInt(mod.replace(/[^0-9]/g, ""), 10)) ? parseInt(mod.replace(/[^0-9]/g, ""), 10) : false;
                critfail_bonus = new_critfail_mod ? critfail_bonus - new_critfail_mod : critfail_bonus;
              } else {
                var new_critfail_mod = !isNaN(parseInt(mod.replace(/[^0-9]/g, ""), 10)) ? parseInt(mod.replace(/[^0-9]/g, ""), 10) : false;
                critfail_bonus = new_critfail_mod ? critfail_bonus + new_critfail_mod : critfail_bonus;
              }
            };
          });
        }
        var final_critfail = critfail_base + critfail_bonus;
        update["critfail"] = final_critfail;
        callbacks.push(() => {update_d20();});
        setAttrs(update, {silent:true}, () => {callbacks.forEach((callback) => {callback();})});
      });
    });
  }

  var update_critical_strike = function() {
    getAttrs(["luck_mod","critical_strike_mod","luck_bonus","global_mods"], function(crit_attrs) {
      var crit_base = 10;
      var luk_mod = !isNaN(parseInt(crit_attrs["luck_mod"],10)) ? parseInt(crit_attrs["luck_mod"],10) : 0;
      var luk_bonus = !isNaN(parseInt(crit_attrs["luck_bonus"],10)) ? parseInt(crit_attrs["luck_bonus"],10) : 0;
      var crit_mod_bonus = 0;
      if(crit_attrs["global_mods"] && crit_attrs["global_mods"] != "") {
        var mods = crit_attrs["global_mods"].toLowerCase().split(",");
        _.each(mods, function(mod) {
          if(mod.indexOf("crit") > -1 && mod.indexOf("range") === -1 && mod.indexOf("thresh") === -1) {
            if(mod.indexOf(":") > -1) {
              var new_crit_base = !isNaN(parseInt(mod.replace(/[^0-9]/g, ""), 10)) ? parseInt(mod.replace(/[^0-9]/g, ""), 10) : false;
              crit_base = new_crit_base && new_crit_base > crit_base ? new_crit_base : crit_base;
            }
            else if(mod.indexOf("-") > -1) {
              var new_crit_mod = !isNaN(parseInt(mod.replace(/[^0-9]/g, ""), 10)) ? parseInt(mod.replace(/[^0-9]/g, ""), 10) : false;
              crit_mod_bonus = new_crit_mod ? crit_mod_bonus - new_crit_mod : crit_mod_bonus;
            }
            else {
              var new_crit_mod = !isNaN(parseInt(mod.replace(/[^0-9]/g, ""), 10)) ? parseInt(mod.replace(/[^0-9]/g, ""), 10) : false;
              crit_mod_bonus = new_crit_mod ? crit_mod_bonus + new_crit_mod : crit_mod_bonus;
            }
          };
        });
      }
      var final_crit = crit_base + luk_mod + luk_bonus + crit_mod_bonus;
      if (crit_attrs["critical_strike_mod"]) {
        const operator = crit_attrs["critical_strike_mod"].substring(0,1);
        const value    = crit_attrs["critical_strike_mod"].substring(1);
        if(["*","x","+","-"].indexOf(operator) > -1 && isNaN(parseFloat(value,10)) === false) {
          final_crit =
            (operator === "*" || operator == "x") ? final_crit * parseFloat(value,10) :
            (operator === "+") ? final_crit + parseFloat(value,10) :
            (operator === "-") ? final_crit - parseFloat(value,10) :
            final_crit;
        }
      }
      final_crit = Math.floor(final_crit);
      setAttrs({critical_strike: final_crit})
    });
  };

  var organize_section_proficiencies = function() {
    getSectionIDs("proficiencies", function(ids) {
      var attribs = ["_reporder_repeating_proficiencies"];
      _.each(ids, function(id) {
        attribs.push("repeating_proficiencies_" + id + "_prof_type");
        attribs.push("repeating_proficiencies_" + id + "_name");
      });

      getAttrs(attribs, function(v) {
        var final_array = _(ids).chain().sortBy(function(id) {
          return v["repeating_proficiencies_" + id + "_name"];
        }).sortBy(function(id) {
          return v["repeating_proficiencies_" + id + "_prof_type"];
        }).value();
        _.each(final_array, function(id) {
        });
        if(final_array && final_array.length > 0) {
          setSectionOrder("proficiencies", final_array);
        };
      });
    });
  };

  var update_challenge = function() {
    getAttrs(["npc_challenge"], function(v) {
      var update = {};
      var xp = 0;
      var pb = 0;
      switch(v.npc_challenge.toString()) {
        case "0":
          xp = "10";
          pb = 2;
          break;
        case "1/8":
          xp = "25";
          pb = 2;
          break;
        case "1/4":
          xp = "50";
          pb = 2;
          break;
        case "1/2":
          xp = "100";
          pb = 2;
          break;
        case "1":
          xp = "200";
          pb = 2;
          break;
        case "2":
          xp = "450";
          pb = 2;
          break;
        case "3":
          xp = "700";
          pb = 2;
          break;
        case "4":
          xp = "1100";
          pb = 2;
          break;
        case "5":
          xp = "1800";
          pb = 3;
          break;
        case "6":
          xp = "2300";
          pb = 3;
          break;
        case "7":
          xp = "2900";
          pb = 3;
          break;
        case "8":
          xp = "3900";
          pb = 3;
          break;
        case "9":
          xp = "5000";
          pb = 4;
          break;
        case "10":
          xp = "5900";
          pb = 4;
          break;
        case "11":
          xp = "7200";
          pb = 4;
          break;
        case "12":
          xp = "8400";
          pb = 4;
          break;
        case "13":
          xp = "10000";
          pb = 5;
          break;
        case "14":
          xp = "11500";
          pb = 5;
          break;
        case "15":
          xp = "13000";
          pb = 5;
          break;
        case "16":
          xp = "15000";
          pb = 5;
          break;
        case "17":
          xp = "18000";
          pb = 6;
          break;
        case "18":
          xp = "20000";
          pb = 6;
          break;
        case "19":
          xp = "22000";
          pb = 6;
          break;
        case "20":
          xp = "25000";
          pb = 6;
          break;
        case "21":
          xp = "33000";
          pb = 7;
          break;
        case "22":
          xp = "41000";
          pb = 7;
          break;
        case "23":
          xp = "50000";
          pb = 7;
          break;
        case "24":
          xp = "62000";
          pb = 7;
          break;
        case "25":
          xp = "75000";
          pb = 8;
          break;
        case "26":
          xp = "90000";
          pb = 8;
          break;
        case "27":
          xp = "105000";
          pb = 8;
          break;
        case "28":
          xp = "120000";
          pb = 8;
          break;
        case "29":
          xp = "";
          pb = 9;
          break;
        case "30":
          xp = "155000";
          pb = 9;
          break;
      }
      update["npc_xp"] = xp;
      update["pb_custom"] = pb;
      update["pb_type"] = "custom";
      setAttrs(update, {silent: true}, function() {update_pb()});
    });
  };

  const update_npc_saves = () => {
    const list = ["npc_str_save_base","npc_dex_save_base","npc_con_save_base","npc_int_save_base","npc_wis_save_base","npc_cha_save_base"];
    const type = "save";
    update_npc_lists(list, type);
  };

  const update_npc_skills = () => {
    const list = ["npc_acrobatics_base","npc_animal_handling_base","npc_arcana_base","npc_athletics_base","npc_deception_base","npc_history_base","npc_insight_base","npc_intimidation_base","npc_investigation_base","npc_medicine_base","npc_nature_base","npc_perception_base","npc_performance_base","npc_persuasion_base","npc_religion_base","npc_sleight_of_hand_base","npc_stealth_base","npc_survival_base"];
    const type = "skills";
    update_npc_lists(list, type);
  };

  const update_npc_lists = (list, type) => {
    getAttrs(list, function(v) {
      let update    = {};
      let last_save = 0;
      let npc_flag  = 0;

      _.each(list.reverse(), (base) => {
        const attr   = base.slice(4, -5); //Remove npc_ and _base
        let item     = parseInt(v[`${base}`], 10);

        // CSS will add comma :after 2 & 4 and +/- :before
        // 1 = Positive Number, 2 = Last Number, 3 = Negative Number, 4 = Last Negative Number
        if (v[`${base}`] && !isNaN(item) || v[`${base}`] === 0) {
          if (last_save === 0) {
            last_save = 1;
            item_flag = item < 0 ? 4 : 2;
          } else {
            item_flag = item < 0 ? 3 : 1;
          }
        } else {
          item_flag = 0;
          item      = "";
        };

        update[`npc_${attr}_flag`] = item_flag;
        update[`npc_${attr}`]      = item;

        npc_flag += item_flag;
      });

      const flagAttr = (type === "save") ? "saving" : type;
      update[`npc_${flagAttr}_flag`] = (npc_flag === 0) ? "" : npc_flag;

      setAttrs(update, {silent: true});
    });
  };

  var update_npc_action = function(update_id, legendary) {
    if(update_id.substring(0,1) === "-" && update_id.length === 20) {
      do_update_npc_action([update_id], legendary);
    }
    else if(update_id === "all") {
      var legendary_array = [];
      var actions_array = [];
      getSectionIDs("repeating_npcaction-l", function(idarray) {
        legendary_array = idarray;
        if(legendary_array.length > 0) {
          do_update_npc_action(legendary_array, true);
        }
        getSectionIDs("repeating_npcaction", function(idarray) {
          actions_array = idarray.filter(function(i) {return legendary_array.indexOf(i) < 0;});
          if(actions_array.length > 0) {
            do_update_npc_action(actions_array, false);
          };
        });
      });
    };
  };

  var do_update_npc_action = function(action_array, legendary) {
    var repvar = legendary ? "repeating_npcaction-l_" : "repeating_npcaction_";
    var action_attribs = ["dtype"];
    _.each(action_array, function(actionid) {
      action_attribs.push(repvar + actionid + "_attack_flag");
      action_attribs.push(repvar + actionid + "_attack_type");
      action_attribs.push(repvar + actionid + "_attack_range");
      action_attribs.push(repvar + actionid + "_attack_target");
      action_attribs.push(repvar + actionid + "_attack_tohit");
      action_attribs.push(repvar + actionid + "_attack_damage");
      action_attribs.push(repvar + actionid + "_attack_damagetype");
      action_attribs.push(repvar + actionid + "_attack_damage2");
      action_attribs.push(repvar + actionid + "_attack_damagetype2");
    });

    getAttrs(action_attribs, function(v) {
      _.each(action_array, function(actionid) {
        console.log("UPDATING NPC ACTION: " + actionid);
        var callbacks = [];
        var update = {};
        var onhit = "";
        var damage_flag = "";
        var range = "";
        var attack_flag = v[repvar + actionid + "_attack_flag"] && v[repvar + actionid + "_attack_flag"] != "0" ? "{{attack=1}}" : "";
        var tohit = v[repvar + actionid + "_attack_tohit"] && isNaN(parseInt(v[repvar + actionid + "_attack_tohit"], 10)) === false ? parseInt(v[repvar + actionid + "_attack_tohit"], 10) : 0;
        if(v[repvar + actionid + "_attack_type"] && v[repvar + actionid + "_attack_range"]) {
          if(v[repvar + actionid + "_attack_type"] === "Melee") {var rangetype = "Reach";} else {var rangetype = "Range";};
          range = ", " + rangetype + " " + v[repvar + actionid + "_attack_range"];
        }
        var target = v[repvar + actionid + "_attack_target"] && v[repvar + actionid + "_attack_target"] != "" ? ", " + v[repvar + actionid + "_attack_target"] : ""
        var attack_tohitrange = "+" + tohit + range + target;
        var dmg1 = v[repvar + actionid + "_attack_damage"] && v[repvar + actionid + "_attack_damage"] != "" ? v[repvar + actionid + "_attack_damage"] : "";
        var dmg1type = v[repvar + actionid + "_attack_damagetype"] && v[repvar + actionid + "_attack_damagetype"] != "" ? " " + v[repvar + actionid + "_attack_damagetype"] : "";
        var dmg2 = v[repvar + actionid + "_attack_damage2"] && v[repvar + actionid + "_attack_damage2"] != "" ? v[repvar + actionid + "_attack_damage2"] : "";
        var dmg2type = v[repvar + actionid + "_attack_damagetype2"] && v[repvar + actionid + "_attack_damagetype2"] != "" ? " " + v[repvar + actionid + "_attack_damagetype2"] : "";
        var dmgspacer = dmg1 != "" && dmg2 != "" ? " plus " : "";

        var parsed_dmg1 = parse_roll_string(dmg1);
        var parsed_dmg2 = parse_roll_string(dmg2);

        if(dmg1 != "") {
          onhit = onhit + parsed_dmg1.avg + " (" + dmg1 + ")" + dmg1type + " damage";
        };
        dmgspacer = dmg1 != "" && dmg2 != "" ? " plus " : "";
        onhit = onhit + dmgspacer;
        if(dmg2 != "") {
          onhit = onhit + parsed_dmg2.avg + " (" + dmg2 + ")" + dmg2type + " damage";
        };
        if(dmg1 != "" || dmg2 != "") {damage_flag = damage_flag + "{{damage=1}} "};
        if(dmg1 != "") {damage_flag = damage_flag + "{{dmg1flag=1}} "};
        if(dmg2 != "") {damage_flag = damage_flag + "{{dmg2flag=1}} "};

        var crit1 = "";
        if(parsed_dmg1.rolls.length > 0){
          parsed_dmg1.rolls.forEach(function(value) {
            crit1 += parsed_dmg1.array[value] + "+";
          });
          crit1 = crit1.substring(0, crit1.length - 1);
        }

        var crit2 = "";
        if(parsed_dmg2.rolls.length > 0){
          parsed_dmg2.rolls.forEach(function(value) {
            crit2 += parsed_dmg2.array[value] + "+";
          });
          crit2 = crit2.substring(0, crit2.length - 1);
        }

        var rollbase = "";
        if(v.dtype === "1") {
          rollbase = "@{wtype}&{template:npcaction} " + attack_flag + " @{damage_flag} @{npc_name_flag} {{rname=@{name}}} {{r1=[[@{d20}+(@{attack_tohit}+0)]]}} @{rtype}+(@{attack_tohit}+0)]]}} {{dmg1=[[@{attack_damage}+0]]}} {{dmg1type=@{attack_damagetype}}} {{dmg2=[[@{attack_damage2}+0]]}} {{dmg2type=@{attack_damagetype2}}} {{crit1=[[@{attack_crit}+0]]}} {{crit2=[[@{attack_crit2}+0]]}} {{description=@{show_desc}}} @{charname_output}";
        }
        else if(v[repvar + actionid + "_attack_flag"] && v[repvar + actionid + "_attack_flag"] != "0") {
          if(legendary) {
            rollbase = "@{wtype}&{template:npcatk} " + attack_flag + " @{damage_flag} @{npc_name_flag} {{rname=[@{name}](~repeating_npcaction-l_npc_dmg)}} {{rnamec=[@{name}](~repeating_npcaction-l_npc_crit)}} {{type=[Attack](~repeating_npcaction-l_npc_dmg)}} {{typec=[Attack](~repeating_npcaction-l_npc_crit)}} {{r1=[[@{d20}+(@{attack_tohit}+0)]]}} @{rtype}+(@{attack_tohit}+0)]]}} {{description=@{show_desc}}} @{charname_output}"
          }
          else {
            rollbase = "@{wtype}&{template:npcatk} " + attack_flag + " @{damage_flag} @{npc_name_flag} {{rname=[@{name}](~repeating_npcaction_npc_dmg)}} {{rnamec=[@{name}](~repeating_npcaction_npc_crit)}} {{type=[Attack](~repeating_npcaction_npc_dmg)}} {{typec=[Attack](~repeating_npcaction_npc_crit)}} {{r1=[[@{d20}+(@{attack_tohit}+0)]]}} @{rtype}+(@{attack_tohit}+0)]]}} {{description=@{show_desc}}} @{charname_output}";
          }
        }
        else if(dmg1 || dmg2) {
          rollbase = "@{wtype}&{template:npcdmg} @{damage_flag} {{dmg1=[[@{attack_damage}+0]]}} {{dmg1type=@{attack_damagetype}}} {{dmg2=[[@{attack_damage2}+0]]}} {{dmg2type=@{attack_damagetype2}}} {{crit1=[[@{attack_crit}+0]]}} {{crit2=[[@{attack_crit2}+0]]}} @{charname_output}"
        }
        else {
          rollbase = "@{wtype}&{template:npcaction} @{npc_name_flag} {{rname=@{name}}} {{description=@{show_desc}}} @{charname_output}"
        }

        update[repvar + actionid + "_attack_tohitrange"] = attack_tohitrange;
        update[repvar + actionid + "_attack_onhit"] = onhit;
        update[repvar + actionid + "_damage_flag"] = damage_flag;
        update[repvar + actionid + "_attack_crit"] = crit1;
        update[repvar + actionid + "_attack_crit2"] = crit2;
        update[repvar + actionid + "_rollbase"] = rollbase;
        setAttrs(update, {silent: true});
      });
    });
  };

  var parse_roll_string = function(rollstring) {
    var out = {array: [], avg: 0, rolls: []};

    if(!rollstring || rollstring === "") {
      return out;
    }

    var rs_regex_initial = /(\-?\d+(?:d\d+)?)/ig;
    var rs_regex_repeating = /([\+\-])(\-?\d+(?:d\d+)?)/ig;
    var rs_nospace = rollstring.replace(/\s/g, '');
    var rs_initial = rs_regex_initial.exec(rs_nospace);

    if(rs_initial) {
      out.array.push(rs_initial[1]);
      rs_regex_repeating.lastIndex = rs_regex_initial.lastIndex;
      var rs_repeating;
      while(rs_repeating = rs_regex_repeating.exec(rs_nospace)) {
        out.array.push(rs_repeating[1], rs_repeating[2]);
      }
    }

    var add = true;
    var dice_regex = /(\d+)d(\d+)/i;
    var dice;

    out.array.forEach(function(value, index, array) {
      if(value === "+") {
        add = true;
      } else if(value === "-") {
        add = false;
      } else if(dice = dice_regex.exec(value)){
        // this value is a die roll
        var dice_avg = Math.floor(+dice[1] * (+dice[2] / 2 + 0.5));
        out.avg += add ? dice_avg : -dice_avg;
        out.rolls.push(index);
      } else {
        // this value is a number
        out.avg += add ? +value : -+value;
      }
    })

    return out;
  };

  var update_globaldamage = function(callback) {
    getSectionIDs("damagemod", function(ids) {
      if(ids) {
        var fields = {};
        var attr_name_list = [];
        ids.forEach(function(id) {
          fields[id] = {};
          attr_name_list.push(`repeating_damagemod_${id}_global_damage_active_flag`, `repeating_damagemod_${id}_global_damage_name`, `repeating_damagemod_${id}_global_damage_damage`, `repeating_damagemod_${id}_global_damage_type`);
        });

        getAttrs(attr_name_list, function(attrs) {
          var regex = /^repeating_damagemod_(.+)_global_damage_(active_flag|name|damage|type)$/;
          _.each(attrs, function(obj, name) {
            var r = regex.exec(name);
            if(r) {
              fields[r[1]][r[2]] = obj;
            };
          });

          var update = {global_damage_mod_roll: "", global_damage_mod_crit: "", global_damage_mod_type: ""};

          _.each(fields, function(element) {
            if(element.active_flag != "0") {
              if(element.name && element.name !== "") { update["global_damage_mod_roll"] += element.damage + '[' + element.name + ']' + "+"; }
              if(element.type && element.type !== "") { update["global_damage_mod_type"] += element.type + "/"; }
            }
          });

          update["global_damage_mod_roll"] = update["global_damage_mod_roll"].replace(/\+(?=$)/, '');
          update["global_damage_mod_type"] = update["global_damage_mod_type"].replace(/\/(?=$)/, '');

          // Remove any non-roll damage modifiers from the global damage modifier for the crit rolls
          // Will also remove any labels attached to these non-roll damage modifiers
          // If what was just replace removed the first damage modifier, remove any now precending plus signs
          update["global_damage_mod_crit"] = update["global_damage_mod_roll"].replace(/(?:[+\-*\/%]|\*\*|^)\s*\d+(?:\[.*?])?(?!d\d+)/gi, '').replace(/(?:^\+)/i, '');

          setAttrs(update, {silent:true}, function() {
            update_attacks("all");
            if(typeof callback == "function") callback();
          });
        });
      }
    });
  };

  var update_globalattack = function(callback) {
    console.log("UPDATING GLOBAL ATTACK");
    var attrs_to_get = [];
    getSectionIDs("tohitmod", function(idArray) {
      _.each(idArray, function(id) {
        attrs_to_get.push(`repeating_tohitmod_${id}_global_attack_active_flag`);
        attrs_to_get.push(`repeating_tohitmod_${id}_global_atkname`);
        attrs_to_get.push(`repeating_tohitmod_${id}_global_atkbonus`);
        attrs_to_get.push(`repeating_tohitmod_${id}_global_dmgbonus`);
        attrs_to_get.push(`repeating_tohitmod_${id}_global_dmgtype`);
      });
      getAttrs(attrs_to_get, function(attrs){
        var update = {};
        var global_attack_mod = "";
        var global_damage_mod_roll = "0";
        var global_damage_mod_type = "0";
        _.each(idArray, function(id) {
          var global_atkbonus = "";
          var global_dmgbonus = "";
          var global_dmgtype = "";
          var global_atkdmgtype = "";
          if(attrs[`repeating_tohitmod_${id}_global_atkbonus`] && attrs[`repeating_tohitmod_${id}_global_atkbonus`] != "") {
            if(attrs[`repeating_tohitmod_${id}_global_atkbonus`].indexOf("-") > -1) {
              global_atkbonus = attrs[`repeating_tohitmod_${id}_global_atkbonus`];
            } else {
              global_atkbonus = "+" + attrs[`repeating_tohitmod_${id}_global_atkbonus`];
            }
          }
          update[`repeating_tohitmod_${id}_global_atkbonus_display`] = global_atkbonus;
          if (attrs[`repeating_tohitmod_${id}_global_attack_active_flag`] && attrs[`repeating_tohitmod_${id}_global_attack_active_flag`] === "1"
          && attrs[`repeating_tohitmod_${id}_global_atkbonus`] && attrs[`repeating_tohitmod_${id}_global_atkbonus`] != "") {
            global_attack_mod = (global_attack_mod === "")
              ? attrs[`repeating_tohitmod_${id}_global_atkbonus`]
              : global_attack_mod + "+" + attrs[`repeating_tohitmod_${id}_global_atkbonus`];
          }

          if(attrs[`repeating_tohitmod_${id}_global_dmgbonus`] && attrs[`repeating_tohitmod_${id}_global_dmgbonus`] != "") {
            global_dmgbonus = attrs[`repeating_tohitmod_${id}_global_dmgbonus`];
            if (attrs[`repeating_tohitmod_${id}_global_dmgtype`] && attrs[`repeating_tohitmod_${id}_global_dmgtype`] != "") {
              global_dmgtype = attrs[`repeating_tohitmod_${id}_global_dmgtype`];
            }
          }
          update[`repeating_tohitmod_${id}_global_atkdmgtype`] = (global_dmgbonus != "") ? global_dmgbonus + " " + global_dmgtype : "";
          if (attrs[`repeating_tohitmod_${id}_global_attack_active_flag`] && attrs[`repeating_tohitmod_${id}_global_attack_active_flag`] === "1"
          && attrs[`repeating_tohitmod_${id}_global_dmgbonus`] && attrs[`repeating_tohitmod_${id}_global_dmgbonus`] != "") {
            global_damage_mod_roll = (global_damage_mod_roll === "0")
              ? attrs[`repeating_tohitmod_${id}_global_dmgbonus`] + '[' + attrs[`repeating_tohitmod_${id}_global_atkname`] + ']'
              : global_damage_mod_roll + "+" + attrs[`repeating_tohitmod_${id}_global_dmgbonus`] + '[' + attrs[`repeating_tohitmod_${id}_global_atkname`] + ']';
          }
          if (attrs[`repeating_tohitmod_${id}_global_attack_active_flag`] && attrs[`repeating_tohitmod_${id}_global_attack_active_flag`] === "1"
          && attrs[`repeating_tohitmod_${id}_global_dmgtype`] && attrs[`repeating_tohitmod_${id}_global_dmgtype`] != "") {
            global_damage_mod_type = (global_damage_mod_type === "0")
              ? attrs[`repeating_tohitmod_${id}_global_dmgtype`]
              : global_damage_mod_type + "/" + attrs[`repeating_tohitmod_${id}_global_dmgtype`];
          }
        });
        update["global_attack_mod"] = (global_attack_mod === "") ? "" : `[[${global_attack_mod}]]`;
        update["global_damage_mod_roll"] = global_damage_mod_roll;
        update["global_damage_mod_crit"] = global_damage_mod_roll;
        update["global_damage_mod_type"] = global_damage_mod_type;
        setAttrs(update, {silent:true}, () => {update_attacks("all");});
      });
    });
  };

  var update_globalsaves = function(callback) {
    getSectionIDs("savemod", function(ids) {
      if(ids) {
        var fields = {};
        var attr_name_list = [];
        ids.forEach(function(id) {
          fields[id] = {};
          attr_name_list.push(`repeating_savemod_${id}_global_save_active_flag`, `repeating_savemod_${id}_global_save_roll`, `repeating_savemod_${id}_global_save_name`);
        });
        getAttrs(attr_name_list, function(attrs) {
          var regex = /^repeating_savemod_(.+)_global_save_(active_flag|roll|name)$/;
          _.each(attrs, function(obj, name) {
            var r = regex.exec(name);
            if(r) {
              fields[r[1]][r[2]] = obj;
            }
          });

          var update = {global_save_mod: ""};
          _.each(fields, function(element) {
            if(element.active_flag != "0") {
              if(element.roll && element.roll !== "") { update["global_save_mod"] += element.roll + "[" + element.name + "]" + "+"; }
            }
          });
          if(update["global_save_mod"] !== "") {
            update["global_save_mod"] = "[[" + update["global_save_mod"].replace(/\+(?=$)/, '') + "]]";
          }
          setAttrs(update, {silent:true}, function() {
            if(typeof callback == "function") callback();
          });
        });
      }
    });
  };

  var update_globalskills = function(callback) {
    getSectionIDs("skillmod", function(ids) {
      if(ids) {
        var fields = {};
        var attr_name_list = [];
        ids.forEach(function(id) {
          fields[id] = {};
          attr_name_list.push(`repeating_skillmod_${id}_global_skill_active_flag`, `repeating_skillmod_${id}_global_skill_roll`, `repeating_skillmod_${id}_global_skill_name`);
        });
        getAttrs(attr_name_list, function(attrs) {
          var regex = /^repeating_skillmod_(.+)_global_skill_(active_flag|roll|name)$/;
          _.each(attrs, function(obj, name) {
            var r = regex.exec(name);
            if(r) {
              fields[r[1]][r[2]] = obj;
            }
          });

          var update = {global_skill_mod: ""};
          _.each(fields, function(element) {
            if(element.active_flag != "0") {
              if(element.roll && element.roll !== "") { update["global_skill_mod"] += element.roll + "[" + element.name + "]" + "+"; }
            }
          });
          if(update["global_skill_mod"] !== "") {
            update["global_skill_mod"] = "[[" + update["global_skill_mod"].replace(/\+(?=$)/, '') + "]]";
          }
          setAttrs(update, {silent:true}, function() {
            if(typeof callback == "function") callback();
          });
        });
      }
    });
  };

  var check_l1_mancer = function() {
    getAttrs(["class", "base_level", "strength_base","dexterity_base","constitution_base","intelligence_base","wisdom_base","charisma_base","l1mancer_status","version","charactermancer_step"], function(v) {
      if(!v["version"] || parseFloat(v["version"]) < 2.2) {
        return;
      }
      if(v["l1mancer_status"] && v["l1mancer_status"] === "completed") {
        return;
      }

      if(v["charactermancer_step"] && v["charactermancer_step"].split("-")[0] == "l1") {
        startCharactermancer(v["charactermancer_step"]);
      }
      else {
        if(v["l1mancer_status"] && v["l1mancer_status"] === "relaunch") {
          startCharactermancer("l1-welcome");
        } else {
          setAttrs({mancer_confirm_flag: 1});
        }
      }
    });
  };

  var check_lp_mancer = function() {
    getAttrs(["class", "base_level", "strength_base","dexterity_base","constitution_base","intelligence_base","wisdom_base","charisma_base","l1mancer_status", "lpmancer_status","version","charactermancer_step"], function(v) {
      if(v["lpmancer_status"] === "active" && v["charactermancer_step"] && v["charactermancer_step"].split("-")[0] == "lp") {
        startCharactermancer(v["charactermancer_step"]);
      }
    });
  };

  var clear_npc_spell_attacks = function(complete) {
    getSectionIDs("repeating_attack", function(attack_ids) {
      var getList = [];
      var done = false;
      _.each(attack_ids, function(id) {
        getList.push(`repeating_attack_${id}_spellid`);
      });
      getAttrs(getList, function(v) {
        _.each(attack_ids, function(id) {
          if (v[`repeating_attack_${id}_spellid`] && v[`repeating_attack_${id}_spellid`].indexOf("npc_") != -1) {
            removeRepeatingRow(`repeating_attack_${id}`);
          }
        });
        complete();
      });
    });
  };

  var versioning = function(finished) {
    getAttrs(["version"], function(v) {
      if(v["version"] === "2.7") {
        setAttrs({version: "2.7"}, function(){
          finished();
        });
        console.log("5th Edition OGL by Roll20 v" + v["version"]);
        return;
      }
      else if(!v["version"] || v["version"] === "") {
        console.log("NO VERSION FOUND");
        no_version_bugfix(function() {
          versioning(finished);
        });
      }
      else if(v["version"] === "2.6") {
        console.log("UPGRADING TO v2.7");
        upgrade_to_2_7(function() {
          setAttrs({version: "2.7"}, function() {
            versioning(finished);
          });
        });
      }
      else if(v["version"] === "2.5") {
        console.log("UPGRADING TO v2.6");
        upgrade_to_2_6(function() {
          setAttrs({version: "2.6"}, function() {
            versioning(finished);
          });
        });
      }
      else if(v["version"] === "2.4") {
        console.log("UPGRADING TO v2.5");
        upgrade_to_2_5(function() {
          setAttrs({version: "2.5"}, function() {
            versioning(finished);
          });
        });
      }
      else if(v["version"] === "2.3") {
        console.log("UPGRADING TO v2.4");
        upgrade_to_2_4(function() {
          setAttrs({version: "2.4"}, function() {
            versioning(finished);
          });
        });
      }
      else if(v["version"] === "2.2") {
        console.log("UPGRADING TO v2.3");
        upgrade_to_2_3(function() {
          setAttrs({version: "2.3"}, function() {
            versioning(finished);
          });
        });
      }
      else if(v["version"] === "2.1") {
        console.log("UPGRADING TO v2.2");
        upgrade_to_2_2(function() {
          setAttrs({version: "2.2"}, function() {
            versioning(finished);
          });
        });
      }
      else if(v["version"] === "2.0") {
        console.log("UPGRADING TO v2.1");
        upgrade_to_2_1(function() {
          setAttrs({version: "2.1"}, function() {
            versioning(finished);
          });
        });
      }
      else {
        console.log("UPGRADING TO v2.0");
        upgrade_to_2_0(function() {
          setAttrs({version: "2.0"}, function() {
            versioning(finished);
          });
        });
      };
    });
  };

</script>
